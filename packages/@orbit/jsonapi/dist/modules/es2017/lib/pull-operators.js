"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var utils_1 = require("@orbit/utils");
var data_1 = require("@orbit/data");
var request_settings_1 = require("./request-settings");
function deserialize(source, document) {
    var deserialized = source.serializer.deserializeDocument(document);
    var records = utils_1.toArray(deserialized.data);
    if (deserialized.included) {
        Array.prototype.push.apply(records, deserialized.included);
    }
    var operations = records.map(function (record) {
        return {
            op: 'replaceRecord',
            record: record
        };
    });
    return [data_1.buildTransform(operations)];
}
exports.PullOperators = {
    findRecord: function (source, query) {
        var expression = query.expression;
        var record = expression.record;
        var requestOptions = customRequestOptions(source, query);
        var settings = request_settings_1.buildFetchSettings(requestOptions);
        return source.fetch(source.resourceURL(record.type, record.id), settings)
            .then(function (data) { return deserialize(source, data); });
    },
    findRecords: function (source, query) {
        var expression = query.expression;
        var type = expression.type;
        var requestOptions = {};
        if (expression.filter) {
            requestOptions.filter = buildFilterParam(source, expression.filter);
        }
        if (expression.sort) {
            requestOptions.sort = buildSortParam(source, expression.sort);
        }
        if (expression.page) {
            requestOptions.page = expression.page;
        }
        requestOptions = utils_1.merge(requestOptions, customRequestOptions(source, query));
        var settings = request_settings_1.buildFetchSettings(requestOptions);
        return source.fetch(source.resourceURL(type), settings)
            .then(function (data) { return deserialize(source, data); });
    },
    findRelatedRecord: function (source, query) {
        var expression = query.expression;
        var record = expression.record, relationship = expression.relationship;
        var requestOptions = customRequestOptions(source, query);
        var settings = request_settings_1.buildFetchSettings(requestOptions);
        return source.fetch(source.relatedResourceURL(record.type, record.id, relationship), settings)
            .then(function (data) { return deserialize(source, data); });
    },
    findRelatedRecords: function (source, query) {
        var expression = query.expression;
        var record = expression.record, relationship = expression.relationship;
        var requestOptions = customRequestOptions(source, query);
        var settings = request_settings_1.buildFetchSettings(requestOptions);
        return source.fetch(source.relatedResourceURL(record.type, record.id, relationship), settings)
            .then(function (data) { return deserialize(source, data); });
    }
};
function customRequestOptions(source, query) {
    var requestOptions = {};
    var queryOptions = utils_1.deepGet(query, ['options', 'sources', source.name]) || {};
    if (queryOptions.include) {
        requestOptions.include = queryOptions.include.join(',');
    }
    if (queryOptions.timeout) {
        requestOptions.timeout = queryOptions.timeout;
    }
    return requestOptions;
}
function buildFilterParam(source, filterSpecifiers) {
    var filters = {};
    filterSpecifiers.forEach(function (filterSpecifier) {
        if (filterSpecifier.kind === 'attribute' && filterSpecifier.op === 'equal') {
            var attributeFilter = filterSpecifier;
            // Note: We don't know the `type` of the attribute here, so passing `null`
            var resourceAttribute = source.serializer.resourceAttribute(null, attributeFilter.attribute);
            filters[resourceAttribute] = attributeFilter.value;
        }
        else {
            throw new data_1.QueryExpressionParseError('Filter operation ${specifier.op} not recognized for JSONAPISource.', filterSpecifier);
        }
    });
    return filters;
}
function buildSortParam(source, sortSpecifiers) {
    return sortSpecifiers.map(function (sortSpecifier) {
        if (sortSpecifier.kind === 'attribute') {
            var attributeSort = sortSpecifier;
            // Note: We don't know the `type` of the attribute here, so passing `null`
            var resourceAttribute = source.serializer.resourceAttribute(null, attributeSort.attribute);
            return (sortSpecifier.order === 'descending' ? '-' : '') + resourceAttribute;
        }
        throw new data_1.QueryExpressionParseError('Sort specifier ${sortSpecifier.kind} not recognized for JSONAPISource.', sortSpecifier);
    }).join(',');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHVsbC1vcGVyYXRvcnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbGliL3B1bGwtb3BlcmF0b3JzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQTZEO0FBQzdELG9DQWNxQjtBQUlyQix1REFBd0U7QUFFeEUscUJBQXFCLE1BQXFCLEVBQUUsUUFBeUI7SUFDbkUsSUFBTSxZQUFZLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNyRSxJQUFNLE9BQU8sR0FBRyxlQUFPLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRTNDLEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQzFCLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFFRCxJQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQUEsTUFBTTtRQUNuQyxNQUFNLENBQUM7WUFDTCxFQUFFLEVBQUUsZUFBZTtZQUNuQixNQUFNLFFBQUE7U0FDUCxDQUFDO0lBQ0osQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLENBQUMsQ0FBQyxxQkFBYyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7QUFDdEMsQ0FBQztBQU1ZLFFBQUEsYUFBYSxHQUF1QjtJQUMvQyxVQUFVLFlBQUMsTUFBcUIsRUFBRSxLQUFZO1FBQzVDLElBQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxVQUF3QixDQUFDO1FBQzFDLElBQUEsMEJBQU0sQ0FBZ0I7UUFFOUIsSUFBTSxjQUFjLEdBQUcsb0JBQW9CLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzNELElBQU0sUUFBUSxHQUFHLHFDQUFrQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBRXBELE1BQU0sQ0FBQyxNQUFNLENB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QUNyRCxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixNQUFNLElBQUksZ0NBQXlCLENBQUMsb0VBQW9FLEVBQUUsZUFBZSxDQUFDLENBQUM7UUFDN0gsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0lBRUgsTUFBTSxDQUFDLE9BQU8sQ0FBQztBQUNqQixDQUFDO0FBRUQsd0JBQXdCLE1BQXFCLEVBQUUsY0FBK0I7SUFDNUUsTUFBTSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsVUFBQSxhQUFhO1FBQ3JDLEVBQUUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxJQUFJLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQztZQUN2QyxJQUFNLGFBQWEsR0FBRyxhQUF1QyxDQUFDO1lBRTlELDBFQUEwRTtZQUMxRSxJQUFNLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsaUJBQWlCLENBQUMsSUFBSSxFQUFFLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUM3RixNQUFNLENBQUMsQ0FBQyxhQUFhLENBQUMsS0FBSyxLQUFLLFlBQVksR0FBRyxHQUFHLEdBQUcsRUFBRSxDQUFDLEdBQUcsaUJBQWlCLENBQUM7UUFDL0UsQ0FBQztRQUNELE1BQU0sSUFBSSxnQ0FBeUIsQ0FBQyx3RUFBd0UsRUFBRSxhQUFhLENBQUMsQ0FBQztJQUMvSCxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDZixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGljdCwgdG9BcnJheSwgbWVyZ2UsIGRlZXBHZXQgfSBmcm9tICdAb3JiaXQvdXRpbHMnO1xyXG5pbXBvcnQge1xyXG4gIFF1ZXJ5LFxyXG4gIFF1ZXJ5RXhwcmVzc2lvbixcclxuICBRdWVyeUV4cHJlc3Npb25QYXJzZUVycm9yLFxyXG4gIFRyYW5zZm9ybSxcclxuICBGaW5kUmVjb3JkLFxyXG4gIEZpbmRSZWNvcmRzLFxyXG4gIEZpbmRSZWxhdGVkUmVjb3JkLFxyXG4gIEZpbmRSZWxhdGVkUmVjb3JkcyxcclxuICBGaWx0ZXJTcGVjaWZpZXIsXHJcbiAgU29ydFNwZWNpZmllcixcclxuICBBdHRyaWJ1dGVGaWx0ZXJTcGVjaWZpZXIsXHJcbiAgQXR0cmlidXRlU29ydFNwZWNpZmllcixcclxuICBidWlsZFRyYW5zZm9ybVxyXG59IGZyb20gJ0BvcmJpdC9kYXRhJztcclxuaW1wb3J0IEpTT05BUElTb3VyY2UgZnJvbSAnLi4vanNvbmFwaS1zb3VyY2UnO1xyXG5pbXBvcnQgeyBEZXNlcmlhbGl6ZWREb2N1bWVudCB9IGZyb20gJy4uL2pzb25hcGktc2VyaWFsaXplcic7XHJcbmltcG9ydCB7IEpTT05BUElEb2N1bWVudCB9IGZyb20gJy4uL2pzb25hcGktZG9jdW1lbnQnO1xyXG5pbXBvcnQgeyBSZXF1ZXN0T3B0aW9ucywgYnVpbGRGZXRjaFNldHRpbmdzIH0gZnJvbSAnLi9yZXF1ZXN0LXNldHRpbmdzJztcclxuXHJcbmZ1bmN0aW9uIGRlc2VyaWFsaXplKHNvdXJjZTogSlNPTkFQSVNvdXJjZSwgZG9jdW1lbnQ6IEpTT05BUElEb2N1bWVudCk6IFRyYW5zZm9ybVtdIHtcclxuICBjb25zdCBkZXNlcmlhbGl6ZWQgPSBzb3VyY2Uuc2VyaWFsaXplci5kZXNlcmlhbGl6ZURvY3VtZW50KGRvY3VtZW50KTtcclxuICBjb25zdCByZWNvcmRzID0gdG9BcnJheShkZXNlcmlhbGl6ZWQuZGF0YSk7XHJcblxyXG4gIGlmIChkZXNlcmlhbGl6ZWQuaW5jbHVkZWQpIHtcclxuICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KHJlY29yZHMsIGRlc2VyaWFsaXplZC5pbmNsdWRlZCk7XHJcbiAgfVxyXG5cclxuICBjb25zdCBvcGVyYXRpb25zID0gcmVjb3Jkcy5tYXAocmVjb3JkID0+IHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIG9wOiAncmVwbGFjZVJlY29yZCcsXHJcbiAgICAgIHJlY29yZFxyXG4gICAgfTtcclxuICB9KTtcclxuXHJcbiAgcmV0dXJuIFtidWlsZFRyYW5zZm9ybShvcGVyYXRpb25zKV07XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUHVsbE9wZXJhdG9yIHtcclxuICAoc291cmNlOiBKU09OQVBJU291cmNlLCBxdWVyeTogUXVlcnkpOiBhbnk7XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBQdWxsT3BlcmF0b3JzOiBEaWN0PFB1bGxPcGVyYXRvcj4gPSB7XHJcbiAgZmluZFJlY29yZChzb3VyY2U6IEpTT05BUElTb3VyY2UsIHF1ZXJ5OiBRdWVyeSkge1xyXG4gICAgY29uc3QgZXhwcmVzc2lvbiA9IHF1ZXJ5LmV4cHJlc3Npb24gYXMgRmluZFJlY29yZDtcclxuICAgIGNvbnN0IHsgcmVjb3JkIH0gPSBleHByZXNzaW9uO1xyXG5cclxuICAgIGNvbnN0IHJlcXVlc3RPcHRpb25zID0gY3VzdG9tUmVxdWVzdE9wdGlvbnMoc291cmNlLCBxdWVyeSk7XHJcbiAgICBjb25zdCBzZXR0aW5ncyA9IGJ1aWxkRmV0Y2hTZXR0aW5ncyhyZXF1ZXN0T3B0aW9ucyk7XHJcblxyXG4gICAgcmV0dXJuIHNvdXJjZS5mZXRjaChzb3VyY2UucmVzb3VyY2VVUkwocmVjb3JkLnR5cGUsIHJlY29yZC5pZCksIHNldHRpbmdzKVxyXG4gICAgICAudGhlbihkYXRhID0+IGRlc2VyaWFsaXplKHNvdXJjZSwgZGF0YSkpO1xyXG4gIH0sXHJcblxyXG4gIGZpbmRSZWNvcmRzKHNvdXJjZTogSlNPTkFQSVNvdXJjZSwgcXVlcnk6IFF1ZXJ5KSB7XHJcbiAgICBjb25zdCBleHByZXNzaW9uID0gcXVlcnkuZXhwcmVzc2lvbiBhcyBGaW5kUmVjb3JkcztcclxuICAgIGNvbnN0IHsgdHlwZSB9ID0gZXhwcmVzc2lvbjtcclxuXHJcbiAgICBsZXQgcmVxdWVzdE9wdGlvbnM6IFJlcXVlc3RPcHRpb25zID0ge307XHJcblxyXG4gICAgaWYgKGV4cHJlc3Npb24uZmlsdGVyKSB7XHJcbiAgICAgIHJlcXVlc3RPcHRpb25zLmZpbHRlciA9IGJ1aWxkRmlsdGVyUGFyYW0oc291cmNlLCBleHByZXNzaW9uLmZpbHRlcik7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGV4cHJlc3Npb24uc29ydCkge1xyXG4gICAgICByZXF1ZXN0T3B0aW9ucy5zb3J0ID0gYnVpbGRTb3J0UGFyYW0oc291cmNlLCBleHByZXNzaW9uLnNvcnQpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChleHByZXNzaW9uLnBhZ2UpIHtcclxuICAgICAgcmVxdWVzdE9wdGlvbnMucGFnZSA9IGV4cHJlc3Npb24ucGFnZTtcclxuICAgIH1cclxuXHJcbiAgICByZXF1ZXN0T3B0aW9ucyA9IG1lcmdlKFxyXG4gICAgICByZXF1ZXN0T3B0aW9ucyxcclxuICAgICAgY3VzdG9tUmVxdWVzdE9wdGlvbnMoc291cmNlLCBxdWVyeSkpO1xyXG5cclxuICAgIGNvbnN0IHNldHRpbmdzID0gYnVpbGRGZXRjaFNldHRpbmdzKHJlcXVlc3RPcHRpb25zKTtcclxuXHJcbiAgICByZXR1cm4gc291cmNlLmZldGNoKHNvdXJjZS5yZXNvdXJjZVVSTCh0eXBlKSwgc2V0dGluZ3MpXHJcbiAgICAgIC50aGVuKGRhdGEgPT4gZGVzZXJpYWxpemUoc291cmNlLCBkYXRhKSk7XHJcbiAgfSxcclxuXHJcbiAgZmluZFJlbGF0ZWRSZWNvcmQoc291cmNlOiBKU09OQVBJU291cmNlLCBxdWVyeTogUXVlcnkpIHtcclxuICAgIGNvbnN0IGV4cHJlc3Npb24gPSBxdWVyeS5leHByZXNzaW9uIGFzIEZpbmRSZWxhdGVkUmVjb3JkO1xyXG4gICAgY29uc3QgeyByZWNvcmQsIHJlbGF0aW9uc2hpcCB9ID0gZXhwcmVzc2lvbjtcclxuXHJcbiAgICBjb25zdCByZXF1ZXN0T3B0aW9ucyA9IGN1c3RvbVJlcXVlc3RPcHRpb25zKHNvdXJjZSwgcXVlcnkpO1xyXG4gICAgY29uc3Qgc2V0dGluZ3MgPSBidWlsZEZldGNoU2V0dGluZ3MocmVxdWVzdE9wdGlvbnMpO1xyXG5cclxuICAgIHJldHVybiBzb3VyY2UuZmV0Y2goc291cmNlLnJlbGF0ZWRSZXNvdXJjZVVSTChyZWNvcmQudHlwZSwgcmVjb3JkLmlkLCByZWxhdGlvbnNoaXApLCBzZXR0aW5ncylcclxuICAgICAgLnRoZW4oZGF0YSA9PiBkZXNlcmlhbGl6ZShzb3VyY2UsIGRhdGEpKTtcclxuICB9LFxyXG5cclxuICBmaW5kUmVsYXRlZFJlY29yZHMoc291cmNlOiBKU09OQVBJU291cmNlLCBxdWVyeTogUXVlcnkpIHtcclxuICAgIGNvbnN0IGV4cHJlc3Npb24gPSBxdWVyeS5leHByZXNzaW9uIGFzIEZpbmRSZWxhdGVkUmVjb3JkcztcclxuICAgIGNvbnN0IHsgcmVjb3JkLCByZWxhdGlvbnNoaXAgfSA9IGV4cHJlc3Npb247XHJcblxyXG4gICAgbGV0IHJlcXVlc3RPcHRpb25zID0gY3VzdG9tUmVxdWVzdE9wdGlvbnMoc291cmNlLCBxdWVyeSk7XHJcblxyXG4gICAgY29uc3Qgc2V0dGluZ3MgPSBidWlsZEZldGNoU2V0dGluZ3MocmVxdWVzdE9wdGlvbnMpO1xyXG5cclxuICAgIHJldHVybiBzb3VyY2UuZmV0Y2goc291cmNlLnJlbGF0ZWRSZXNvdXJjZVVSTChyZWNvcmQudHlwZSwgcmVjb3JkLmlkLCByZWxhdGlvbnNoaXApLCBzZXR0aW5ncylcclxuICAgICAgLnRoZW4oZGF0YSA9PiBkZXNlcmlhbGl6ZShzb3VyY2UsIGRhdGEpKTtcclxuICB9XHJcbn07XHJcblxyXG5mdW5jdGlvbiBjdXN0b21SZXF1ZXN0T3B0aW9ucyhzb3VyY2U6IEpTT05BUElTb3VyY2UsIHF1ZXJ5OiBRdWVyeSk6IFJlcXVlc3RPcHRpb25zIHtcclxuICBjb25zdCByZXF1ZXN0T3B0aW9uczogUmVxdWVzdE9wdGlvbnMgPSB7fTtcclxuXHJcbiAgY29uc3QgcXVlcnlPcHRpb25zID0gZGVlcEdldChxdWVyeSwgWydvcHRpb25zJywgJ3NvdXJjZXMnLCBzb3VyY2UubmFtZV0pIHx8IHt9O1xyXG5cclxuICBpZiAocXVlcnlPcHRpb25zLmluY2x1ZGUpIHtcclxuICAgIHJlcXVlc3RPcHRpb25zLmluY2x1ZGUgPSBxdWVyeU9wdGlvbnMuaW5jbHVkZS5qb2luKCcsJyk7XHJcbiAgfVxyXG5cclxuICBpZiAocXVlcnlPcHRpb25zLnRpbWVvdXQpIHtcclxuICAgIHJlcXVlc3RPcHRpb25zLnRpbWVvdXQgPSBxdWVyeU9wdGlvbnMudGltZW91dDtcclxuICB9XHJcblxyXG4gIHJldHVybiByZXF1ZXN0T3B0aW9ucztcclxufVxyXG5cclxuZnVuY3Rpb24gYnVpbGRGaWx0ZXJQYXJhbShzb3VyY2U6IEpTT05BUElTb3VyY2UsIGZpbHRlclNwZWNpZmllcnM6IEZpbHRlclNwZWNpZmllcltdKSB7XHJcbiAgY29uc3QgZmlsdGVycyA9IHt9O1xyXG5cclxuICBmaWx0ZXJTcGVjaWZpZXJzLmZvckVhY2goZmlsdGVyU3BlY2lmaWVyID0+IHtcclxuICAgIGlmIChmaWx0ZXJTcGVjaWZpZXIua2luZCA9PT0gJ2F0dHJpYnV0ZScgJiYgZmlsdGVyU3BlY2lmaWVyLm9wID09PSAnZXF1YWwnKSB7XHJcbiAgICAgIGNvbnN0IGF0dHJpYnV0ZUZpbHRlciA9IGZpbHRlclNwZWNpZmllciBhcyBBdHRyaWJ1dGVGaWx0ZXJTcGVjaWZpZXI7XHJcblxyXG4gICAgICAvLyBOb3RlOiBXZSBkb24ndCBrbm93IHRoZSBgdHlwZWAgb2YgdGhlIGF0dHJpYnV0ZSBoZXJlLCBzbyBwYXNzaW5nIGBudWxsYFxyXG4gICAgICBjb25zdCByZXNvdXJjZUF0dHJpYnV0ZSA9IHNvdXJjZS5zZXJpYWxpemVyLnJlc291cmNlQXR0cmlidXRlKG51bGwsIGF0dHJpYnV0ZUZpbHRlci5hdHRyaWJ1dGUpO1xyXG4gICAgICBmaWx0ZXJzW3Jlc291cmNlQXR0cmlidXRlXSA9IGF0dHJpYnV0ZUZpbHRlci52YWx1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRocm93IG5ldyBRdWVyeUV4cHJlc3Npb25QYXJzZUVycm9yKCdGaWx0ZXIgb3BlcmF0aW9uICR7c3BlY2lmaWVyLm9wfSBub3QgcmVjb2duaXplZCBmb3IgSlNPTkFQSVNvdXJjZS4nLCBmaWx0ZXJTcGVjaWZpZXIpO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICByZXR1cm4gZmlsdGVycztcclxufVxyXG5cclxuZnVuY3Rpb24gYnVpbGRTb3J0UGFyYW0oc291cmNlOiBKU09OQVBJU291cmNlLCBzb3J0U3BlY2lmaWVyczogU29ydFNwZWNpZmllcltdKSB7XHJcbiAgcmV0dXJuIHNvcnRTcGVjaWZpZXJzLm1hcChzb3J0U3BlY2lmaWVyID0+IHtcclxuICAgIGlmIChzb3J0U3BlY2lmaWVyLmtpbmQgPT09ICdhdHRyaWJ1dGUnKSB7XHJcbiAgICAgIGNvbnN0IGF0dHJpYnV0ZVNvcnQgPSBzb3J0U3BlY2lmaWVyIGFzIEF0dHJpYnV0ZVNvcnRTcGVjaWZpZXI7XHJcblxyXG4gICAgICAvLyBOb3RlOiBXZSBkb24ndCBrbm93IHRoZSBgdHlwZWAgb2YgdGhlIGF0dHJpYnV0ZSBoZXJlLCBzbyBwYXNzaW5nIGBudWxsYFxyXG4gICAgICBjb25zdCByZXNvdXJjZUF0dHJpYnV0ZSA9IHNvdXJjZS5zZXJpYWxpemVyLnJlc291cmNlQXR0cmlidXRlKG51bGwsIGF0dHJpYnV0ZVNvcnQuYXR0cmlidXRlKTtcclxuICAgICAgcmV0dXJuIChzb3J0U3BlY2lmaWVyLm9yZGVyID09PSAnZGVzY2VuZGluZycgPyAnLScgOiAnJykgKyByZXNvdXJjZUF0dHJpYnV0ZTtcclxuICAgIH1cclxuICAgIHRocm93IG5ldyBRdWVyeUV4cHJlc3Npb25QYXJzZUVycm9yKCdTb3J0IHNwZWNpZmllciAke3NvcnRTcGVjaWZpZXIua2luZH0gbm90IHJlY29nbml6ZWQgZm9yIEpTT05BUElTb3VyY2UuJywgc29ydFNwZWNpZmllcik7XHJcbiAgfSkuam9pbignLCcpO1xyXG59XHJcbiJdfQ==