"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var data_1 = require("@orbit/data");
var utils_1 = require("@orbit/utils");
var request_settings_1 = require("./request-settings");
exports.TransformRequestProcessors = {
    addRecord: function (source, request) {
        var serializer = source.serializer;
        var record = request.record;
        var requestDoc = serializer.serializeDocument(record);
        var settings = request_settings_1.buildFetchSettings(request, { method: 'POST', json: requestDoc });
        return source.fetch(source.resourceURL(record.type), settings)
            .then(function (raw) {
            var responseDoc = serializer.deserializeDocument(raw);
            var updatedRecord = responseDoc.data;
            var updateOps = data_1.recordDiffs(record, updatedRecord);
            if (updateOps.length > 0) {
                return [data_1.buildTransform(updateOps)];
            }
        });
    },
    removeRecord: function (source, request) {
        var _a = request.record, type = _a.type, id = _a.id;
        var settings = request_settings_1.buildFetchSettings(request, { method: 'DELETE' });
        return source.fetch(source.resourceURL(type, id), settings)
            .then(function () { return []; });
    },
    replaceRecord: function (source, request) {
        var record = request.record;
        var type = record.type, id = record.id;
        var requestDoc = source.serializer.serializeDocument(record);
        var settings = request_settings_1.buildFetchSettings(request, { method: 'PATCH', json: requestDoc });
        return source.fetch(source.resourceURL(type, id), settings)
            .then(function () { return []; });
    },
    addToRelatedRecords: function (source, request) {
        var _a = request.record, type = _a.type, id = _a.id;
        var relationship = request.relationship;
        var json = {
            data: request.relatedRecords.map(function (r) { return source.serializer.resourceIdentity(r); })
        };
        var settings = request_settings_1.buildFetchSettings(request, { method: 'POST', json: json });
        return source.fetch(source.resourceRelationshipURL(type, id, relationship), settings)
            .then(function () { return []; });
    },
    removeFromRelatedRecords: function (source, request) {
        var _a = request.record, type = _a.type, id = _a.id;
        var relationship = request.relationship;
        var json = {
            data: request.relatedRecords.map(function (r) { return source.serializer.resourceIdentity(r); })
        };
        var settings = request_settings_1.buildFetchSettings(request, { method: 'DELETE', json: json });
        return source.fetch(source.resourceRelationshipURL(type, id, relationship), settings)
            .then(function () { return []; });
    },
    replaceRelatedRecord: function (source, request) {
        var _a = request.record, type = _a.type, id = _a.id;
        var relationship = request.relationship, relatedRecord = request.relatedRecord;
        var json = {
            data: relatedRecord ? source.serializer.resourceIdentity(relatedRecord) : null
        };
        var settings = request_settings_1.buildFetchSettings(request, { method: 'PATCH', json: json });
        return source.fetch(source.resourceRelationshipURL(type, id, relationship), settings)
            .then(function () { return []; });
    },
    replaceRelatedRecords: function (source, request) {
        var _a = request.record, type = _a.type, id = _a.id;
        var relationship = request.relationship, relatedRecords = request.relatedRecords;
        var json = {
            data: relatedRecords.map(function (r) { return source.serializer.resourceIdentity(r); })
        };
        var settings = request_settings_1.buildFetchSettings(request, { method: 'PATCH', json: json });
        return source.fetch(source.resourceRelationshipURL(type, id, relationship), settings)
            .then(function () { return []; });
    }
};
function getTransformRequests(source, transform) {
    var operations = transform.operations;
    var requests = [];
    var prevRequest;
    var options = (transform.options && transform.options.sources && transform.options.sources[source.name]) || {};
    transform.operations.forEach(function (operation) {
        var request;
        var newRequestNeeded = true;
        if (prevRequest && data_1.equalRecordIdentities(prevRequest.record, operation.record)) {
            if (operation.op === 'removeRecord') {
                newRequestNeeded = false;
                if (prevRequest.op !== 'removeRecord') {
                    prevRequest = null;
                    requests.pop();
                }
            }
            else if (prevRequest.op === 'addRecord' || prevRequest.op === 'replaceRecord') {
                if (operation.op === 'replaceAttribute') {
                    newRequestNeeded = false;
                    replaceRecordAttribute(prevRequest.record, operation.attribute, operation.value);
                }
                else if (operation.op === 'replaceRelatedRecord') {
                    newRequestNeeded = false;
                    replaceRecordHasOne(prevRequest.record, operation.relationship, operation.relatedRecord);
                }
                else if (operation.op === 'replaceRelatedRecords') {
                    newRequestNeeded = false;
                    replaceRecordHasMany(prevRequest.record, operation.relationship, operation.relatedRecords);
                }
            }
            else if (prevRequest.op === 'addToRelatedRecords' &&
                operation.op === 'addToRelatedRecords' &&
                prevRequest.relationship === operation.relationship) {
                newRequestNeeded = false;
                prevRequest.relatedRecords.push(data_1.cloneRecordIdentity(operation.relatedRecord));
            }
        }
        if (newRequestNeeded) {
            request = OperationToRequestMap[operation.op](operation);
        }
        if (request) {
            if (options.include) {
                request.include = options.include.join(',');
            }
            if (options.timeout) {
                request.timeout = options.timeout;
            }
            requests.push(request);
            prevRequest = request;
        }
    });
    return requests;
}
exports.getTransformRequests = getTransformRequests;
var OperationToRequestMap = {
    addRecord: function (operation) {
        return {
            op: 'addRecord',
            record: utils_1.clone(operation.record)
        };
    },
    removeRecord: function (operation) {
        return {
            op: 'removeRecord',
            record: data_1.cloneRecordIdentity(operation.record)
        };
    },
    replaceAttribute: function (operation) {
        var record = data_1.cloneRecordIdentity(operation.record);
        replaceRecordAttribute(record, operation.attribute, operation.value);
        return {
            op: 'replaceRecord',
            record: record
        };
    },
    replaceRecord: function (operation) {
        return {
            op: 'replaceRecord',
            record: utils_1.clone(operation.record)
        };
    },
    addToRelatedRecords: function (operation) {
        return {
            op: 'addToRelatedRecords',
            record: data_1.cloneRecordIdentity(operation.record),
            relationship: operation.relationship,
            relatedRecords: [data_1.cloneRecordIdentity(operation.relatedRecord)]
        };
    },
    removeFromRelatedRecords: function (operation) {
        return {
            op: 'removeFromRelatedRecords',
            record: data_1.cloneRecordIdentity(operation.record),
            relationship: operation.relationship,
            relatedRecords: [data_1.cloneRecordIdentity(operation.relatedRecord)]
        };
    },
    replaceRelatedRecord: function (operation) {
        var record = {
            type: operation.record.type,
            id: operation.record.id
        };
        utils_1.deepSet(record, ['relationships', operation.relationship, 'data'], operation.relatedRecord);
        return {
            op: 'replaceRecord',
            record: record
        };
    },
    replaceRelatedRecords: function (operation) {
        var record = data_1.cloneRecordIdentity(operation.record);
        utils_1.deepSet(record, ['relationships', operation.relationship, 'data'], operation.relatedRecords);
        return {
            op: 'replaceRecord',
            record: record
        };
    }
};
function replaceRecordAttribute(record, attribute, value) {
    utils_1.deepSet(record, ['attributes', attribute], value);
}
function replaceRecordHasOne(record, relationship, relatedRecord) {
    utils_1.deepSet(record, ['relationships', relationship, 'data'], relatedRecord ? data_1.cloneRecordIdentity(relatedRecord) : null);
}
function replaceRecordHasMany(record, relationship, relatedRecords) {
    utils_1.deepSet(record, ['relationships', relationship, 'data'], relatedRecords.map(function (r) { return data_1.cloneRecordIdentity(r); }));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNmb3JtLXJlcXVlc3RzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2xpYi90cmFuc2Zvcm0tcmVxdWVzdHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxvQ0FpQnFCO0FBQ3JCLHNDQUE4QztBQUk5Qyx1REFBd0U7QUFFM0QsUUFBQSwwQkFBMEIsR0FBRztJQUN4QyxTQUFTLFlBQUMsTUFBcUIsRUFBRSxPQUFPO1FBQzlCLElBQUEsOEJBQVUsQ0FBWTtRQUM5QixJQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQzlCLElBQU0sVUFBVSxHQUFvQixVQUFVLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDekUsSUFBTSxRQUFRLEdBQUcscUNBQWtCLENBQUMsT0FBTyxFQUFFLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FBQztRQUVuRixNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxRQUFRLENBQUM7YUFDM0QsSUFBSSxDQUFDLFVBQUMsR0FBb0I7WUFDekIsSUFBSSxXQUFXLEdBQXlCLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUM1RSxJQUFJLGFBQWEsR0FBbUIsV0FBVyxDQUFDLElBQUksQ0FBQztZQUVyRCxJQUFJLFNBQVMsR0FBRyxrQkFBVyxDQUFDLE1BQU0sRUFBRSxhQUFhLENBQUMsQ0FBQztZQUNuRCxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3pCLE1BQU0sQ0FBQyxDQUFDLHFCQUFjLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztZQUNyQyxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsWUFBWSxZQUFDLE1BQXFCLEVB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QUFBO1NBQ1AsQ0FBQztJQUNKLENBQUM7SUFFRCxxQkFBcUIsWUFBQyxTQUF5QztRQUM3RCxJQUFNLE1BQU0sR0FBRywwQkFBbUIsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDckQsZUFBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLGVBQWUsRUFBRSxTQUFTLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxFQUFFLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUU3RixNQUFNLENBQUM7WUFDTCxFQUFFLEVBQUUsZUFBZTtZQUNuQixNQUFNLFFBQUE7U0FDUCxDQUFDO0lBQ0osQ0FBQztDQUNGLENBQUM7QUFFRixnQ0FBZ0MsTUFBc0IsRUFBRSxTQUFpQixFQUFFLEtBQVU7SUFDbkYsZUFBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLFlBQVksRUFBRSxTQUFTLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUNwRCxDQUFDO0FBRUQsNkJBQTZCLE1BQXNCLEVBQUUsWUFBb0IsRUFBRSxhQUE2QjtJQUN0RyxlQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsZUFBZSxFQUFFLFlBQVksRUFBRSxNQUFNLENBQUMsRUFBRSxhQUFhLEdBQUcsMEJBQW1CLENBQUMsYUFBYSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7QUFDdEgsQ0FBQztBQUVELDhCQUE4QixNQUFzQixFQUFFLFlBQW9CLEVBQUUsY0FBZ0M7SUFDMUcsZUFBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLGVBQWUsRUFBRSxZQUFZLEVBQUUsTUFBTSxDQUFDLEVBQUUsY0FBYyxDQUFDLEdBQUcsQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLDBCQUFtQixDQUFDLENBQUMsQ0FBQyxFQUF0QixDQUFzQixDQUFDLENBQUMsQ0FBQztBQUM1RyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBjbG9uZVJlY29yZElkZW50aXR5LFxyXG4gIGVxdWFsUmVjb3JkSWRlbnRpdGllcyxcclxuICByZWNvcmREaWZmcyxcclxuICBSZWNvcmQsXHJcbiAgUmVjb3JkSWRlbnRpdHksXHJcbiAgUmVjb3JkT3BlcmF0aW9uLFxyXG4gIFRyYW5zZm9ybSxcclxuICBBZGRSZWNvcmRPcGVyYXRpb24sXHJcbiAgUmVtb3ZlUmVjb3JkT3BlcmF0aW9uLFxyXG4gIFJlcGxhY2VBdHRyaWJ1dGVPcGVyYXRpb24sXHJcbiAgUmVwbGFjZVJlY29yZE9wZXJhdGlvbixcclxuICBBZGRUb1JlbGF0ZWRSZWNvcmRzT3BlcmF0aW9uLFxyXG4gIFJlbW92ZUZyb21SZWxhdGVkUmVjb3Jkc09wZXJhdGlvbixcclxuICBSZXBsYWNlUmVsYXRlZFJlY29yZE9wZXJhdGlvbixcclxuICBSZXBsYWNlUmVsYXRlZFJlY29yZHNPcGVyYXRpb24sXHJcbiAgYnVpbGRUcmFuc2Zvcm1cclxufSBmcm9tICdAb3JiaXQvZGF0YSc7XHJcbmltcG9ydCB7IGNsb25lLCBkZWVwU2V0IH0gZnJvbSAnQG9yYml0L3V0aWxzJztcclxuaW1wb3J0IEpTT05BUElTb3VyY2UgZnJvbSAnLi4vanNvbmFwaS1zb3VyY2UnO1xyXG5pbXBvcnQgeyBKU09OQVBJRG9jdW1lbnQgfSBmcm9tICcuLi9qc29uYXBpLWRvY3VtZW50JztcclxuaW1wb3J0IHsgRGVzZXJpYWxpemVkRG9jdW1lbnQgfSBmcm9tICcuLi9qc29uYXBpLXNlcmlhbGl6ZXInO1xyXG5pbXBvcnQgeyBSZXF1ZXN0T3B0aW9ucywgYnVpbGRGZXRjaFNldHRpbmdzIH0gZnJvbSAnLi9yZXF1ZXN0LXNldHRpbmdzJztcclxuXHJcbmV4cG9ydCBjb25zdCBUcmFuc2Zvcm1SZXF1ZXN0UHJvY2Vzc29ycyA9IHtcclxuICBhZGRSZWNvcmQoc291cmNlOiBKU09OQVBJU291cmNlLCByZXF1ZXN0KSB7XHJcbiAgICBjb25zdCB7IHNlcmlhbGl6ZXIgfSA9IHNvdXJjZTtcclxuICAgIGNvbnN0IHJlY29yZCA9IHJlcXVlc3QucmVjb3JkO1xyXG4gICAgY29uc3QgcmVxdWVzdERvYzogSlNPTkFQSURvY3VtZW50ID0gc2VyaWFsaXplci5zZXJpYWxpemVEb2N1bWVudChyZWNvcmQpO1xyXG4gICAgY29uc3Qgc2V0dGluZ3MgPSBidWlsZEZldGNoU2V0dGluZ3MocmVxdWVzdCwgeyBtZXRob2Q6ICdQT1NUJywganNvbjogcmVxdWVzdERvYyB9KTtcclxuXHJcbiAgICByZXR1cm4gc291cmNlLmZldGNoKHNvdXJjZS5yZXNvdXJjZVVSTChyZWNvcmQudHlwZSksIHNldHRpbmdzKVxyXG4gICAgICAudGhlbigocmF3OiBKU09OQVBJRG9jdW1lbnQpID0+IHtcclxuICAgICAgICBsZXQgcmVzcG9uc2VEb2M6IERlc2VyaWFsaXplZERvY3VtZW50ID0gc2VyaWFsaXplci5kZXNlcmlhbGl6ZURvY3VtZW50KHJhdyk7XHJcbiAgICAgICAgbGV0IHVwZGF0ZWRSZWNvcmQ6IFJlY29yZCA9IDxSZWNvcmQ+cmVzcG9uc2VEb2MuZGF0YTtcclxuXHJcbiAgICAgICAgbGV0IHVwZGF0ZU9wcyA9IHJlY29yZERpZmZzKHJlY29yZCwgdXBkYXRlZFJlY29yZCk7XHJcbiAgICAgICAgaWYgKHVwZGF0ZU9wcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICByZXR1cm4gW2J1aWxkVHJhbnNmb3JtKHVwZGF0ZU9wcyldO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgfSxcclxuXHJcbiAgcmVtb3ZlUmVjb3JkKHNvdXJjZTogSlNPTkFQSVNvdXJjZSwgcmVxdWVzdCkge1xyXG4gICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gcmVxdWVzdC5yZWNvcmQ7XHJcbiAgICBjb25zdCBzZXR0aW5ncyA9IGJ1aWxkRmV0Y2hTZXR0aW5ncyhyZXF1ZXN0LCB7IG1ldGhvZDogJ0RFTEVURScgfSk7XHJcblxyXG4gICAgcmV0dXJuIHNvdXJjZS5mZXRjaChzb3VyY2UucmVzb3VyY2VVUkwodHlwZSwgaWQpLCBzZXR0aW5ncylcclxuICAgICAgLnRoZW4oKCkgPT4gW10pO1xyXG4gIH0sXHJcblxyXG4gIHJlcGxhY2VSZWNvcmQoc291cmNlOiBKU09OQVBJU291cmNlLCByZXF1ZXN0KSB7XHJcbiAgICBjb25zdCByZWNvcmQgPSByZXF1ZXN0LnJlY29yZDtcclxuICAgIGNvbnN0IHsgdHlwZSwgaWQgfSA9IHJlY29yZDtcclxuICAgIGNvbnN0IHJlcXVlc3REb2M6IEpTT05BUElEb2N1bWVudCA9IHNvdXJjZS5zZXJpYWxpemVyLnNlcmlhbGl6ZURvY3VtZW50KHJlY29yZCk7XHJcbiAgICBjb25zdCBzZXR0aW5ncyA9IGJ1aWxkRmV0Y2hTZXR0aW5ncyhyZXF1ZXN0LCB7IG1ldGhvZDogJ1BBVENIJywganNvbjogcmVxdWVzdERvYyB9KTtcclxuXHJcbiAgICByZXR1cm4gc291cmNlLmZldGNoKHNvdXJjZS5yZXNvdXJjZVVSTCh0eXBlLCBpZCksIHNldHRpbmdzKVxyXG4gICAgICAudGhlbigoKSA9PiBbXSk7XHJcbiAgfSxcclxuXHJcbiAgYWRkVG9SZWxhdGVkUmVjb3Jkcyhzb3VyY2U6IEpTT05BUElTb3VyY2UsIHJlcXVlc3QpIHtcclxuICAgIGNvbnN0IHsgdHlwZSwgaWQgfSA9IHJlcXVlc3QucmVjb3JkO1xyXG4gICAgY29uc3QgeyByZWxhdGlvbnNoaXAgfSA9IHJlcXVlc3Q7XHJcbiAgICBjb25zdCBqc29uID0ge1xyXG4gICAgICBkYXRhOiByZXF1ZXN0LnJlbGF0ZWRSZWNvcmRzLm1hcChyID0+IHNvdXJjZS5zZXJpYWxpemVyLnJlc291cmNlSWRlbnRpdHkocikpXHJcbiAgICB9O1xyXG4gICAgY29uc3Qgc2V0dGluZ3MgPSBidWlsZEZldGNoU2V0dGluZ3MocmVxdWVzdCwgeyBtZXRob2Q6ICdQT1NUJywganNvbiB9KTtcclxuXHJcbiAgICByZXR1cm4gc291cmNlLmZldGNoKHNvdXJjZS5yZXNvdXJjZVJlbGF0aW9uc2hpcFVSTCh0eXBlLCBpZCwgcmVsYXRpb25zaGlwKSwgc2V0dGluZ3MpXHJcbiAgICAgIC50aGVuKCgpID0+IFtdKTtcclxuICB9LFxyXG5cclxuICByZW1vdmVGcm9tUmVsYXRlZFJlY29yZHMoc291cmNlOiBKU09OQVBJU291cmNlLCByZXF1ZXN0KSB7XHJcbiAgICBjb25zdCB7IHR5cGUsIGlkIH0gPSByZXF1ZXN0LnJlY29yZDtcclxuICAgIGNvbnN0IHsgcmVsYXRpb25zaGlwIH0gPSByZXF1ZXN0O1xyXG4gICAgY29uc3QganNvbiA9IHtcclxuICAgICAgZGF0YTogcmVxdWVzdC5yZWxhdGVkUmVjb3Jkcy5tYXAociA9PiBzb3VyY2Uuc2VyaWFsaXplci5yZXNvdXJjZUlkZW50aXR5KHIpKVxyXG4gICAgfTtcclxuICAgIGNvbnN0IHNldHRpbmdzID0gYnVpbGRGZXRjaFNldHRpbmdzKHJlcXVlc3QsIHsgbWV0aG9kOiAnREVMRVRFJywganNvbiB9KTtcclxuXHJcbiAgICByZXR1cm4gc291cmNlLmZldGNoKHNvdXJjZS5yZXNvdXJjZVJlbGF0aW9uc2hpcFVSTCh0eXBlLCBpZCwgcmVsYXRpb25zaGlwKSwgc2V0dGluZ3MpXHJcbiAgICAgIC50aGVuKCgpID0+IFtdKTtcclxuICB9LFxyXG5cclxuICByZXBsYWNlUmVsYXRlZFJlY29yZChzb3VyY2U6IEpTT05BUElTb3VyY2UsIHJlcXVlc3QpIHtcclxuICAgIGNvbnN0IHsgdHlwZSwgaWQgfSA9IHJlcXVlc3QucmVjb3JkO1xyXG4gICAgY29uc3QgeyByZWxhdGlvbnNoaXAsIHJlbGF0ZWRSZWNvcmQgfSA9IHJlcXVlc3Q7XHJcbiAgICBjb25zdCBqc29uID0ge1xyXG4gICAgICBkYXRhOiByZWxhdGVkUmVjb3JkID8gc291cmNlLnNlcmlhbGl6ZXIucmVzb3VyY2VJZGVudGl0eShyZWxhdGVkUmVjb3JkKSA6IG51bGxcclxuICAgIH07XHJcbiAgICBjb25zdCBzZXR0aW5ncyA9IGJ1aWxkRmV0Y2hTZXR0aW5ncyhyZXF1ZXN0LCB7IG1ldGhvZDogJ1BBVENIJywganNvbiB9KTtcclxuXHJcbiAgICByZXR1cm4gc291cmNlLmZldGNoKHNvdXJjZS5yZXNvdXJjZVJlbGF0aW9uc2hpcFVSTCh0eXBlLCBpZCwgcmVsYXRpb25zaGlwKSwgc2V0dGluZ3MpXHJcbiAgICAgIC50aGVuKCgpID0+IFtdKTtcclxuICB9LFxyXG5cclxuICByZXBsYWNlUmVsYXRlZFJlY29yZHMoc291cmNlOiBKU09OQVBJU291cmNlLCByZXF1ZXN0KSB7XHJcbiAgICBjb25zdCB7IHR5cGUsIGlkIH0gPSByZXF1ZXN0LnJlY29yZDtcclxuICAgIGNvbnN0IHsgcmVsYXRpb25zaGlwLCByZWxhdGVkUmVjb3JkcyB9ID0gcmVxdWVzdDtcclxuICAgIGNvbnN0IGpzb24gPSB7XHJcbiAgICAgIGRhdGE6IHJlbGF0ZWRSZWNvcmRzLm1hcChyID0+IHNvdXJjZS5zZXJpYWxpemVyLnJlc291cmNlSWRlbnRpdHkocikpXHJcbiAgICB9O1xyXG4gICAgY29uc3Qgc2V0dGluZ3MgPSBidWlsZEZldGNoU2V0dGluZ3MocmVxdWVzdCwgeyBtZXRob2Q6ICdQQVRDSCcsIGpzb24gfSk7XHJcblxyXG4gICAgcmV0dXJuIHNvdXJjZS5mZXRjaChzb3VyY2UucmVzb3VyY2VSZWxhdGlvbnNoaXBVUkwodHlwZSwgaWQsIHJlbGF0aW9uc2hpcCksIHNldHRpbmdzKVxyXG4gICAgICAudGhlbigoKSA9PiBbXSk7XHJcbiAgfVxyXG59O1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFRyYW5zZm9ybVJlcXVlc3RzKHNvdXJjZTogSlNPTkFQSVNvdXJjZSwgdHJhbnNmb3JtOiBUcmFuc2Zvcm0pIHtcclxuICBjb25zdCBvcGVyYXRpb25zOiBSZWNvcmRPcGVyYXRpb25bXSA9IDxSZWNvcmRPcGVyYXRpb25bXT50cmFuc2Zvcm0ub3BlcmF0aW9ucztcclxuICBjb25zdCByZXF1ZXN0cyA9IFtdO1xyXG4gIGxldCBwcmV2UmVxdWVzdDtcclxuXHJcbiAgY29uc3Qgb3B0aW9ucyA9ICh0cmFuc2Zvcm0ub3B0aW9ucyAmJiB0cmFuc2Zvcm0ub3B0aW9ucy5zb3VyY2VzICYmIHRyYW5zZm9ybS5vcHRpb25zLnNvdXJjZXNbc291cmNlLm5hbWVdKSB8fCB7fTtcclxuXHJcbiAgdHJhbnNmb3JtLm9wZXJhdGlvbnMuZm9yRWFjaCgob3BlcmF0aW9uOiBSZWNvcmRPcGVyYXRpb24pID0+IHtcclxuICAgIGxldCByZXF1ZXN0O1xyXG4gICAgbGV0IG5ld1JlcXVlc3ROZWVkZWQgPSB0cnVlO1xyXG5cclxuICAgIGlmIChwcmV2UmVxdWVzdCAmJiBlcXVhbFJlY29yZElkZW50aXRpZXMocHJldlJlcXVlc3QucmVjb3JkLCBvcGVyYXRpb24ucmVjb3JkKSkge1xyXG4gICAgICBpZiAob3BlcmF0aW9uLm9wID09PSAncmVtb3ZlUmVjb3JkJykge1xyXG4gICAgICAgIG5ld1JlcXVlc3ROZWVkZWQgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgaWYgKHByZXZSZXF1ZXN0Lm9wICE9PSAncmVtb3ZlUmVjb3JkJykge1xyXG4gICAgICAgICAgcHJldlJlcXVlc3QgPSBudWxsO1xyXG4gICAgICAgICAgcmVxdWVzdHMucG9wKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2UgaWYgKHByZXZSZXF1ZXN0Lm9wID09PSAnYWRkUmVjb3JkJyB8fCBwcmV2UmVxdWVzdC5vcCA9PT0gJ3JlcGxhY2VSZWNvcmQnKSB7XHJcbiAgICAgICAgaWYgKG9wZXJhdGlvbi5vcCA9PT0gJ3JlcGxhY2VBdHRyaWJ1dGUnKSB7XHJcbiAgICAgICAgICBuZXdSZXF1ZXN0TmVlZGVkID0gZmFsc2U7XHJcbiAgICAgICAgICByZXBsYWNlUmVjb3JkQXR0cmlidXRlKHByZXZSZXF1ZXN0LnJlY29yZCwgb3BlcmF0aW9uLmF0dHJpYnV0ZSwgb3BlcmF0aW9uLnZhbHVlKTtcclxuICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdGlvbi5vcCA9PT0gJ3JlcGxhY2VSZWxhdGVkUmVjb3JkJykge1xyXG4gICAgICAgICAgbmV3UmVxdWVzdE5lZWRlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgcmVwbGFjZVJlY29yZEhhc09uZShwcmV2UmVxdWVzdC5yZWNvcmQsIG9wZXJhdGlvbi5yZWxhdGlvbnNoaXAsIG9wZXJhdGlvbi5yZWxhdGVkUmVjb3JkKTtcclxuICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdGlvbi5vcCA9PT0gJ3JlcGxhY2VSZWxhdGVkUmVjb3JkcycpIHtcclxuICAgICAgICAgIG5ld1JlcXVlc3ROZWVkZWQgPSBmYWxzZTtcclxuICAgICAgICAgIHJlcGxhY2VSZWNvcmRIYXNNYW55KHByZXZSZXF1ZXN0LnJlY29yZCwgb3BlcmF0aW9uLnJlbGF0aW9uc2hpcCwgb3BlcmF0aW9uLnJlbGF0ZWRSZWNvcmRzKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSBpZiAocHJldlJlcXVlc3Qub3AgPT09ICdhZGRUb1JlbGF0ZWRSZWNvcmRzJyAmJlxyXG4gICAgICAgICAgICAgICAgIG9wZXJhdGlvbi5vcCA9PT0gJ2FkZFRvUmVsYXRlZFJlY29yZHMnICYmXHJcbiAgICAgICAgICAgICAgICAgcHJldlJlcXVlc3QucmVsYXRpb25zaGlwID09PSBvcGVyYXRpb24ucmVsYXRpb25zaGlwKSB7XHJcbiAgICAgICAgbmV3UmVxdWVzdE5lZWRlZCA9IGZhbHNlO1xyXG4gICAgICAgIHByZXZSZXF1ZXN0LnJlbGF0ZWRSZWNvcmRzLnB1c2goY2xvbmVSZWNvcmRJZGVudGl0eShvcGVyYXRpb24ucmVsYXRlZFJlY29yZCkpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKG5ld1JlcXVlc3ROZWVkZWQpIHtcclxuICAgICAgcmVxdWVzdCA9IE9wZXJhdGlvblRvUmVxdWVzdE1hcFtvcGVyYXRpb24ub3BdKG9wZXJhdGlvbik7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHJlcXVlc3QpIHtcclxuICAgICAgaWYgKG9wdGlvbnMuaW5jbHVkZSkge1xyXG4gICAgICAgIHJlcXVlc3QuaW5jbHVkZSA9IG9wdGlvbnMuaW5jbHVkZS5qb2luKCcsJyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmIChvcHRpb25zLnRpbWVvdXQpIHtcclxuICAgICAgICByZXF1ZXN0LnRpbWVvdXQgPSBvcHRpb25zLnRpbWVvdXQ7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJlcXVlc3RzLnB1c2gocmVxdWVzdCk7XHJcbiAgICAgIHByZXZSZXF1ZXN0ID0gcmVxdWVzdDtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgcmV0dXJuIHJlcXVlc3RzO1xyXG59XHJcblxyXG5jb25zdCBPcGVyYXRpb25Ub1JlcXVlc3RNYXAgPSB7XHJcbiAgYWRkUmVjb3JkKG9wZXJhdGlvbjogQWRkUmVjb3JkT3BlcmF0aW9uKSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBvcDogJ2FkZFJlY29yZCcsXHJcbiAgICAgIHJlY29yZDogY2xvbmUob3BlcmF0aW9uLnJlY29yZClcclxuICAgIH07XHJcbiAgfSxcclxuXHJcbiAgcmVtb3ZlUmVjb3JkKG9wZXJhdGlvbjogUmVtb3ZlUmVjb3JkT3BlcmF0aW9uKSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBvcDogJ3JlbW92ZVJlY29yZCcsXHJcbiAgICAgIHJlY29yZDogY2xvbmVSZWNvcmRJZGVudGl0eShvcGVyYXRpb24ucmVjb3JkKVxyXG4gICAgfTtcclxuICB9LFxyXG5cclxuICByZXBsYWNlQXR0cmlidXRlKG9wZXJhdGlvbjogUmVwbGFjZUF0dHJpYnV0ZU9wZXJhdGlvbikge1xyXG4gICAgY29uc3QgcmVjb3JkID0gY2xvbmVSZWNvcmRJZGVudGl0eShvcGVyYXRpb24ucmVjb3JkKTtcclxuXHJcbiAgICByZXBsYWNlUmVjb3JkQXR0cmlidXRlKHJlY29yZCwgb3BlcmF0aW9uLmF0dHJpYnV0ZSwgb3BlcmF0aW9uLnZhbHVlKTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBvcDogJ3JlcGxhY2VSZWNvcmQnLFxyXG4gICAgICByZWNvcmRcclxuICAgIH07XHJcbiAgfSxcclxuXHJcbiAgcmVwbGFjZVJlY29yZChvcGVyYXRpb246IFJlcGxhY2VSZWNvcmRPcGVyYXRpb24pIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIG9wOiAncmVwbGFjZVJlY29yZCcsXHJcbiAgICAgIHJlY29yZDogY2xvbmUob3BlcmF0aW9uLnJlY29yZClcclxuICAgIH07XHJcbiAgfSxcclxuXHJcbiAgYWRkVG9SZWxhdGVkUmVjb3JkcyhvcGVyYXRpb246IEFkZFRvUmVsYXRlZFJlY29yZHNPcGVyYXRpb24pIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIG9wOiAnYWRkVG9SZWxhdGVkUmVjb3JkcycsXHJcbiAgICAgIHJlY29yZDogY2xvbmVSZWNvcmRJZGVudGl0eShvcGVyYXRpb24ucmVjb3JkKSxcclxuICAgICAgcmVsYXRpb25zaGlwOiBvcGVyYXRpb24ucmVsYXRpb25zaGlwLFxyXG4gICAgICByZWxhdGVkUmVjb3JkczogW2Nsb25lUmVjb3JkSWRlbnRpdHkob3BlcmF0aW9uLnJlbGF0ZWRSZWNvcmQpXVxyXG4gICAgfTtcclxuICB9LFxyXG5cclxuICByZW1vdmVGcm9tUmVsYXRlZFJlY29yZHMob3BlcmF0aW9uOiBSZW1vdmVGcm9tUmVsYXRlZFJlY29yZHNPcGVyYXRpb24pIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIG9wOiAncmVtb3ZlRnJvbVJlbGF0ZWRSZWNvcmRzJyxcclxuICAgICAgcmVjb3JkOiBjbG9uZVJlY29yZElkZW50aXR5KG9wZXJhdGlvbi5yZWNvcmQpLFxyXG4gICAgICByZWxhdGlvbnNoaXA6IG9wZXJhdGlvbi5yZWxhdGlvbnNoaXAsXHJcbiAgICAgIHJlbGF0ZWRSZWNvcmRzOiBbY2xvbmVSZWNvcmRJZGVudGl0eShvcGVyYXRpb24ucmVsYXRlZFJlY29yZCldXHJcbiAgICB9O1xyXG4gIH0sXHJcblxyXG4gIHJlcGxhY2VSZWxhdGVkUmVjb3JkKG9wZXJhdGlvbjogUmVwbGFjZVJlbGF0ZWRSZWNvcmRPcGVyYXRpb24pIHtcclxuICAgIGNvbnN0IHJlY29yZDogUmVjb3JkID0ge1xyXG4gICAgICB0eXBlOiBvcGVyYXRpb24ucmVjb3JkLnR5cGUsXHJcbiAgICAgIGlkOiBvcGVyYXRpb24ucmVjb3JkLmlkXHJcbiAgICB9O1xyXG5cclxuICAgIGRlZXBTZXQocmVjb3JkLCBbJ3JlbGF0aW9uc2hpcHMnLCBvcGVyYXRpb24ucmVsYXRpb25zaGlwLCAnZGF0YSddLCBvcGVyYXRpb24ucmVsYXRlZFJlY29yZCk7XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgb3A6ICdyZXBsYWNlUmVjb3JkJyxcclxuICAgICAgcmVjb3JkXHJcbiAgICB9O1xyXG4gIH0sXHJcblxyXG4gIHJlcGxhY2VSZWxhdGVkUmVjb3JkcyhvcGVyYXRpb246IFJlcGxhY2VSZWxhdGVkUmVjb3Jkc09wZXJhdGlvbikge1xyXG4gICAgY29uc3QgcmVjb3JkID0gY2xvbmVSZWNvcmRJZGVudGl0eShvcGVyYXRpb24ucmVjb3JkKTtcclxuICAgIGRlZXBTZXQocmVjb3JkLCBbJ3JlbGF0aW9uc2hpcHMnLCBvcGVyYXRpb24ucmVsYXRpb25zaGlwLCAnZGF0YSddLCBvcGVyYXRpb24ucmVsYXRlZFJlY29yZHMpO1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIG9wOiAncmVwbGFjZVJlY29yZCcsXHJcbiAgICAgIHJlY29yZFxyXG4gICAgfTtcclxuICB9XHJcbn07XHJcblxyXG5mdW5jdGlvbiByZXBsYWNlUmVjb3JkQXR0cmlidXRlKHJlY29yZDogUmVjb3JkSWRlbnRpdHksIGF0dHJpYnV0ZTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XHJcbiAgZGVlcFNldChyZWNvcmQsIFsnYXR0cmlidXRlcycsIGF0dHJpYnV0ZV0sIHZhbHVlKTtcclxufVxyXG5cclxuZnVuY3Rpb24gcmVwbGFjZVJlY29yZEhhc09uZShyZWNvcmQ6IFJlY29yZElkZW50aXR5LCByZWxhdGlvbnNoaXA6IHN0cmluZywgcmVsYXRlZFJlY29yZDogUmVjb3JkSWRlbnRpdHkpIHtcclxuICBkZWVwU2V0KHJlY29yZCwgWydyZWxhdGlvbnNoaXBzJywgcmVsYXRpb25zaGlwLCAnZGF0YSddLCByZWxhdGVkUmVjb3JkID8gY2xvbmVSZWNvcmRJZGVudGl0eShyZWxhdGVkUmVjb3JkKSA6IG51bGwpO1xyXG59XHJcblxyXG5mdW5jdGlvbiByZXBsYWNlUmVjb3JkSGFzTWFueShyZWNvcmQ6IFJlY29yZElkZW50aXR5LCByZWxhdGlvbnNoaXA6IHN0cmluZywgcmVsYXRlZFJlY29yZHM6IFJlY29yZElkZW50aXR5W10pIHtcclxuICBkZWVwU2V0KHJlY29yZCwgWydyZWxhdGlvbnNoaXBzJywgcmVsYXRpb25zaGlwLCAnZGF0YSddLCByZWxhdGVkUmVjb3Jkcy5tYXAociA9PiBjbG9uZVJlY29yZElkZW50aXR5KHIpKSk7XHJcbn1cclxuIl19