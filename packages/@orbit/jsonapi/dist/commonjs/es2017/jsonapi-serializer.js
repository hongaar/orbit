"use strict";

Object.defineProperty(exports, "__esModule", { value: true });
var utils_1 = require("@orbit/utils");
var JSONAPISerializer = function () {
    function JSONAPISerializer(settings) {
        this._schema = settings.schema;
        this._keyMap = settings.keyMap;
    }
    Object.defineProperty(JSONAPISerializer.prototype, "schema", {
        get: function () {
            return this._schema;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(JSONAPISerializer.prototype, "keyMap", {
        get: function () {
            return this._keyMap;
        },
        enumerable: true,
        configurable: true
    });
    JSONAPISerializer.prototype.resourceKey = function (type) {
        return 'id';
    };
    JSONAPISerializer.prototype.resourceType = function (type) {
        return utils_1.dasherize(this.schema.pluralize(type));
    };
    JSONAPISerializer.prototype.resourceRelationship = function (type, relationship) {
        return utils_1.dasherize(relationship);
    };
    JSONAPISerializer.prototype.resourceAttribute = function (type, attr) {
        return utils_1.dasherize(attr);
    };
    JSONAPISerializer.prototype.resourceIdentity = function (identity) {
        return {
            type: this.resourceType(identity.type),
            id: this.resourceId(identity.type, identity.id)
        };
    };
    JSONAPISerializer.prototype.resourceIds = function (type, ids) {
        var _this = this;
        return ids.map(function (id) {
            return _this.resourceId(type, id);
        });
    };
    JSONAPISerializer.prototype.resourceId = function (type, id) {
        var resourceKey = this.resourceKey(type);
        if (resourceKey === 'id') {
            return id;
        } else {
            return this.keyMap.idToKey(type, resourceKey, id);
        }
    };
    JSONAPISerializer.prototype.recordId = function (type, resourceId) {
        var resourceKey = this.resourceKey(type);
        if (resourceKey === 'id') {
            return resourceId;
        }
        var existingId = this.keyMap.keyToId(type, resourceKey, resourceId);
        if (existingId) {
            return existingId;
        }
        return this._generateNewId(type, resourceKey, resourceId);
    };
    JSONAPISerializer.prototype.recordType = function (resourceType) {
        return utils_1.camelize(this.schema.singularize(resourceType));
    };
    JSONAPISerializer.prototype.recordIdentity = function (resourceIdentity) {
        var type = this.recordType(resourceIdentity.type);
        var id = this.recordId(type, resourceIdentity.id);
        return { type: type, id: id };
    };
    JSONAPISerializer.prototype.recordAttribute = function (type, resourceAttribute) {
        return utils_1.camelize(resourceAttribute);
    };
    JSONAPISerializer.prototype.recordRelationship = function (type, resourceRelationship) {
        return utils_1.camelize(resourceRelationship);
    };
    JSONAPISerializer.prototype.serializeDocument = function (data) {
        return {
            data: utils_1.isArray(data) ? this.serializeRecords(data) : this.serializeRecord(data)
        };
    };
    JSONAPISerializer.prototype.serializeRecords = function (records) {
        var _this = this;
        return records.map(function (record) {
            return _this.serializeRecord(record);
        });
    };
    JSONAPISerializer.prototype.serializeRecord = function (record) {
        var resource = {
            type: this.resourceType(record.type)
        };
        this.serializeId(resource, record);
        this.serializeAttributes(resource, record);
        this.serializeRelationships(resource, record);
        return resource;
    };
    JSONAPISerializer.prototype.serializeId = function (resource, record) {
        var value = this.resourceId(record.type, record.id);
        if (value !== undefined) {
            resource.id = value;
        }
    };
    JSONAPISerializer.prototype.serializeAttributes = function (resource, record) {
        var _this = this;
        if (record.attributes) {
            Object.keys(record.attributes).forEach(function (attr) {
                _this.serializeAttribute(resource, record, attr);
            });
        }
    };
    JSONAPISerializer.prototype.serializeAttribute = function (resource, record, attr) {
        var value = record.attributes[attr];
        if (value !== undefined) {
            utils_1.deepSet(resource, ['attributes', this.resourceAttribute(record.type, attr)], value);
        }
    };
    JSONAPISerializer.prototype.serializeRelationships = function (resource, record) {
        var _this = this;
        if (record.relationships) {
            Object.keys(record.relationships).forEach(function (relationship) {
                _this.serializeRelationship(resource, record, relationship);
            });
        }
    };
    JSONAPISerializer.prototype.serializeRelationship = function (resource, record, relationship) {
        var _this = this;
        var value = record.relationships[relationship].data;
        if (value !== undefined) {
            var data = void 0;
            if (utils_1.isArray(value)) {
                data = value.map(function (id) {
                    return _this.resourceIdentity(id);
                });
            } else if (value !== null) {
                data = this.resourceIdentity(value);
            } else {
                data = null;
            }
            var resourceRelationship = this.resourceRelationship(record.type, relationship);
            utils_1.deepSet(resource, ['relationships', resourceRelationship, 'data'], data);
        }
    };
    JSONAPISerializer.prototype.deserializeDocument = function (document) {
        var result;
        var data = document.data;
        if (utils_1.isArray(data)) {
            result = {
                data: data.map(this.deserializeResource, this)
            };
        } else {
            result = {
                data: this.deserializeResource(data)
            };
        }
        if (document.included) {
            result.included = document.included.map(this.deserializeResource, this);
        }
        return result;
    };
    JSONAPISerializer.prototype.deserializeResource = function (resource) {
        var record;
        var type = this.recordType(resource.type);
        var resourceKey = this.resourceKey(type);
        if (resourceKey === 'id') {
            record = { type: type, id: resource.id };
        } else {
            var id = void 0;
            var keys = void 0;
            if (resource.id) {
                keys = (_a = {}, _a[resourceKey] = resource.id, _a);
                id = this.keyMap.idFromKeys(type, keys) || this.schema.generateId(type);
            } else {
                id = this.schema.generateId(type);
            }
            record = { type: type, id: id };
            if (keys) {
                record.keys = keys;
            }
        }
        this.deserializeAttributes(record, resource);
        this.deserializeRelationships(record, resource);
        if (this.keyMap) {
            this.keyMap.pushRecord(record);
        }
        return record;
        var _a;
    };
    JSONAPISerializer.prototype.deserializeAttributes = function (record, resource) {
        var _this = this;
        if (resource.attributes) {
            Object.keys(resource.attributes).forEach(function (resourceAttribute) {
                var attribute = _this.recordAttribute(record.type, resourceAttribute);
                if (_this.schema.hasAttribute(record.type, attribute)) {
                    var value = resource.attributes[resourceAttribute];
                    _this.deserializeAttribute(record, attribute, value);
                }
            });
        }
    };
    JSONAPISerializer.prototype.deserializeAttribute = function (record, attr, value) {
        record.attributes = record.attributes || {};
        record.attributes[attr] = value;
    };
    JSONAPISerializer.prototype.deserializeRelationships = function (record, resource) {
        var _this = this;
        if (resource.relationships) {
            Object.keys(resource.relationships).forEach(function (resourceRel) {
                var relationship = _this.recordRelationship(record.type, resourceRel);
                if (_this.schema.hasRelationship(record.type, relationship)) {
                    var value = resource.relationships[resourceRel];
                    _this.deserializeRelationship(record, relationship, value);
                }
            });
        }
    };
    JSONAPISerializer.prototype.deserializeRelationship = function (record, relationship, value) {
        var _this = this;
        var resourceData = value.data;
        if (resourceData !== undefined) {
            var data = void 0;
            if (resourceData === null) {
                data = null;
            } else if (utils_1.isArray(resourceData)) {
                data = resourceData.map(function (resourceIdentity) {
                    return _this.recordIdentity(resourceIdentity);
                });
            } else {
                data = this.recordIdentity(resourceData);
            }
            record.relationships = record.relationships || {};
            record.relationships[relationship] = { data: data };
        }
    };
    JSONAPISerializer.prototype._generateNewId = function (type, keyName, keyValue) {
        var id = this.schema.generateId(type);
        this.keyMap.pushRecord({
            type: type,
            id: id,
            keys: (_a = {}, _a[keyName] = keyValue, _a)
        });
        return id;
        var _a;
    };
    return JSONAPISerializer;
}();
exports.default = JSONAPISerializer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoianNvbmFwaS1zZXJpYWxpemVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic3JjL2pzb25hcGktc2VyaWFsaXplci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxzQkFBcUY7QUEyQnJGO0FBSUUsK0JBQVksQUFBbUM7QUFDN0MsQUFBSSxhQUFDLEFBQU8sVUFBRyxBQUFRLFNBQUMsQUFBTSxBQUFDO0FBQy9CLEFBQUksYUFBQyxBQUFPLFVBQUcsQUFBUSxTQUFDLEFBQU0sQUFBQyxBQUNqQztBQUFDO0FBRUQsMEJBQUksNkJBQU07YUFBVjtBQUNFLEFBQU0sbUJBQUMsQUFBSSxLQUFDLEFBQU8sQUFBQyxBQUN0QjtBQUFDOztzQkFBQTs7QUFFRCwwQkFBSSw2QkFBTTthQUFWO0FBQ0UsQUFBTSxtQkFBQyxBQUFJLEtBQUMsQUFBTyxBQUFDLEFBQ3RCO0FBQUM7O3NCQUFBOztBQUVELGdDQUFXLGNBQVgsVUFBWSxBQUFZO0FBQ3RCLEFBQU0sZUFBQyxBQUFJLEFBQUMsQUFDZDtBQUFDO0FBRUQsZ0NBQVksZUFBWixVQUFhLEFBQVk7QUFDdkIsQUFBTSxlQUFDLFFBQVMsVUFBQyxBQUFJLEtBQUMsQUFBTSxPQUFDLEFBQVMsVUFBQyxBQUFJLEFBQUMsQUFBQyxBQUFDLEFBQ2hEO0FBQUM7QUFFRCxnQ0FBb0IsdUJBQXBCLFVBQXFCLEFBQVksTUFBRSxBQUFvQjtBQUNyRCxBQUFNLGVBQUMsUUFBUyxVQUFDLEFBQVksQUFBQyxBQUFDLEFBQ2pDO0FBQUM7QUFFRCxnQ0FBaUIsb0JBQWpCLFVBQWtCLEFBQVksTUFBRSxBQUFZO0FBQzFDLEFBQU0sZUFBQyxRQUFTLFVBQUMsQUFBSSxBQUFDLEFBQUMsQUFDekI7QUFBQztBQUVELGdDQUFnQixtQkFBaEIsVUFBaUIsQUFBd0I7QUFDdkMsQUFBTTtBQUNKLEFBQUksa0JBQUUsQUFBSSxLQUFDLEFBQVksYUFBQyxBQUFRLFNBQUMsQUFBSSxBQUFDO0FBQ3RDLEFBQUUsZ0JBQUUsQUFBSSxL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LEFBQUksdUJBQUssUUFBTyxRQUFDLEFBQVksQUFBQyxBQUFDLGVBQUMsQUFBQztBQUNqQyxBQUFJLG9DQUF3QyxBQUFHLElBQUMsVUFBQSxBQUFnQjtBQUFJLDJCQUFBLEFBQUksTUFBQyxBQUFjLGVBQW5CLEFBQW9CLEFBQWdCLEFBQUM7QUFBQSxBQUFDLEFBQUMsQUFDN0csaUJBRFUsQUFBbUM7QUFDNUMsQUFBQyxBQUFJLGFBRkMsQUFBRSxBQUFDLE1BRUgsQUFBQztBQUNOLEFBQUksdUJBQUcsQUFBSSxLQUFDLEFBQWMsZUFBQyxBQUFnQyxBQUFDLEFBQUMsQUFDL0Q7QUFBQztBQUVELEFBQU0sbUJBQUMsQUFBYSxnQkFBRyxBQUFNLE9BQUMsQUFBYSxpQkFBSSxBQUFFLEFBQUM7QUFDbEQsQUFBTSxtQkFBQyxBQUFhLGNBQUMsQUFBWSxBQUFDLGdCQUFHLEVBQUUsQUFBSSxNQUFBLEFBQUUsQUFBQyxBQUNoRDtBQUFDLEFBQ0g7QUFBQztBQUVTLGdDQUFjLGlCQUF4QixVQUF5QixBQUFZLE1BQUUsQUFBZSxTQUFFLEFBQWdCO0FBQ3RFLFlBQUksQUFBRSxLQUFHLEFBQUksS0FBQyxBQUFNLE9BQUMsQUFBVSxXQUFDLEFBQUksQUFBQyxBQUFDO0FBRXRDLEFBQUksYUFBQyxBQUFNLE9BQUMsQUFBVTtBQUNwQixBQUFJLGtCQUFBO0FBQ0osQUFBRSxnQkFBQTtBQUNGLEFBQUksNEJBQ0YsR0FBQyxBQUFPLFdBQUcsQUFBUSxVQUNwQixBQUNGLEFBQUMsQUFBQztBQU5vQjtBQVF2QixBQUFNLGVBQUMsQUFBRSxBQUFDO1lBQ1o7QUFBQztBQUNILFdBQUEsQUFBQztBQXpSRCxBQXlSQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzQXJyYXksIGlzT2JqZWN0LCBkYXNoZXJpemUsIGNhbWVsaXplLCBkZWVwU2V0LCBEaWN0IH0gZnJvbSAnQG9yYml0L3V0aWxzJztcclxuaW1wb3J0IHtcclxuICBTY2hlbWEsXHJcbiAgS2V5TWFwLFxyXG4gIFJlY29yZCxcclxuICBSZWNvcmRJZGVudGl0eSxcclxuICBSZWNvcmRSZWxhdGlvbnNoaXBcclxufSBmcm9tICdAb3JiaXQvZGF0YSc7XHJcbmltcG9ydCB7XHJcbiAgUmVzb3VyY2UsXHJcbiAgUmVzb3VyY2VJZGVudGl0eSxcclxuICBSZXNvdXJjZUhhc01hbnlSZWxhdGlvbnNoaXAsXHJcbiAgUmVzb3VyY2VIYXNPbmVSZWxhdGlvbnNoaXAsXHJcbiAgUmVzb3VyY2VSZWxhdGlvbnNoaXAsXHJcbiAgSlNPTkFQSURvY3VtZW50XHJcbn0gZnJvbSAnLi9qc29uYXBpLWRvY3VtZW50JztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRGVzZXJpYWxpemVkRG9jdW1lbnQge1xyXG4gIGRhdGE6IFJlY29yZCB8IFJlY29yZFtdXHJcbiAgaW5jbHVkZWQ/OiBSZWNvcmRbXVxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEpTT05BUElTZXJpYWxpemVyU2V0dGluZ3Mge1xyXG4gIHNjaGVtYTogU2NoZW1hO1xyXG4gIGtleU1hcD86IEtleU1hcDtcclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSlNPTkFQSVNlcmlhbGl6ZXIge1xyXG4gIHByb3RlY3RlZCBfc2NoZW1hOiBTY2hlbWE7XHJcbiAgcHJvdGVjdGVkIF9rZXlNYXA6IEtleU1hcDtcclxuXHJcbiAgY29uc3RydWN0b3Ioc2V0dGluZ3M6IEpTT05BUElTZXJpYWxpemVyU2V0dGluZ3MpIHtcclxuICAgIHRoaXMuX3NjaGVtYSA9IHNldHRpbmdzLnNjaGVtYTtcclxuICAgIHRoaXMuX2tleU1hcCA9IHNldHRpbmdzLmtleU1hcDtcclxuICB9XHJcblxyXG4gIGdldCBzY2hlbWEoKTogU2NoZW1hIHtcclxuICAgIHJldHVybiB0aGlzLl9zY2hlbWE7XHJcbiAgfVxyXG5cclxuICBnZXQga2V5TWFwKCk6IEtleU1hcCB7XHJcbiAgICByZXR1cm4gdGhpcy5fa2V5TWFwO1xyXG4gIH1cclxuXHJcbiAgcmVzb3VyY2VLZXkodHlwZTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHJldHVybiAnaWQnO1xyXG4gIH1cclxuXHJcbiAgcmVzb3VyY2VUeXBlKHR5cGU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gZGFzaGVyaXplKHRoaXMuc2NoZW1hLnBsdXJhbGl6ZSh0eXBlKSk7XHJcbiAgfVxyXG5cclxuICByZXNvdXJjZVJlbGF0aW9uc2hpcCh0eXBlOiBzdHJpbmcsIHJlbGF0aW9uc2hpcDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBkYXNoZXJpemUocmVsYXRpb25zaGlwKTtcclxuICB9XHJcblxyXG4gIHJlc291cmNlQXR0cmlidXRlKHR5cGU6IHN0cmluZywgYXR0cjogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBkYXNoZXJpemUoYXR0cik7XHJcbiAgfVxyXG5cclxuICByZXNvdXJjZUlkZW50aXR5KGlkZW50aXR5OiBSZWNvcmRJZGVudGl0eSk6IFJlc291cmNlSWRlbnRpdHkge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdHlwZTogdGhpcy5yZXNvdXJjZVR5cGUoaWRlbnRpdHkudHlwZSksXHJcbiAgICAgIGlkOiB0aGlzLnJlc291cmNlSWQoaWRlbnRpdHkudHlwZSwgaWRlbnRpdHkuaWQpXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcmVzb3VyY2VJZHModHlwZTogc3RyaW5nLCBpZHM6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xyXG4gICAgcmV0dXJuIGlkcy5tYXAoaWQgPT4gdGhpcy5yZXNvdXJjZUlkKHR5cGUsIGlkKSk7XHJcbiAgfVxyXG5cclxuICByZXNvdXJjZUlkKHR5cGU6IHN0cmluZywgaWQ6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBsZXQgcmVzb3VyY2VLZXkgPSB0aGlzLnJlc291cmNlS2V5KHR5cGUpO1xyXG5cclxuICAgIGlmIChyZXNvdXJjZUtleSA9PT0gJ2lkJykge1xyXG4gICAgICByZXR1cm4gaWQ7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdGhpcy5rZXlNYXAuaWRUb0tleSh0eXBlLCByZXNvdXJjZUtleSwgaWQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmVjb3JkSWQodHlwZTogc3RyaW5nLCByZXNvdXJjZUlkOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgbGV0IHJlc291cmNlS2V5ID0gdGhpcy5yZXNvdXJjZUtleSh0eXBlKTtcclxuXHJcbiAgICBpZiAocmVzb3VyY2VLZXkgPT09ICdpZCcpIHtcclxuICAgICAgcmV0dXJuIHJlc291cmNlSWQ7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGV4aXN0aW5nSWQgPSB0aGlzLmtleU1hcC5rZXlUb0lkKHR5cGUsIHJlc291cmNlS2V5LCByZXNvdXJjZUlkKTtcclxuXHJcbiAgICBpZiAoZXhpc3RpbmdJZCkge1xyXG4gICAgICByZXR1cm4gZXhpc3RpbmdJZDtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdGhpcy5fZ2VuZXJhdGVOZXdJZCh0eXBlLCByZXNvdXJjZUtleSwgcmVzb3VyY2VJZCk7XHJcbiAgfVxyXG5cclxuICByZWNvcmRUeXBlKHJlc291cmNlVHlwZTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBjYW1lbGl6ZSh0aGlzLnNjaGVtYS5zaW5ndWxhcml6ZShyZXNvdXJjZVR5cGUpKTtcclxuICB9XHJcblxyXG4gIHJlY29yZElkZW50aXR5KHJlc291cmNlSWRlbnRpdHk6IFJlc291cmNlSWRlbnRpdHkpOiBSZWNvcmRJZGVudGl0eSB7XHJcbiAgICBsZXQgdHlwZSA9IHRoaXMucmVjb3JkVHlwZShyZXNvdXJjZUlkZW50aXR5LnR5cGUpO1xyXG4gICAgbGV0IGlkID0gdGhpcy5yZWNvcmRJZCh0eXBlLCByZXNvdXJjZUlkZW50aXR5LmlkKTtcclxuICAgIHJldHVybiB7IHR5cGUsIGlkIH07XHJcbiAgfVxyXG5cclxuICByZWNvcmRBdHRyaWJ1dGUodHlwZTogc3RyaW5nLCByZXNvdXJjZUF0dHJpYnV0ZTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBjYW1lbGl6ZShyZXNvdXJjZUF0dHJpYnV0ZSk7XHJcbiAgfVxyXG5cclxuICByZWNvcmRSZWxhdGlvbnNoaXAodHlwZTogc3RyaW5nLCByZXNvdXJjZVJlbGF0aW9uc2hpcDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBjYW1lbGl6ZShyZXNvdXJjZVJlbGF0aW9uc2hpcCk7XHJcbiAgfVxyXG5cclxuICBzZXJpYWxpemVEb2N1bWVudChkYXRhOiBSZWNvcmQgfCBSZWNvcmRbXSk6IEpTT05BUElEb2N1bWVudCB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBkYXRhOiBpc0FycmF5KGRhdGEpID8gdGhpcy5zZXJpYWxpemVSZWNvcmRzKDxSZWNvcmRbXT5kYXRhKSA6IHRoaXMuc2VyaWFsaXplUmVjb3JkKDxSZWNvcmQ+ZGF0YSlcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBzZXJpYWxpemVSZWNvcmRzKHJlY29yZHM6IFJlY29yZFtdKTogUmVzb3VyY2VbXSB7XHJcbiAgICByZXR1cm4gcmVjb3Jkcy5tYXAocmVjb3JkID0+IHRoaXMuc2VyaWFsaXplUmVjb3JkKHJlY29yZCkpO1xyXG4gIH1cclxuXHJcbiAgc2VyaWFsaXplUmVjb3JkKHJlY29yZDogUmVjb3JkKTogUmVzb3VyY2Uge1xyXG4gICAgbGV0IHJlc291cmNlOiBSZXNvdXJjZSA9IHtcclxuICAgICAgdHlwZTogdGhpcy5yZXNvdXJjZVR5cGUocmVjb3JkLnR5cGUpXHJcbiAgICB9O1xyXG5cclxuICAgIHRoaXMuc2VyaWFsaXplSWQocmVzb3VyY2UsIHJlY29yZCk7XHJcbiAgICB0aGlzLnNlcmlhbGl6ZUF0dHJpYnV0ZXMocmVzb3VyY2UsIHJlY29yZCk7XHJcbiAgICB0aGlzLnNlcmlhbGl6ZVJlbGF0aW9uc2hpcHMocmVzb3VyY2UsIHJlY29yZCk7XHJcblxyXG4gICAgcmV0dXJuIHJlc291cmNlO1xyXG4gIH1cclxuXHJcbiAgc2VyaWFsaXplSWQocmVzb3VyY2U6IFJlc291cmNlLCByZWNvcmQ6IFJlY29yZElkZW50aXR5KTogdm9pZCB7XHJcbiAgICBsZXQgdmFsdWUgPSB0aGlzLnJlc291cmNlSWQocmVjb3JkLnR5cGUsIHJlY29yZC5pZCk7XHJcbiAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICByZXNvdXJjZS5pZCA9IHZhbHVlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgc2VyaWFsaXplQXR0cmlidXRlcyhyZXNvdXJjZTogUmVzb3VyY2UsIHJlY29yZDogUmVjb3JkKTogdm9pZCB7XHJcbiAgICBpZiAocmVjb3JkLmF0dHJpYnV0ZXMpIHtcclxuICAgICAgT2JqZWN0LmtleXMocmVjb3JkLmF0dHJpYnV0ZXMpLmZvckVhY2goYXR0ciA9PiB7XHJcbiAgICAgICAgdGhpcy5zZXJpYWxpemVBdHRyaWJ1dGUocmVzb3VyY2UsIHJlY29yZCwgYXR0cik7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgc2VyaWFsaXplQXR0cmlidXRlKHJlc291cmNlOiBSZXNvdXJjZSwgcmVjb3JkOiBSZWNvcmQsIGF0dHI6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgbGV0IHZhbHVlOiBhbnkgPSByZWNvcmQuYXR0cmlidXRlc1thdHRyXTtcclxuICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIGRlZXBTZXQocmVzb3VyY2UsIFsnYXR0cmlidXRlcycsIHRoaXMucmVzb3VyY2VBdHRyaWJ1dGUocmVjb3JkLnR5cGUsIGF0dHIpXSwgdmFsdWUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgc2VyaWFsaXplUmVsYXRpb25zaGlwcyhyZXNvdXJjZTogUmVzb3VyY2UsIHJlY29yZDogUmVjb3JkKTogdm9pZCB7XHJcbiAgICBpZiAocmVjb3JkLnJlbGF0aW9uc2hpcHMpIHtcclxuICAgICAgT2JqZWN0LmtleXMocmVjb3JkLnJlbGF0aW9uc2hpcHMpLmZvckVhY2gocmVsYXRpb25zaGlwID0+IHtcclxuICAgICAgICB0aGlzLnNlcmlhbGl6ZVJlbGF0aW9uc2hpcChyZXNvdXJjZSwgcmVjb3JkLCByZWxhdGlvbnNoaXApO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNlcmlhbGl6ZVJlbGF0aW9uc2hpcChyZXNvdXJjZTogUmVzb3VyY2UsIHJlY29yZDogUmVjb3JkLCByZWxhdGlvbnNoaXA6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgY29uc3QgdmFsdWUgPSByZWNvcmQucmVsYXRpb25zaGlwc1tyZWxhdGlvbnNoaXBdLmRhdGE7XHJcblxyXG4gICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgbGV0IGRhdGE7XHJcblxyXG4gICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHtcclxuICAgICAgICBkYXRhID0gKHZhbHVlIGFzIFJlY29yZElkZW50aXR5W10pLm1hcChpZCA9PiB0aGlzLnJlc291cmNlSWRlbnRpdHkoaWQpKTtcclxuICAgICAgfSBlbHNlIGlmICh2YWx1ZSAhPT0gbnVsbCkge1xyXG4gICAgICAgIGRhdGEgPSB0aGlzLnJlc291cmNlSWRlbnRpdHkodmFsdWUgYXMgUmVjb3JkSWRlbnRpdHkpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGRhdGEgPSBudWxsO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCByZXNvdXJjZVJlbGF0aW9uc2hpcCA9IHRoaXMucmVzb3VyY2VSZWxhdGlvbnNoaXAocmVjb3JkLnR5cGUsIHJlbGF0aW9uc2hpcCk7XHJcblxyXG4gICAgICBkZWVwU2V0KHJlc291cmNlLCBbJ3JlbGF0aW9uc2hpcHMnLCByZXNvdXJjZVJlbGF0aW9uc2hpcCwgJ2RhdGEnXSwgZGF0YSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBkZXNlcmlhbGl6ZURvY3VtZW50KGRvY3VtZW50OiBKU09OQVBJRG9jdW1lbnQpOiBEZXNlcmlhbGl6ZWREb2N1bWVudCB7XHJcbiAgICBsZXQgcmVzdWx0OiBEZXNlcmlhbGl6ZWREb2N1bWVudDtcclxuXHJcbiAgICBsZXQgZGF0YSA9IGRvY3VtZW50LmRhdGE7XHJcbiAgICBpZiAoaXNBcnJheShkYXRhKSkge1xyXG4gICAgICByZXN1bHQgPSB7XHJcbiAgICAgICAgZGF0YTogKDxSZXNvdXJjZVtdPmRhdGEpLm1hcCh0aGlzLmRlc2VyaWFsaXplUmVzb3VyY2UsIHRoaXMpXHJcbiAgICAgIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXN1bHQgPSB7XHJcbiAgICAgICAgZGF0YTogdGhpcy5kZXNlcmlhbGl6ZVJlc291cmNlKDxSZXNvdXJjZT5kYXRhKVxyXG4gICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChkb2N1bWVudC5pbmNsdWRlZCkge1xyXG4gICAgICByZXN1bHQuaW5jbHVkZWQgPSBkb2N1bWVudC5pbmNsdWRlZC5tYXAodGhpcy5kZXNlcmlhbGl6ZVJlc291cmNlLCB0aGlzKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgZGVzZXJpYWxpemVSZXNvdXJjZShyZXNvdXJjZTogUmVzb3VyY2UpOiBSZWNvcmQge1xyXG4gICAgbGV0IHJlY29yZDogUmVjb3JkO1xyXG4gICAgbGV0IHR5cGU6IHN0cmluZyA9IHRoaXMucmVjb3JkVHlwZShyZXNvdXJjZS50eXBlKTtcclxuICAgIGxldCByZXNvdXJjZUtleSA9IHRoaXMucmVzb3VyY2VLZXkodHlwZSk7XHJcblxyXG4gICAgaWYgKHJlc291cmNlS2V5ID09PSAnaWQnKSB7XHJcbiAgICAgIHJlY29yZCA9IHsgdHlwZSwgaWQ6IHJlc291cmNlLmlkIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBsZXQgaWQ6IHN0cmluZztcclxuICAgICAgbGV0IGtleXM6IERpY3Q8c3RyaW5nPjtcclxuXHJcbiAgICAgIGlmIChyZXNvdXJjZS5pZCkge1xyXG4gICAgICAgIGtleXMgPSB7XHJcbiAgICAgICAgICBbcmVzb3VyY2VLZXldOiByZXNvdXJjZS5pZFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGlkID0gdGhpcy5rZXlNYXAuaWRGcm9tS2V5cyh0eXBlLCBrZXlzKSB8fFxyXG4gICAgICAgICAgICAgdGhpcy5zY2hlbWEuZ2VuZXJhdGVJZCh0eXBlKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZCA9IHRoaXMuc2NoZW1hLmdlbmVyYXRlSWQodHlwZSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJlY29yZCA9IHsgdHlwZSwgaWQgfTtcclxuXHJcbiAgICAgIGlmIChrZXlzKSB7XHJcbiAgICAgICAgcmVjb3JkLmtleXMgPSBrZXlzO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5kZXNlcmlhbGl6ZUF0dHJpYnV0ZXMocmVjb3JkLCByZXNvdXJjZSk7XHJcbiAgICB0aGlzLmRlc2VyaWFsaXplUmVsYXRpb25zaGlwcyhyZWNvcmQsIHJlc291cmNlKTtcclxuXHJcbiAgICBpZiAodGhpcy5rZXlNYXApIHtcclxuICAgICAgdGhpcy5rZXlNYXAucHVzaFJlY29yZChyZWNvcmQpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiByZWNvcmQ7XHJcbiAgfVxyXG5cclxuICBkZXNlcmlhbGl6ZUF0dHJpYnV0ZXMocmVjb3JkOiBSZWNvcmQsIHJlc291cmNlOiBSZXNvdXJjZSk6IHZvaWQge1xyXG4gICAgaWYgKHJlc291cmNlLmF0dHJpYnV0ZXMpIHtcclxuICAgICAgT2JqZWN0LmtleXMocmVzb3VyY2UuYXR0cmlidXRlcykuZm9yRWFjaChyZXNvdXJjZUF0dHJpYnV0ZSA9PiB7XHJcbiAgICAgICAgbGV0IGF0dHJpYnV0ZSA9IHRoaXMucmVjb3JkQXR0cmlidXRlKHJlY29yZC50eXBlLCByZXNvdXJjZUF0dHJpYnV0ZSk7XHJcbiAgICAgICAgaWYgKHRoaXMuc2NoZW1hLmhhc0F0dHJpYnV0ZShyZWNvcmQudHlwZSwgYXR0cmlidXRlKSkge1xyXG4gICAgICAgICAgbGV0IHZhbHVlID0gcmVzb3VyY2UuYXR0cmlidXRlc1tyZXNvdXJjZUF0dHJpYnV0ZV07XHJcbiAgICAgICAgICB0aGlzLmRlc2VyaWFsaXplQXR0cmlidXRlKHJlY29yZCwgYXR0cmlidXRlLCB2YWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGRlc2VyaWFsaXplQXR0cmlidXRlKHJlY29yZDogUmVjb3JkLCBhdHRyOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB2b2lkIHtcclxuICAgIHJlY29yZC5hdHRyaWJ1dGVzID0gcmVjb3JkLmF0dHJpYnV0ZXMgfHwge307XHJcbiAgICByZWNvcmQuYXR0cmlidXRlc1thdHRyXSA9IHZhbHVlO1xyXG4gIH1cclxuXHJcbiAgZGVzZXJpYWxpemVSZWxhdGlvbnNoaXBzKHJlY29yZDogUmVjb3JkLCByZXNvdXJjZTogUmVzb3VyY2UpOiB2b2lkIHtcclxuICAgIGlmIChyZXNvdXJjZS5yZWxhdGlvbnNoaXBzKSB7XHJcbiAgICAgIE9iamVjdC5rZXlzKHJlc291cmNlLnJlbGF0aW9uc2hpcHMpLmZvckVhY2gocmVzb3VyY2VSZWwgPT4ge1xyXG4gICAgICAgIGxldCByZWxhdGlvbnNoaXAgPSB0aGlzLnJlY29yZFJlbGF0aW9uc2hpcChyZWNvcmQudHlwZSwgcmVzb3VyY2VSZWwpO1xyXG4gICAgICAgIGlmICh0aGlzLnNjaGVtYS5oYXNSZWxhdGlvbnNoaXAocmVjb3JkLnR5cGUsIHJlbGF0aW9uc2hpcCkpIHtcclxuICAgICAgICAgIGxldCB2YWx1ZSA9IHJlc291cmNlLnJlbGF0aW9uc2hpcHNbcmVzb3VyY2VSZWxdO1xyXG4gICAgICAgICAgdGhpcy5kZXNlcmlhbGl6ZVJlbGF0aW9uc2hpcChyZWNvcmQsIHJlbGF0aW9uc2hpcCwgdmFsdWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBkZXNlcmlhbGl6ZVJlbGF0aW9uc2hpcChyZWNvcmQ6IFJlY29yZCwgcmVsYXRpb25zaGlwOiBzdHJpbmcsIHZhbHVlOiBSZXNvdXJjZVJlbGF0aW9uc2hpcCkge1xyXG4gICAgbGV0IHJlc291cmNlRGF0YSA9IHZhbHVlLmRhdGE7XHJcblxyXG4gICAgaWYgKHJlc291cmNlRGF0YSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIGxldCBkYXRhO1xyXG5cclxuICAgICAgaWYgKHJlc291cmNlRGF0YSA9PT0gbnVsbCkge1xyXG4gICAgICAgIGRhdGEgPSBudWxsO1xyXG4gICAgICB9IGVsc2UgaWYgKGlzQXJyYXkocmVzb3VyY2VEYXRhKSkge1xyXG4gICAgICAgIGRhdGEgPSAocmVzb3VyY2VEYXRhIGFzIFJlc291cmNlSWRlbnRpdHlbXSkubWFwKHJlc291cmNlSWRlbnRpdHkgPT4gdGhpcy5yZWNvcmRJZGVudGl0eShyZXNvdXJjZUlkZW50aXR5KSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZGF0YSA9IHRoaXMucmVjb3JkSWRlbnRpdHkocmVzb3VyY2VEYXRhIGFzIFJlc291cmNlSWRlbnRpdHkpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZWNvcmQucmVsYXRpb25zaGlwcyA9IHJlY29yZC5yZWxhdGlvbnNoaXBzIHx8IHt9O1xyXG4gICAgICByZWNvcmQucmVsYXRpb25zaGlwc1tyZWxhdGlvbnNoaXBdID0geyBkYXRhIH07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgX2dlbmVyYXRlTmV3SWQodHlwZTogc3RyaW5nLCBrZXlOYW1lOiBzdHJpbmcsIGtleVZhbHVlOiBzdHJpbmcpIHtcclxuICAgIGxldCBpZCA9IHRoaXMuc2NoZW1hLmdlbmVyYXRlSWQodHlwZSk7XHJcblxyXG4gICAgdGhpcy5rZXlNYXAucHVzaFJlY29yZCh7XHJcbiAgICAgIHR5cGUsXHJcbiAgICAgIGlkLFxyXG4gICAgICBrZXlzOiB7XHJcbiAgICAgICAgW2tleU5hbWVdOiBrZXlWYWx1ZVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gaWQ7XHJcbiAgfVxyXG59XHJcbiJdfQ==