"use strict";

Object.defineProperty(exports, "__esModule", { value: true });
var utils_1 = require("@orbit/utils");
var JSONAPISerializer = function () {
    function JSONAPISerializer(settings) {
        this._schema = settings.schema;
        this._keyMap = settings.keyMap;
    }
    Object.defineProperty(JSONAPISerializer.prototype, "schema", {
        get: function () {
            return this._schema;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(JSONAPISerializer.prototype, "keyMap", {
        get: function () {
            return this._keyMap;
        },
        enumerable: true,
        configurable: true
    });
    JSONAPISerializer.prototype.resourceKey = function (type) {
        return 'id';
    };
    JSONAPISerializer.prototype.resourceType = function (type) {
        return utils_1.dasherize(this.schema.pluralize(type));
    };
    JSONAPISerializer.prototype.resourceRelationship = function (type, relationship) {
        return utils_1.dasherize(relationship);
    };
    JSONAPISerializer.prototype.resourceAttribute = function (type, attr) {
        return utils_1.dasherize(attr);
    };
    JSONAPISerializer.prototype.resourceIdentity = function (identity) {
        return {
            type: this.resourceType(identity.type),
            id: this.resourceId(identity.type, identity.id)
        };
    };
    JSONAPISerializer.prototype.resourceIds = function (type, ids) {
        var _this = this;
        return ids.map(function (id) {
            return _this.resourceId(type, id);
        });
    };
    JSONAPISerializer.prototype.resourceId = function (type, id) {
        var resourceKey = this.resourceKey(type);
        if (resourceKey === 'id') {
            return id;
        } else {
            return this.keyMap.idToKey(type, resourceKey, id);
        }
    };
    JSONAPISerializer.prototype.recordId = function (type, resourceId) {
        var resourceKey = this.resourceKey(type);
        if (resourceKey === 'id') {
            return resourceId;
        }
        var existingId = this.keyMap.keyToId(type, resourceKey, resourceId);
        if (existingId) {
            return existingId;
        }
        return this._generateNewId(type, resourceKey, resourceId);
    };
    JSONAPISerializer.prototype.recordType = function (resourceType) {
        return utils_1.camelize(this.schema.singularize(resourceType));
    };
    JSONAPISerializer.prototype.recordIdentity = function (resourceIdentity) {
        var type = this.recordType(resourceIdentity.type);
        var id = this.recordId(type, resourceIdentity.id);
        return { type: type, id: id };
    };
    JSONAPISerializer.prototype.recordAttribute = function (type, resourceAttribute) {
        return utils_1.camelize(resourceAttribute);
    };
    JSONAPISerializer.prototype.recordRelationship = function (type, resourceRelationship) {
        return utils_1.camelize(resourceRelationship);
    };
    JSONAPISerializer.prototype.serializeDocument = function (data) {
        return {
            data: utils_1.isArray(data) ? this.serializeRecords(data) : this.serializeRecord(data)
        };
    };
    JSONAPISerializer.prototype.serializeRecords = function (records) {
        var _this = this;
        return records.map(function (record) {
            return _this.serializeRecord(record);
        });
    };
    JSONAPISerializer.prototype.serializeRecord = function (record) {
        var resource = {
            type: this.resourceType(record.type)
        };
        this.serializeId(resource, record);
        this.serializeAttributes(resource, record);
        this.serializeRelationships(resource, record);
        return resource;
    };
    JSONAPISerializer.prototype.serializeId = function (resource, record) {
        var value = this.resourceId(record.type, record.id);
        if (value !== undefined) {
            resource.id = value;
        }
    };
    JSONAPISerializer.prototype.serializeAttributes = function (resource, record) {
        var _this = this;
        if (record.attributes) {
            Object.keys(record.attributes).forEach(function (attr) {
                _this.serializeAttribute(resource, record, attr);
            });
        }
    };
    JSONAPISerializer.prototype.serializeAttribute = function (resource, record, attr) {
        var value = record.attributes[attr];
        if (value !== undefined) {
            utils_1.deepSet(resource, ['attributes', this.resourceAttribute(record.type, attr)], value);
        }
    };
    JSONAPISerializer.prototype.serializeRelationships = function (resource, record) {
        var _this = this;
        if (record.relationships) {
            Object.keys(record.relationships).forEach(function (relationship) {
                _this.serializeRelationship(resource, record, relationship);
            });
        }
    };
    JSONAPISerializer.prototype.serializeRelationship = function (resource, record, relationship) {
        var _this = this;
        var value = record.relationships[relationship].data;
        if (value !== undefined) {
            var data = void 0;
            if (utils_1.isArray(value)) {
                data = value.map(function (id) {
                    return _this.resourceIdentity(id);
                });
            } else if (value !== null) {
                data = this.resourceIdentity(value);
            } else {
                data = null;
            }
            var resourceRelationship = this.resourceRelationship(record.type, relationship);
            utils_1.deepSet(resource, ['relationships', resourceRelationship, 'data'], data);
        }
    };
    JSONAPISerializer.prototype.deserializeDocument = function (document) {
        var result;
        var data = document.data;
        if (utils_1.isArray(data)) {
            result = {
                data: data.map(this.deserializeResource, this)
            };
        } else {
            result = {
                data: this.deserializeResource(data)
            };
        }
        if (document.included) {
            result.included = document.included.map(this.deserializeResource, this);
        }
        return result;
    };
    JSONAPISerializer.prototype.deserializeResource = function (resource) {
        var record;
        var type = this.recordType(resource.type);
        var resourceKey = this.resourceKey(type);
        if (resourceKey === 'id') {
            record = { type: type, id: resource.id };
        } else {
            var id = void 0;
            var keys = void 0;
            if (resource.id) {
                keys = (_a = {}, _a[resourceKey] = resource.id, _a);
                id = this.keyMap.idFromKeys(type, keys) || this.schema.generateId(type);
            } else {
                id = this.schema.generateId(type);
            }
            record = { type: type, id: id };
            if (keys) {
                record.keys = keys;
            }
        }
        this.deserializeAttributes(record, resource);
        this.deserializeRelationships(record, resource);
        if (this.keyMap) {
            this.keyMap.pushRecord(record);
        }
        return record;
        var _a;
    };
    JSONAPISerializer.prototype.deserializeAttributes = function (record, resource) {
        var _this = this;
        if (resource.attributes) {
            Object.keys(resource.attributes).forEach(function (resourceAttribute) {
                var value = resource.attributes[resourceAttribute];
                if (value !== undefined) {
                    var attr = _this.recordAttribute(record.type, resourceAttribute);
                    _this.deserializeAttribute(record, attr, value);
                }
            });
        }
    };
    JSONAPISerializer.prototype.deserializeAttribute = function (record, attr, value) {
        record.attributes = record.attributes || {};
        record.attributes[attr] = value;
    };
    JSONAPISerializer.prototype.deserializeRelationships = function (record, resource) {
        var _this = this;
        if (resource.relationships) {
            Object.keys(resource.relationships).forEach(function (resourceRel) {
                var value = resource.relationships[resourceRel];
                if (value !== undefined) {
                    var relationship = _this.recordRelationship(record.type, resourceRel);
                    _this.deserializeRelationship(record, relationship, value);
                }
            });
        }
    };
    JSONAPISerializer.prototype.deserializeRelationship = function (record, relationship, value) {
        var _this = this;
        var resourceData = value.data;
        if (resourceData !== undefined) {
            var data = void 0;
            if (resourceData === null) {
                data = null;
            } else if (utils_1.isArray(resourceData)) {
                data = resourceData.map(function (resourceIdentity) {
                    return _this.recordIdentity(resourceIdentity);
                });
            } else {
                data = this.recordIdentity(resourceData);
            }
            record.relationships = record.relationships || {};
            record.relationships[relationship] = { data: data };
        }
    };
    JSONAPISerializer.prototype._generateNewId = function (type, keyName, keyValue) {
        var id = this.schema.generateId(type);
        this.keyMap.pushRecord({
            type: type,
            id: id,
            keys: (_a = {}, _a[keyName] = keyValue, _a)
        });
        return id;
        var _a;
    };
    return JSONAPISerializer;
}();
exports.default = JSONAPISerializer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoianNvbmFwaS1zZXJpYWxpemVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic3JjL2pzb25hcGktc2VyaWFsaXplci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxzQkFBcUY7QUEyQnJGLG9DQUlFOytCQUFZLEFBQW1DLFVBQzdDLEFBQUk7YUFBQyxBQUFPLFVBQUcsQUFBUSxTQUFDLEFBQU0sQUFBQyxBQUMvQixBQUFJO2FBQUMsQUFBTyxVQUFHLEFBQVEsU0FBQyxBQUFNLEFBQUMsQUFDakMsQUFBQztBQUVEOzBCQUFJLDZCQUFNO2FBQVYsWUFDRSxBQUFNO21CQUFDLEFBQUksS0FBQyxBQUFPLEFBQUMsQUFDdEIsQUFBQzs7O3NCQUFBLEFBRUQ7OzBCQUFJLDZCQUFNO2FBQVYsWUFDRSxBQUFNO21CQUFDLEFBQUksS0FBQyxBQUFPLEFBQUMsQUFDdEIsQUFBQzs7O3NCQUFBLEFBRUQ7O2dDQUFXLGNBQVgsVUFBWSxBQUFZLE1BQ3RCLEFBQU07ZUFBQyxBQUFJLEFBQUMsQUFDZCxBQUFDO0FBRUQ7Z0NBQVksZUFBWixVQUFhLEFBQVksTUFDdkIsQUFBTTtlQUFDLFFBQVMsVUFBQyxBQUFJLEtBQUMsQUFBTSxPQUFDLEFBQVMsVUFBQyxBQUFJLEFBQUMsQUFBQyxBQUFDLEFBQ2hELEFBQUM7QUFFRDtnQ0FBb0IsdUJBQXBCLFVBQXFCLEFBQVksTUFBRSxBQUFvQixjQUNyRCxBQUFNO2VBQUMsUUFBUyxVQUFDLEFBQVksQUFBQyxBQUFDLEFBQ2pDLEFBQUM7QUFFRDtnQ0FBaUIsb0JBQWpCLFVBQWtCLEFBQVksTUFBRSxBQUFZLE1BQzFDLEFBQU07ZUFBQyxRQUFTLFVBQUMsQUFBSSxBQUFDLEFBQUMsQUFDekIsQUFBQztBQUVEO2dDQUFnQixtQkFBaEIsVUFBaUIsQUFBd0IsVUFDdkMsQUFBTTs7a0JBQ0UsQUFBSSxLQUFDLEFBQVksYUFBQyxBQUFRLFNBQUMsQUFBSSxBQUFDLEFBQ3RDLEFBQUU7Z0JBQUUsQUFBSSxLQUFDLEFB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QkFBSTsyQkFBQSxBQUFJLE1BQUMsQUFBYyxlQUFuQixBQUFvQixBQUFnQixBQUFDLEFBQUMsQUFBQyxBQUM3RztBQURVLEFBQW1DLEFBQzVDLEFBQUMsQUFBSTtBQUZDLEFBQUUsQUFBQyxtQkFFSCxBQUFDLEFBQ04sQUFBSTt1QkFBRyxBQUFJLEtBQUMsQUFBYyxlQUFDLEFBQWdDLEFBQUMsQUFBQyxBQUMvRCxBQUFDO0FBRUQsQUFBTTttQkFBQyxBQUFhLGdCQUFHLEFBQU0sT0FBQyxBQUFhLGlCQUFJLEFBQUUsQUFBQyxBQUNsRCxBQUFNO21CQUFDLEFBQWEsY0FBQyxBQUFZLEFBQUMsZ0JBQUcsRUFBRSxBQUFJLE1BQUEsQUFBRSxBQUFDLEFBQ2hELEFBQUMsQUFDSDtBQUFDO0FBRVM7Z0NBQWMsaUJBQXhCLFVBQXlCLEFBQVksTUFBRSxBQUFlLFNBQUUsQUFBZ0IsVUFDdEU7WUFBSSxBQUFFLEtBQUcsQUFBSSxLQUFDLEFBQU0sT0FBQyxBQUFVLFdBQUMsQUFBSSxBQUFDLEFBQUMsQUFFdEMsQUFBSTthQUFDLEFBQU0sT0FBQyxBQUFVO2tCQUNoQixBQUNKLEFBQUU7Z0JBQUEsQUFDRixBQUFJOzRCQUNGLEdBQUMsQUFBTyxXQUFHLEFBQVEsVUFKQSxBQUtwQixBQUNGLEFBQUMsQUFBQyxBQUVILEFBQU07QUFQSixBQUFJO2VBT0MsQUFBRSxBQUFDO1lBQ1osQUFBQztBQUNIO1dBelJBLEFBeVJBLEFBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc0FycmF5LCBpc09iamVjdCwgZGFzaGVyaXplLCBjYW1lbGl6ZSwgZGVlcFNldCwgRGljdCB9IGZyb20gJ0BvcmJpdC91dGlscyc7XHJcbmltcG9ydCB7XHJcbiAgU2NoZW1hLFxyXG4gIEtleU1hcCxcclxuICBSZWNvcmQsXHJcbiAgUmVjb3JkSWRlbnRpdHksXHJcbiAgUmVjb3JkUmVsYXRpb25zaGlwXHJcbn0gZnJvbSAnQG9yYml0L2RhdGEnO1xyXG5pbXBvcnQge1xyXG4gIFJlc291cmNlLFxyXG4gIFJlc291cmNlSWRlbnRpdHksXHJcbiAgUmVzb3VyY2VIYXNNYW55UmVsYXRpb25zaGlwLFxyXG4gIFJlc291cmNlSGFzT25lUmVsYXRpb25zaGlwLFxyXG4gIFJlc291cmNlUmVsYXRpb25zaGlwLFxyXG4gIEpTT05BUElEb2N1bWVudFxyXG59IGZyb20gJy4vanNvbmFwaS1kb2N1bWVudCc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIERlc2VyaWFsaXplZERvY3VtZW50IHtcclxuICBkYXRhOiBSZWNvcmQgfCBSZWNvcmRbXVxyXG4gIGluY2x1ZGVkPzogUmVjb3JkW11cclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBKU09OQVBJU2VyaWFsaXplclNldHRpbmdzIHtcclxuICBzY2hlbWE6IFNjaGVtYTtcclxuICBrZXlNYXA/OiBLZXlNYXA7XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEpTT05BUElTZXJpYWxpemVyIHtcclxuICBwcm90ZWN0ZWQgX3NjaGVtYTogU2NoZW1hO1xyXG4gIHByb3RlY3RlZCBfa2V5TWFwOiBLZXlNYXA7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHNldHRpbmdzOiBKU09OQVBJU2VyaWFsaXplclNldHRpbmdzKSB7XHJcbiAgICB0aGlzLl9zY2hlbWEgPSBzZXR0aW5ncy5zY2hlbWE7XHJcbiAgICB0aGlzLl9rZXlNYXAgPSBzZXR0aW5ncy5rZXlNYXA7XHJcbiAgfVxyXG5cclxuICBnZXQgc2NoZW1hKCk6IFNjaGVtYSB7XHJcbiAgICByZXR1cm4gdGhpcy5fc2NoZW1hO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGtleU1hcCgpOiBLZXlNYXAge1xyXG4gICAgcmV0dXJuIHRoaXMuX2tleU1hcDtcclxuICB9XHJcblxyXG4gIHJlc291cmNlS2V5KHR5cGU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gJ2lkJztcclxuICB9XHJcblxyXG4gIHJlc291cmNlVHlwZSh0eXBlOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIGRhc2hlcml6ZSh0aGlzLnNjaGVtYS5wbHVyYWxpemUodHlwZSkpO1xyXG4gIH1cclxuXHJcbiAgcmVzb3VyY2VSZWxhdGlvbnNoaXAodHlwZTogc3RyaW5nLCByZWxhdGlvbnNoaXA6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gZGFzaGVyaXplKHJlbGF0aW9uc2hpcCk7XHJcbiAgfVxyXG5cclxuICByZXNvdXJjZUF0dHJpYnV0ZSh0eXBlOiBzdHJpbmcsIGF0dHI6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gZGFzaGVyaXplKGF0dHIpO1xyXG4gIH1cclxuXHJcbiAgcmVzb3VyY2VJZGVudGl0eShpZGVudGl0eTogUmVjb3JkSWRlbnRpdHkpOiBSZXNvdXJjZUlkZW50aXR5IHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHR5cGU6IHRoaXMucmVzb3VyY2VUeXBlKGlkZW50aXR5LnR5cGUpLFxyXG4gICAgICBpZDogdGhpcy5yZXNvdXJjZUlkKGlkZW50aXR5LnR5cGUsIGlkZW50aXR5LmlkKVxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHJlc291cmNlSWRzKHR5cGU6IHN0cmluZywgaWRzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcclxuICAgIHJldHVybiBpZHMubWFwKGlkID0+IHRoaXMucmVzb3VyY2VJZCh0eXBlLCBpZCkpO1xyXG4gIH1cclxuXHJcbiAgcmVzb3VyY2VJZCh0eXBlOiBzdHJpbmcsIGlkOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgbGV0IHJlc291cmNlS2V5ID0gdGhpcy5yZXNvdXJjZUtleSh0eXBlKTtcclxuXHJcbiAgICBpZiAocmVzb3VyY2VLZXkgPT09ICdpZCcpIHtcclxuICAgICAgcmV0dXJuIGlkO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHRoaXMua2V5TWFwLmlkVG9LZXkodHlwZSwgcmVzb3VyY2VLZXksIGlkKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJlY29yZElkKHR5cGU6IHN0cmluZywgcmVzb3VyY2VJZDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGxldCByZXNvdXJjZUtleSA9IHRoaXMucmVzb3VyY2VLZXkodHlwZSk7XHJcblxyXG4gICAgaWYgKHJlc291cmNlS2V5ID09PSAnaWQnKSB7XHJcbiAgICAgIHJldHVybiByZXNvdXJjZUlkO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBleGlzdGluZ0lkID0gdGhpcy5rZXlNYXAua2V5VG9JZCh0eXBlLCByZXNvdXJjZUtleSwgcmVzb3VyY2VJZCk7XHJcblxyXG4gICAgaWYgKGV4aXN0aW5nSWQpIHtcclxuICAgICAgcmV0dXJuIGV4aXN0aW5nSWQ7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuX2dlbmVyYXRlTmV3SWQodHlwZSwgcmVzb3VyY2VLZXksIHJlc291cmNlSWQpO1xyXG4gIH1cclxuXHJcbiAgcmVjb3JkVHlwZShyZXNvdXJjZVR5cGU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gY2FtZWxpemUodGhpcy5zY2hlbWEuc2luZ3VsYXJpemUocmVzb3VyY2VUeXBlKSk7XHJcbiAgfVxyXG5cclxuICByZWNvcmRJZGVudGl0eShyZXNvdXJjZUlkZW50aXR5OiBSZXNvdXJjZUlkZW50aXR5KTogUmVjb3JkSWRlbnRpdHkge1xyXG4gICAgbGV0IHR5cGUgPSB0aGlzLnJlY29yZFR5cGUocmVzb3VyY2VJZGVudGl0eS50eXBlKTtcclxuICAgIGxldCBpZCA9IHRoaXMucmVjb3JkSWQodHlwZSwgcmVzb3VyY2VJZGVudGl0eS5pZCk7XHJcbiAgICByZXR1cm4geyB0eXBlLCBpZCB9O1xyXG4gIH1cclxuXHJcbiAgcmVjb3JkQXR0cmlidXRlKHR5cGU6IHN0cmluZywgcmVzb3VyY2VBdHRyaWJ1dGU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gY2FtZWxpemUocmVzb3VyY2VBdHRyaWJ1dGUpO1xyXG4gIH1cclxuXHJcbiAgcmVjb3JkUmVsYXRpb25zaGlwKHR5cGU6IHN0cmluZywgcmVzb3VyY2VSZWxhdGlvbnNoaXA6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gY2FtZWxpemUocmVzb3VyY2VSZWxhdGlvbnNoaXApO1xyXG4gIH1cclxuXHJcbiAgc2VyaWFsaXplRG9jdW1lbnQoZGF0YTogUmVjb3JkIHwgUmVjb3JkW10pOiBKU09OQVBJRG9jdW1lbnQge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgZGF0YTogaXNBcnJheShkYXRhKSA/IHRoaXMuc2VyaWFsaXplUmVjb3Jkcyg8UmVjb3JkW10+ZGF0YSkgOiB0aGlzLnNlcmlhbGl6ZVJlY29yZCg8UmVjb3JkPmRhdGEpXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgc2VyaWFsaXplUmVjb3JkcyhyZWNvcmRzOiBSZWNvcmRbXSk6IFJlc291cmNlW10ge1xyXG4gICAgcmV0dXJuIHJlY29yZHMubWFwKHJlY29yZCA9PiB0aGlzLnNlcmlhbGl6ZVJlY29yZChyZWNvcmQpKTtcclxuICB9XHJcblxyXG4gIHNlcmlhbGl6ZVJlY29yZChyZWNvcmQ6IFJlY29yZCk6IFJlc291cmNlIHtcclxuICAgIGxldCByZXNvdXJjZTogUmVzb3VyY2UgPSB7XHJcbiAgICAgIHR5cGU6IHRoaXMucmVzb3VyY2VUeXBlKHJlY29yZC50eXBlKVxyXG4gICAgfTtcclxuXHJcbiAgICB0aGlzLnNlcmlhbGl6ZUlkKHJlc291cmNlLCByZWNvcmQpO1xyXG4gICAgdGhpcy5zZXJpYWxpemVBdHRyaWJ1dGVzKHJlc291cmNlLCByZWNvcmQpO1xyXG4gICAgdGhpcy5zZXJpYWxpemVSZWxhdGlvbnNoaXBzKHJlc291cmNlLCByZWNvcmQpO1xyXG5cclxuICAgIHJldHVybiByZXNvdXJjZTtcclxuICB9XHJcblxyXG4gIHNlcmlhbGl6ZUlkKHJlc291cmNlOiBSZXNvdXJjZSwgcmVjb3JkOiBSZWNvcmRJZGVudGl0eSk6IHZvaWQge1xyXG4gICAgbGV0IHZhbHVlID0gdGhpcy5yZXNvdXJjZUlkKHJlY29yZC50eXBlLCByZWNvcmQuaWQpO1xyXG4gICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgcmVzb3VyY2UuaWQgPSB2YWx1ZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNlcmlhbGl6ZUF0dHJpYnV0ZXMocmVzb3VyY2U6IFJlc291cmNlLCByZWNvcmQ6IFJlY29yZCk6IHZvaWQge1xyXG4gICAgaWYgKHJlY29yZC5hdHRyaWJ1dGVzKSB7XHJcbiAgICAgIE9iamVjdC5rZXlzKHJlY29yZC5hdHRyaWJ1dGVzKS5mb3JFYWNoKGF0dHIgPT4ge1xyXG4gICAgICAgIHRoaXMuc2VyaWFsaXplQXR0cmlidXRlKHJlc291cmNlLCByZWNvcmQsIGF0dHIpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNlcmlhbGl6ZUF0dHJpYnV0ZShyZXNvdXJjZTogUmVzb3VyY2UsIHJlY29yZDogUmVjb3JkLCBhdHRyOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGxldCB2YWx1ZTogYW55ID0gcmVjb3JkLmF0dHJpYnV0ZXNbYXR0cl07XHJcbiAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICBkZWVwU2V0KHJlc291cmNlLCBbJ2F0dHJpYnV0ZXMnLCB0aGlzLnJlc291cmNlQXR0cmlidXRlKHJlY29yZC50eXBlLCBhdHRyKV0sIHZhbHVlKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNlcmlhbGl6ZVJlbGF0aW9uc2hpcHMocmVzb3VyY2U6IFJlc291cmNlLCByZWNvcmQ6IFJlY29yZCk6IHZvaWQge1xyXG4gICAgaWYgKHJlY29yZC5yZWxhdGlvbnNoaXBzKSB7XHJcbiAgICAgIE9iamVjdC5rZXlzKHJlY29yZC5yZWxhdGlvbnNoaXBzKS5mb3JFYWNoKHJlbGF0aW9uc2hpcCA9PiB7XHJcbiAgICAgICAgdGhpcy5zZXJpYWxpemVSZWxhdGlvbnNoaXAocmVzb3VyY2UsIHJlY29yZCwgcmVsYXRpb25zaGlwKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzZXJpYWxpemVSZWxhdGlvbnNoaXAocmVzb3VyY2U6IFJlc291cmNlLCByZWNvcmQ6IFJlY29yZCwgcmVsYXRpb25zaGlwOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGNvbnN0IHZhbHVlID0gcmVjb3JkLnJlbGF0aW9uc2hpcHNbcmVsYXRpb25zaGlwXS5kYXRhO1xyXG5cclxuICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIGxldCBkYXRhO1xyXG5cclxuICAgICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7XHJcbiAgICAgICAgZGF0YSA9ICh2YWx1ZSBhcyBSZWNvcmRJZGVudGl0eVtdKS5tYXAoaWQgPT4gdGhpcy5yZXNvdXJjZUlkZW50aXR5KGlkKSk7XHJcbiAgICAgIH0gZWxzZSBpZiAodmFsdWUgIT09IG51bGwpIHtcclxuICAgICAgICBkYXRhID0gdGhpcy5yZXNvdXJjZUlkZW50aXR5KHZhbHVlIGFzIFJlY29yZElkZW50aXR5KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBkYXRhID0gbnVsbDtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgcmVzb3VyY2VSZWxhdGlvbnNoaXAgPSB0aGlzLnJlc291cmNlUmVsYXRpb25zaGlwKHJlY29yZC50eXBlLCByZWxhdGlvbnNoaXApO1xyXG5cclxuICAgICAgZGVlcFNldChyZXNvdXJjZSwgWydyZWxhdGlvbnNoaXBzJywgcmVzb3VyY2VSZWxhdGlvbnNoaXAsICdkYXRhJ10sIGRhdGEpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZGVzZXJpYWxpemVEb2N1bWVudChkb2N1bWVudDogSlNPTkFQSURvY3VtZW50KTogRGVzZXJpYWxpemVkRG9jdW1lbnQge1xyXG4gICAgbGV0IHJlc3VsdDogRGVzZXJpYWxpemVkRG9jdW1lbnQ7XHJcblxyXG4gICAgbGV0IGRhdGEgPSBkb2N1bWVudC5kYXRhO1xyXG4gICAgaWYgKGlzQXJyYXkoZGF0YSkpIHtcclxuICAgICAgcmVzdWx0ID0ge1xyXG4gICAgICAgIGRhdGE6ICg8UmVzb3VyY2VbXT5kYXRhKS5tYXAodGhpcy5kZXNlcmlhbGl6ZVJlc291cmNlLCB0aGlzKVxyXG4gICAgICB9O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmVzdWx0ID0ge1xyXG4gICAgICAgIGRhdGE6IHRoaXMuZGVzZXJpYWxpemVSZXNvdXJjZSg8UmVzb3VyY2U+ZGF0YSlcclxuICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZG9jdW1lbnQuaW5jbHVkZWQpIHtcclxuICAgICAgcmVzdWx0LmluY2x1ZGVkID0gZG9jdW1lbnQuaW5jbHVkZWQubWFwKHRoaXMuZGVzZXJpYWxpemVSZXNvdXJjZSwgdGhpcyk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcblxyXG4gIGRlc2VyaWFsaXplUmVzb3VyY2UocmVzb3VyY2U6IFJlc291cmNlKTogUmVjb3JkIHtcclxuICAgIGxldCByZWNvcmQ6IFJlY29yZDtcclxuICAgIGxldCB0eXBlOiBzdHJpbmcgPSB0aGlzLnJlY29yZFR5cGUocmVzb3VyY2UudHlwZSk7XHJcbiAgICBsZXQgcmVzb3VyY2VLZXkgPSB0aGlzLnJlc291cmNlS2V5KHR5cGUpO1xyXG5cclxuICAgIGlmIChyZXNvdXJjZUtleSA9PT0gJ2lkJykge1xyXG4gICAgICByZWNvcmQgPSB7IHR5cGUsIGlkOiByZXNvdXJjZS5pZCB9O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbGV0IGlkOiBzdHJpbmc7XHJcbiAgICAgIGxldCBrZXlzOiBEaWN0PHN0cmluZz47XHJcblxyXG4gICAgICBpZiAocmVzb3VyY2UuaWQpIHtcclxuICAgICAgICBrZXlzID0ge1xyXG4gICAgICAgICAgW3Jlc291cmNlS2V5XTogcmVzb3VyY2UuaWRcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpZCA9IHRoaXMua2V5TWFwLmlkRnJvbUtleXModHlwZSwga2V5cykgfHxcclxuICAgICAgICAgICAgIHRoaXMuc2NoZW1hLmdlbmVyYXRlSWQodHlwZSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaWQgPSB0aGlzLnNjaGVtYS5nZW5lcmF0ZUlkKHR5cGUpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZWNvcmQgPSB7IHR5cGUsIGlkIH07XHJcblxyXG4gICAgICBpZiAoa2V5cykge1xyXG4gICAgICAgIHJlY29yZC5rZXlzID0ga2V5cztcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuZGVzZXJpYWxpemVBdHRyaWJ1dGVzKHJlY29yZCwgcmVzb3VyY2UpO1xyXG4gICAgdGhpcy5kZXNlcmlhbGl6ZVJlbGF0aW9uc2hpcHMocmVjb3JkLCByZXNvdXJjZSk7XHJcblxyXG4gICAgaWYgKHRoaXMua2V5TWFwKSB7XHJcbiAgICAgIHRoaXMua2V5TWFwLnB1c2hSZWNvcmQocmVjb3JkKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcmVjb3JkO1xyXG4gIH1cclxuXHJcbiAgZGVzZXJpYWxpemVBdHRyaWJ1dGVzKHJlY29yZDogUmVjb3JkLCByZXNvdXJjZTogUmVzb3VyY2UpOiB2b2lkIHtcclxuICAgIGlmIChyZXNvdXJjZS5hdHRyaWJ1dGVzKSB7XHJcbiAgICAgIE9iamVjdC5rZXlzKHJlc291cmNlLmF0dHJpYnV0ZXMpLmZvckVhY2gocmVzb3VyY2VBdHRyaWJ1dGUgPT4ge1xyXG4gICAgICAgIHZhciB2YWx1ZSA9IHJlc291cmNlLmF0dHJpYnV0ZXNbcmVzb3VyY2VBdHRyaWJ1dGVdO1xyXG4gICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICBsZXQgYXR0ciA9IHRoaXMucmVjb3JkQXR0cmlidXRlKHJlY29yZC50eXBlLCByZXNvdXJjZUF0dHJpYnV0ZSk7XHJcbiAgICAgICAgICB0aGlzLmRlc2VyaWFsaXplQXR0cmlidXRlKHJlY29yZCwgYXR0ciwgdmFsdWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBkZXNlcmlhbGl6ZUF0dHJpYnV0ZShyZWNvcmQ6IFJlY29yZCwgYXR0cjogc3RyaW5nLCB2YWx1ZTogYW55KTogdm9pZCB7XHJcbiAgICByZWNvcmQuYXR0cmlidXRlcyA9IHJlY29yZC5hdHRyaWJ1dGVzIHx8IHt9O1xyXG4gICAgcmVjb3JkLmF0dHJpYnV0ZXNbYXR0cl0gPSB2YWx1ZTtcclxuICB9XHJcblxyXG4gIGRlc2VyaWFsaXplUmVsYXRpb25zaGlwcyhyZWNvcmQ6IFJlY29yZCwgcmVzb3VyY2U6IFJlc291cmNlKTogdm9pZCB7XHJcbiAgICBpZiAocmVzb3VyY2UucmVsYXRpb25zaGlwcykge1xyXG4gICAgICBPYmplY3Qua2V5cyhyZXNvdXJjZS5yZWxhdGlvbnNoaXBzKS5mb3JFYWNoKHJlc291cmNlUmVsID0+IHtcclxuICAgICAgICBsZXQgdmFsdWU6IFJlc291cmNlUmVsYXRpb25zaGlwID0gcmVzb3VyY2UucmVsYXRpb25zaGlwc1tyZXNvdXJjZVJlbF07XHJcbiAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgIGxldCByZWxhdGlvbnNoaXAgPSB0aGlzLnJlY29yZFJlbGF0aW9uc2hpcChyZWNvcmQudHlwZSwgcmVzb3VyY2VSZWwpO1xyXG4gICAgICAgICAgdGhpcy5kZXNlcmlhbGl6ZVJlbGF0aW9uc2hpcChyZWNvcmQsIHJlbGF0aW9uc2hpcCwgdmFsdWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBkZXNlcmlhbGl6ZVJlbGF0aW9uc2hpcChyZWNvcmQ6IFJlY29yZCwgcmVsYXRpb25zaGlwOiBzdHJpbmcsIHZhbHVlOiBSZXNvdXJjZVJlbGF0aW9uc2hpcCkge1xyXG4gICAgbGV0IHJlc291cmNlRGF0YSA9IHZhbHVlLmRhdGE7XHJcblxyXG4gICAgaWYgKHJlc291cmNlRGF0YSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIGxldCBkYXRhO1xyXG5cclxuICAgICAgaWYgKHJlc291cmNlRGF0YSA9PT0gbnVsbCkge1xyXG4gICAgICAgIGRhdGEgPSBudWxsO1xyXG4gICAgICB9IGVsc2UgaWYgKGlzQXJyYXkocmVzb3VyY2VEYXRhKSkge1xyXG4gICAgICAgIGRhdGEgPSAocmVzb3VyY2VEYXRhIGFzIFJlc291cmNlSWRlbnRpdHlbXSkubWFwKHJlc291cmNlSWRlbnRpdHkgPT4gdGhpcy5yZWNvcmRJZGVudGl0eShyZXNvdXJjZUlkZW50aXR5KSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZGF0YSA9IHRoaXMucmVjb3JkSWRlbnRpdHkocmVzb3VyY2VEYXRhIGFzIFJlc291cmNlSWRlbnRpdHkpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZWNvcmQucmVsYXRpb25zaGlwcyA9IHJlY29yZC5yZWxhdGlvbnNoaXBzIHx8IHt9O1xyXG4gICAgICByZWNvcmQucmVsYXRpb25zaGlwc1tyZWxhdGlvbnNoaXBdID0geyBkYXRhIH07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgX2dlbmVyYXRlTmV3SWQodHlwZTogc3RyaW5nLCBrZXlOYW1lOiBzdHJpbmcsIGtleVZhbHVlOiBzdHJpbmcpIHtcclxuICAgIGxldCBpZCA9IHRoaXMuc2NoZW1hLmdlbmVyYXRlSWQodHlwZSk7XHJcblxyXG4gICAgdGhpcy5rZXlNYXAucHVzaFJlY29yZCh7XHJcbiAgICAgIHR5cGUsXHJcbiAgICAgIGlkLFxyXG4gICAgICBrZXlzOiB7XHJcbiAgICAgICAgW2tleU5hbWVdOiBrZXlWYWx1ZVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gaWQ7XHJcbiAgfVxyXG59XHJcbiJdfQ==