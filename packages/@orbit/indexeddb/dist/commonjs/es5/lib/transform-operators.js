"use strict";

Object.defineProperty(exports, "__esModule", { value: true });
var data_1 = require("@orbit/data");
var utils_1 = require("@orbit/utils");
function getRecord(source, record) {
    return source.getRecord(record).catch(function () {
        return data_1.cloneRecordIdentity(record);
    });
}
exports.default = {
    addRecord: function (source, operation) {
        return source.putRecord(operation.record);
    },
    replaceRecord: function (source, operation) {
        return source.putRecord(operation.record);
    },
    removeRecord: function (source, operation) {
        return source.removeRecord(operation.record);
    },
    replaceKey: function (source, operation) {
        return getRecord(source, operation.record).then(function (record) {
            record.keys = record.keys || {};
            record.keys[operation.key] = operation.value;
            return source.putRecord(record);
        });
    },
    replaceAttribute: function (source, operation) {
        return getRecord(source, operation.record).then(function (record) {
            record.attributes = record.attributes || {};
            record.attributes[operation.attribute] = operation.value;
            return source.putRecord(record);
        });
    },
    addToRelatedRecords: function (source, operation) {
        return getRecord(source, operation.record).then(function (record) {
            var relationships = utils_1.deepGet(record, ['relationships', operation.relationship, 'data']);
            if (relationships) {
                relationships.push(operation.relatedRecord);
            } else {
                utils_1.deepSet(record, ['relationships', operation.relationship, 'data'], [operation.relatedRecord]);
            }
            return source.putRecord(record);
        });
    },
    removeFromRelatedRecords: function (source, operation) {
        return getRecord(source, operation.record).then(function (record) {
            var relationships = utils_1.deepGet(record, ['relationships', operation.relationship, 'data']);
            if (relationships) {
                for (var i = 0, l = relationships.length; i < l; i++) {
                    if (data_1.equalRecordIdentities(relationships[i], operation.relatedRecord)) {
                        relationships.splice(i, 1);
                        break;
                    }
                }
                return source.putRecord(record);
            }
        });
    },
    replaceRelatedRecords: function (source, operation) {
        return getRecord(source, operation.record).then(function (record) {
            utils_1.deepSet(record, ['relationships', operation.relationship, 'data'], operation.relatedRecords);
            return source.putRecord(record);
        });
    },
    replaceRelatedRecord: function (source, operation) {
        return getRecord(source, operation.record).then(function (record) {
            utils_1.deepSet(record, ['relationships', operation.relationship, 'data'], operation.relatedRecord);
            return source.putRecord(record);
        });
    }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNmb3JtLW9wZXJhdG9ycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9saWIvdHJhbnNmb3JtLW9wZXJhdG9ycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxxQkFhcUI7QUFDckIsc0JBR3NCO0FBR3RCLG1CQUFtQixBQUFjLFFBQUUsQUFBc0IsUUFDdkQsQUFBTTtrQkFBUSxBQUFTLFVBQUMsQUFBTSxBQUFDLFFBQzVCLEFBQUssTUFBQyxZQUNMLEFBQU07ZUFBQyxPQUFtQixvQkFBQyxBQUFNLEFBQUMsQUFBQyxBQUNyQyxBQUFDLEFBQUMsQUFBQyxBQUNQO0FBSlMsQUFBTSxBQUlkOztBQUVEO3lCQUNZLEFBQWMsUUFBRSxBQUE2QixXQUNyRCxBQUFNO2VBQUMsQUFBTSxPQUFDLEFBQVMsVUFBQyxBQUFTLFVBQUMsQUFBTSxBQUFDLEFBQUMsQUFDNUMsQUFBQztBQUVELEFBQWE7NkJBQUMsQUFBYyxRQUFFLEFBQWlDLFdBQzdELEFBQU07ZUFBQyxBQUFNLE9BQUMsQUFBUyxVQUFDLEFBQVMsVUFBQyxBQUFNLEFBQUMsQUFBQyxBQUM1QyxBQUFDO0FBRUQsQUFBWTs0QkFBQyxBQUFjLFFBQUUsQUFBZ0MsV0FDM0QsQUFBTTtlQUFDLEFBQU0sT0FBQyxBQUFZLGFBQUMsQUFBUyxVQUFDLEFBQU0sQUFBQyxBQUFDLEFBQy9DLEFBQUM7QUFFRCxBQUFVOzBCQUFDLEFBQWMsUUFBRSxBQUE4QixXQUN2RCxBQUFNO3lCQUFXLEFBQU0sUUFBRSxBQUFTLFVBQUMsQUFBTSxBQUFDLFFBQ3ZDLEFBQUksS0FBQyxVQUFBLEFBQU0sUUFDVixBQUFNO21CQUFDLEFBQUksT0FBRyxBQUFNLE9BQUMsQUFBSSxRQUFJLEFBQUUsQUFBQyxBQUNoQyxBQUFNO21CQUFDLEFBQUksS0FBQyxBQUFTLFVBQUMsQUFBRyxBQUFDLE9BQUcsQUFBUyxVQUFDLEFBQUssQUFBQyxBQUM3QyxBQUFNO21CQUFDLEFBQU0sT0FBQyxBQUFTLFVB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QU07bUJBQUMsQUFBTSxPQUFDLEFBQVMsVUFBQyxBQUFNLEFBQUMsQUFBQyxBQUNsQyxBQUFDLEFBQUMsQUFBQyxBQUNQO0FBTFMsQUFBUyxBQUtqQjtBQUVELEFBQW9CO29DQUFDLEFBQWMsUUFBRSxBQUF3QyxXQUMzRSxBQUFNO3lCQUFXLEFBQU0sUUFBRSxBQUFTLFVBQUMsQUFBTSxBQUFDLFFBQ3ZDLEFBQUksS0FBQyxVQUFBLEFBQU0sUUFDVjtvQkFBTyxRQUFDLEFBQU0sUUFBRSxDQUFDLEFBQWUsaUJBQUUsQUFBUyxVQUFDLEFBQVksY0FBRSxBQUFNLEFBQUMsU0FBRSxBQUFTLFVBQUMsQUFBYSxBQUFDLEFBQUMsQUFDNUYsQUFBTTttQkFBQyxBQUFNLE9BQUMsQUFBUyxVQUFDLEFBQU0sQUFBQyxBQUFDLEFBQ2xDLEFBQUMsQUFBQyxBQUFDLEFBQ1A7QUFMUyxBQUFTLEFBS2pCLEFBQ0YsQUFBQztBQTNFYTtBQUNiLEFBQVMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIGNsb25lUmVjb3JkSWRlbnRpdHksXHJcbiAgZXF1YWxSZWNvcmRJZGVudGl0aWVzLFxyXG4gIFJlY29yZCwgUmVjb3JkSWRlbnRpdHksXHJcbiAgQWRkUmVjb3JkT3BlcmF0aW9uLFxyXG4gIEFkZFRvUmVsYXRlZFJlY29yZHNPcGVyYXRpb24sXHJcbiAgUmVwbGFjZUF0dHJpYnV0ZU9wZXJhdGlvbixcclxuICBSZW1vdmVGcm9tUmVsYXRlZFJlY29yZHNPcGVyYXRpb24sXHJcbiAgUmVtb3ZlUmVjb3JkT3BlcmF0aW9uLFxyXG4gIFJlcGxhY2VSZWxhdGVkUmVjb3Jkc09wZXJhdGlvbixcclxuICBSZXBsYWNlUmVsYXRlZFJlY29yZE9wZXJhdGlvbixcclxuICBSZXBsYWNlS2V5T3BlcmF0aW9uLFxyXG4gIFJlcGxhY2VSZWNvcmRPcGVyYXRpb25cclxufSBmcm9tICdAb3JiaXQvZGF0YSc7XHJcbmltcG9ydCB7XHJcbiAgZGVlcEdldCxcclxuICBkZWVwU2V0XHJcbn0gZnJvbSAnQG9yYml0L3V0aWxzJztcclxuaW1wb3J0IFNvdXJjZSBmcm9tICcuLi9zb3VyY2UnO1xyXG5cclxuZnVuY3Rpb24gZ2V0UmVjb3JkKHNvdXJjZTogU291cmNlLCByZWNvcmQ6IFJlY29yZElkZW50aXR5KTogUHJvbWlzZTxSZWNvcmQ+IHtcclxuICByZXR1cm4gc291cmNlLmdldFJlY29yZChyZWNvcmQpXHJcbiAgICAuY2F0Y2goKCkgPT4ge1xyXG4gICAgICByZXR1cm4gY2xvbmVSZWNvcmRJZGVudGl0eShyZWNvcmQpO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IHtcclxuICBhZGRSZWNvcmQoc291cmNlOiBTb3VyY2UsIG9wZXJhdGlvbjogQWRkUmVjb3JkT3BlcmF0aW9uKSB7XHJcbiAgICByZXR1cm4gc291cmNlLnB1dFJlY29yZChvcGVyYXRpb24ucmVjb3JkKTtcclxuICB9LFxyXG5cclxuICByZXBsYWNlUmVjb3JkKHNvdXJjZTogU291cmNlLCBvcGVyYXRpb246IFJlcGxhY2VSZWNvcmRPcGVyYXRpb24pIHtcclxuICAgIHJldHVybiBzb3VyY2UucHV0UmVjb3JkKG9wZXJhdGlvbi5yZWNvcmQpO1xyXG4gIH0sXHJcblxyXG4gIHJlbW92ZVJlY29yZChzb3VyY2U6IFNvdXJjZSwgb3BlcmF0aW9uOiBSZW1vdmVSZWNvcmRPcGVyYXRpb24pIHtcclxuICAgIHJldHVybiBzb3VyY2UucmVtb3ZlUmVjb3JkKG9wZXJhdGlvbi5yZWNvcmQpO1xyXG4gIH0sXHJcblxyXG4gIHJlcGxhY2VLZXkoc291cmNlOiBTb3VyY2UsIG9wZXJhdGlvbjogUmVwbGFjZUtleU9wZXJhdGlvbikge1xyXG4gICAgcmV0dXJuIGdldFJlY29yZChzb3VyY2UsIG9wZXJhdGlvbi5yZWNvcmQpXHJcbiAgICAgIC50aGVuKHJlY29yZCA9PiB7XHJcbiAgICAgICAgcmVjb3JkLmtleXMgPSByZWNvcmQua2V5cyB8fCB7fTtcclxuICAgICAgICByZWNvcmQua2V5c1tvcGVyYXRpb24ua2V5XSA9IG9wZXJhdGlvbi52YWx1ZTtcclxuICAgICAgICByZXR1cm4gc291cmNlLnB1dFJlY29yZChyZWNvcmQpO1xyXG4gICAgICB9KTtcclxuICB9LFxyXG5cclxuICByZXBsYWNlQXR0cmlidXRlKHNvdXJjZTogU291cmNlLCBvcGVyYXRpb246IFJlcGxhY2VBdHRyaWJ1dGVPcGVyYXRpb24pIHtcclxuICAgIHJldHVybiBnZXRSZWNvcmQoc291cmNlLCBvcGVyYXRpb24ucmVjb3JkKVxyXG4gICAgICAudGhlbihyZWNvcmQgPT4ge1xyXG4gICAgICAgIHJlY29yZC5hdHRyaWJ1dGVzID0gcmVjb3JkLmF0dHJpYnV0ZXMgfHwge307XHJcbiAgICAgICAgcmVjb3JkLmF0dHJpYnV0ZXNbb3BlcmF0aW9uLmF0dHJpYnV0ZV0gPSBvcGVyYXRpb24udmFsdWU7XHJcbiAgICAgICAgcmV0dXJuIHNvdXJjZS5wdXRSZWNvcmQocmVjb3JkKTtcclxuICAgICAgfSk7XHJcbiAgfSxcclxuXHJcbiAgYWRkVG9SZWxhdGVkUmVjb3Jkcyhzb3VyY2U6IFNvdXJjZSwgb3BlcmF0aW9uOiBBZGRUb1JlbGF0ZWRSZWNvcmRzT3BlcmF0aW9uKSB7XHJcbiAgICByZXR1cm4gZ2V0UmVjb3JkKHNvdXJjZSwgb3BlcmF0aW9uLnJlY29yZClcclxuICAgICAgLnRoZW4ocmVjb3JkID0+IHtcclxuICAgICAgICBsZXQgcmVsYXRpb25zaGlwcyA9IGRlZXBHZXQocmVjb3JkLCBbJ3JlbGF0aW9uc2hpcHMnLCBvcGVyYXRpb24ucmVsYXRpb25zaGlwLCAnZGF0YSddKTtcclxuICAgICAgICBpZiAocmVsYXRpb25zaGlwcykge1xyXG4gICAgICAgICAgcmVsYXRpb25zaGlwcy5wdXNoKG9wZXJhdGlvbi5yZWxhdGVkUmVjb3JkKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgZGVlcFNldChyZWNvcmQsIFsncmVsYXRpb25zaGlwcycsIG9wZXJhdGlvbi5yZWxhdGlvbnNoaXAsICdkYXRhJ10sIFtvcGVyYXRpb24ucmVsYXRlZFJlY29yZF0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc291cmNlLnB1dFJlY29yZChyZWNvcmQpO1xyXG4gICAgICB9KTtcclxuICB9LFxyXG5cclxuICByZW1vdmVGcm9tUmVsYXRlZFJlY29yZHMoc291cmNlOiBTb3VyY2UsIG9wZXJhdGlvbjogUmVtb3ZlRnJvbVJlbGF0ZWRSZWNvcmRzT3BlcmF0aW9uKSB7XHJcbiAgICByZXR1cm4gZ2V0UmVjb3JkKHNvdXJjZSwgb3BlcmF0aW9uLnJlY29yZClcclxuICAgICAgLnRoZW4ocmVjb3JkID0+IHtcclxuICAgICAgICBsZXQgcmVsYXRpb25zaGlwcyA9IGRlZXBHZXQocmVjb3JkLCBbJ3JlbGF0aW9uc2hpcHMnLCBvcGVyYXRpb24ucmVsYXRpb25zaGlwLCAnZGF0YSddKSBhcyBSZWNvcmRJZGVudGl0eVtdO1xyXG4gICAgICAgIGlmIChyZWxhdGlvbnNoaXBzKSB7XHJcbiAgICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IHJlbGF0aW9uc2hpcHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmIChlcXVhbFJlY29yZElkZW50aXRpZXMocmVsYXRpb25zaGlwc1tpXSwgb3BlcmF0aW9uLnJlbGF0ZWRSZWNvcmQpKSB7XHJcbiAgICAgICAgICAgICAgcmVsYXRpb25zaGlwcy5zcGxpY2UoaSwgMSk7XHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiBzb3VyY2UucHV0UmVjb3JkKHJlY29yZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICB9LFxyXG5cclxuICByZXBsYWNlUmVsYXRlZFJlY29yZHMoc291cmNlOiBTb3VyY2UsIG9wZXJhdGlvbjogUmVwbGFjZVJlbGF0ZWRSZWNvcmRzT3BlcmF0aW9uKSB7XHJcbiAgICByZXR1cm4gZ2V0UmVjb3JkKHNvdXJjZSwgb3BlcmF0aW9uLnJlY29yZClcclxuICAgICAgLnRoZW4ocmVjb3JkID0+IHtcclxuICAgICAgICBkZWVwU2V0KHJlY29yZCwgWydyZWxhdGlvbnNoaXBzJywgb3BlcmF0aW9uLnJlbGF0aW9uc2hpcCwgJ2RhdGEnXSwgb3BlcmF0aW9uLnJlbGF0ZWRSZWNvcmRzKTtcclxuICAgICAgICByZXR1cm4gc291cmNlLnB1dFJlY29yZChyZWNvcmQpO1xyXG4gICAgICB9KTtcclxuICB9LFxyXG5cclxuICByZXBsYWNlUmVsYXRlZFJlY29yZChzb3VyY2U6IFNvdXJjZSwgb3BlcmF0aW9uOiBSZXBsYWNlUmVsYXRlZFJlY29yZE9wZXJhdGlvbikge1xyXG4gICAgcmV0dXJuIGdldFJlY29yZChzb3VyY2UsIG9wZXJhdGlvbi5yZWNvcmQpXHJcbiAgICAgIC50aGVuKHJlY29yZCA9PiB7XHJcbiAgICAgICAgZGVlcFNldChyZWNvcmQsIFsncmVsYXRpb25zaGlwcycsIG9wZXJhdGlvbi5yZWxhdGlvbnNoaXAsICdkYXRhJ10sIG9wZXJhdGlvbi5yZWxhdGVkUmVjb3JkKTtcclxuICAgICAgICByZXR1cm4gc291cmNlLnB1dFJlY29yZChyZWNvcmQpO1xyXG4gICAgICB9KTtcclxuICB9XHJcbn07XHJcbiJdfQ==