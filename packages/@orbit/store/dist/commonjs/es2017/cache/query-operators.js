"use strict";

Object.defineProperty(exports, "__esModule", { value: true });
var utils_1 = require("@orbit/utils");
var data_1 = require("@orbit/data");
var EMPTY = function () {};
exports.QueryOperators = {
    findRecord: function (cache, expression) {
        var _a = expression.record,
            type = _a.type,
            id = _a.id;
        var record = cache.records(type).get(id);
        if (!record) {
            throw new data_1.RecordNotFoundException(type, id);
        }
        return record;
    },
    findRecords: function (cache, expression) {
        var results = Array.from(cache.records(expression.type).values());
        if (expression.filter) {
            results = filterRecords(results, expression.filter);
        }
        if (expression.sort) {
            results = sortRecords(results, expression.sort);
        }
        if (expression.page) {
            results = paginateRecords(results, expression.page);
        }
        return results;
    },
    findRelatedRecords: function (cache, expression) {
        var record = expression.record,
            relationship = expression.relationship;
        var type = record.type,
            id = record.id;
        var currentRecord = cache.records(type).get(id);
        var data = currentRecord && utils_1.deepGet(currentRecord, ['relationships', relationship, 'data']);
        if (!data) {
            return [];
        }
        return data.map(function (r) {
            return cache.records(r.type).get(r.id);
        });
    },
    findRelatedRecord: function (cache, expression) {
        var record = expression.record,
            relationship = expression.relationship;
        var type = record.type,
            id = record.id;
        var currentRecord = cache.records(type).get(id);
        var data = currentRecord && utils_1.deepGet(currentRecord, ['relationships', relationship, 'data']);
        if (!data) {
            return null;
        }
        var r = data;
        return cache.records(r.type).get(r.id);
    }
};
function filterRecords(records, filters) {
    return records.filter(function (record) {
        for (var i = 0, l = filters.length; i < l; i++) {
            if (!applyFilter(record, filters[i])) {
                return false;
            }
        }
        return true;
    });
}
function applyFilter(record, filter) {
    if (filter.kind === 'attribute') {
        var actual = utils_1.deepGet(record, ['attributes', filter.attribute]);
        var expected = filter.value;
        switch (filter.op) {
            case 'equal':
                return actual === expected;
            case 'gt':
                return actual > expected;
            case 'gte':
                return actual >= expected;
            case 'lt':
                return actual < expected;
            case 'lte':
                return actual <= expected;
            default:
                throw new data_1.QueryExpressionParseError('Filter operation ${filter.op} not recognized for Store.', filter);
        }
    }
    return false;
}
function sortRecords(records, sortSpecifiers) {
    var comparisonValues = new Map();
    records.forEach(function (record) {
        comparisonValues.set(record, sortSpecifiers.map(function (sortSpecifier) {
            if (sortSpecifier.kind === 'attribute') {
                return utils_1.deepGet(record, ['attributes', sortSpecifier.attribute]);
            } else {
                throw new data_1.QueryExpressionParseError('Sort specifier ${sortSpecifier.kind} not recognized for Store.', sortSpecifier);
            }
        }));
    });
    var comparisonOrders = sortSpecifiers.map(function (sortExpression) {
        return sortExpression.order === 'descending' ? -1 : 1;
    });
    return records.sort(function (record1, record2) {
        var values1 = comparisonValues.get(record1);
        var values2 = comparisonValues.get(record2);
        for (var i = 0; i < sortSpecifiers.length; i++) {
            if (values1[i] < values2[i]) {
                return -comparisonOrders[i];
            } else if (values1[i] > values2[i]) {
                return comparisonOrders[i];
            } else if (utils_1.isNone(values1[i]) && !utils_1.isNone(values2[i])) {
                return comparisonOrders[i];
            } else if (utils_1.isNone(values2[i]) && !utils_1.isNone(values1[i])) {
                return -comparisonOrders[i];
            }
        }
        return 0;
    });
}
function paginateRecords(records, paginationOptions) {
    if (paginationOptions.limit !== undefined) {
        var offset = paginationOptions.offset === undefined ? 0 : paginationOptions.offset;
        var limit = paginationOptions.limit;
        return records.slice(offset, offset + limit);
    } else {
        throw new data_1.QueryExpressionParseError('Pagination options not recognized for Store. Please specify `offset` and `limit`.', paginationOptions);
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnktb3BlcmF0b3JzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NhY2hlL3F1ZXJ5LW9wZXJhdG9ycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxzQkFBeUU7QUFDekUscUJBWXFCO0FBR3JCLElBQU0sQUFBSyxRQUFHLFlBQU8sQ0FBQyxBQUFDO0FBVVYsUUFBQSxBQUFjO0FBQ3pCLEFBQVUsMEJBQUMsQUFBWSxPQUFFLEFBQXNCO0FBQ3ZDLFlBQUEsZ0JBQWdDO1lBQTlCLFVBQUk7WUFBRSxRQUFFLEFBQXVCO0FBQ3ZDLFlBQU0sQUFBTSxTQUFHLEFBQUssTUFBQyxBQUFPLFFBQUMsQUFBSSxBQUFDLE1BQUMsQUFBRyxJQUFDLEFBQUUsQUFBQyxBQUFDO0FBRTNDLEFBQUUsQUFBQyxZQUFDLENBQUMsQUFBTSxBQUFDLFFBQUMsQUFBQztBQUNaLGtCQUFNLElBQUksT0FBdUIsd0JBQUMsQUFBSSxNQUFFLEFBQUUsQUFBQyxBQUFDLEFBQzlDO0FBQUM7QUFFRCxBQUFNLGVBQUMsQUFBTSxBQUFDLEFBQ2hCO0FBQUM7QUFFRCxBQUFXLDJCQUFDLEFBQVksT0FBRSxBQUF1QjtBQUMvQyxZQUFJLEFBQU8sVUFBRyxBQUFLLE1BQUMsQUFBSSxLQUFDLEFBQUssTUFBQyxBQUFPLFFBQUMsQUFBVSxXQUFDLEFBQUksQUFBQyxNQUFDLEFBQU0sQUFBRSxBQUFDLEFBQUM7QUFDbEUsQUFBRSxBQUFDLFlBQUMsQUFBVSxXQUFDLEFBQU0sQUFBQyxRQUFDLEFBQUM7QUFDdEIsQUFBTyxzQkFBRyxBQUFhLGNBQUMsQUFBTyxTQUFFLEFBQVUsV0FBQyxBQUFNLEFBQUMsQUFBQyxBQUN0RDtBQUFDO0FBQ0QsQUFBRSxBQUFDLFlBQUMsQUFBVSxXQUFDLEFBQUksQUFBQyxNQUFDLEFBQUM7QUFDcEIsQUFBTyxzQkFBRyxBQUFXLFlBQUMsQUFBTyxTQUFFLEFBQVUsV0FBQyxBQUFJLEFBQUMsQUFBQyxBQUNsRDtBQUFDO0FBQ0Qs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QyxBQUFDLEFBQUMsQUFBQyxPQUFJLENBQUMsUUFBTSxPQUFDLEFBQU8sUUFBQyxBQUFDLEFBQUMsQUFBQyxBQUFDLEtBQUMsQUFBQztBQUNyRCxBQUFNLHVCQUFDLENBQUMsQUFBZ0IsaUJBQUMsQUFBQyxBQUFDLEFBQUMsQUFDOUI7QUFBQyxBQUNIO0FBQUM7QUFDRCxBQUFNLGVBQUMsQUFBQyxBQUFDLEFBQ1g7QUFBQyxBQUFDLEFBQUMsQUFDTCxLQWhCUyxBQUFPO0FBZ0JmO0FBRUQseUJBQXlCLEFBQU8sU0FBRSxBQUFpQjtBQUNqRCxBQUFFLEFBQUMsUUFBQyxBQUFpQixrQkFBQyxBQUFLLFVBQUssQUFBUyxBQUFDLFdBQUMsQUFBQztBQUMxQyxZQUFJLEFBQU0sU0FBRyxBQUFpQixrQkFBQyxBQUFNLFdBQUssQUFBUyxZQUFHLEFBQUMsSUFBRyxBQUFpQixrQkFBQyxBQUFNLEFBQUM7QUFDbkYsWUFBSSxBQUFLLFFBQUcsQUFBaUIsa0JBQUMsQUFBSyxBQUFDO0FBRXBDLEFBQU0sZUFBQyxBQUFPLFFBQUMsQUFBSyxNQUFDLEFBQU0sUUFBRSxBQUFNLFNBQUcsQUFBSyxBQUFDLEFBQUMsQUFFL0M7QUFBQyxBQUFDLEFBQUksV0FBQyxBQUFDO0FBQ04sY0FBTSxJQUFJLE9BQXlCLDBCQUFDLEFBQW1GLHFGQUFFLEFBQWlCLEFBQUMsQUFBQyxBQUM5STtBQUFDLEFBQ0g7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpY3QsIGRlZXBHZXQsIG1lcmdlLCBldmVyeSwgc29tZSwgaXNOb25lIH0gZnJvbSAnQG9yYml0L3V0aWxzJztcclxuaW1wb3J0IHtcclxuICBRdWVyeUV4cHJlc3Npb24sXHJcbiAgUmVjb3JkTm90Rm91bmRFeGNlcHRpb24sXHJcbiAgUXVlcnlFeHByZXNzaW9uUGFyc2VFcnJvcixcclxuICBGaW5kUmVjb3JkLFxyXG4gIEZpbmRSZWNvcmRzLFxyXG4gIEZpbmRSZWxhdGVkUmVjb3JkLFxyXG4gIEZpbmRSZWxhdGVkUmVjb3JkcyxcclxuICBTb3J0U3BlY2lmaWVyLFxyXG4gIEF0dHJpYnV0ZVNvcnRTcGVjaWZpZXIsXHJcbiAgUmVjb3JkLFxyXG4gIFJlY29yZElkZW50aXR5XHJcbn0gZnJvbSAnQG9yYml0L2RhdGEnO1xyXG5pbXBvcnQgQ2FjaGUgZnJvbSAnLi4vY2FjaGUnO1xyXG5cclxuY29uc3QgRU1QVFkgPSAoKSA9PiB7fTtcclxuXHJcbi8qKlxyXG4gKiBAZXhwb3J0XHJcbiAqIEBpbnRlcmZhY2UgUXVlcnlPcGVyYXRvclxyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBRdWVyeU9wZXJhdG9yIHtcclxuICAoY2FjaGU6IENhY2hlLCBleHByZXNzaW9uOiBRdWVyeUV4cHJlc3Npb24pOiBhbnk7XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBRdWVyeU9wZXJhdG9yczogRGljdDxRdWVyeU9wZXJhdG9yPiA9IHtcclxuICBmaW5kUmVjb3JkKGNhY2hlOiBDYWNoZSwgZXhwcmVzc2lvbjogRmluZFJlY29yZCkge1xyXG4gICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gZXhwcmVzc2lvbi5yZWNvcmQ7XHJcbiAgICBjb25zdCByZWNvcmQgPSBjYWNoZS5yZWNvcmRzKHR5cGUpLmdldChpZCk7XHJcblxyXG4gICAgaWYgKCFyZWNvcmQpIHtcclxuICAgICAgdGhyb3cgbmV3IFJlY29yZE5vdEZvdW5kRXhjZXB0aW9uKHR5cGUsIGlkKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcmVjb3JkO1xyXG4gIH0sXHJcblxyXG4gIGZpbmRSZWNvcmRzKGNhY2hlOiBDYWNoZSwgZXhwcmVzc2lvbjogRmluZFJlY29yZHMpIHtcclxuICAgIGxldCByZXN1bHRzID0gQXJyYXkuZnJvbShjYWNoZS5yZWNvcmRzKGV4cHJlc3Npb24udHlwZSkudmFsdWVzKCkpO1xyXG4gICAgaWYgKGV4cHJlc3Npb24uZmlsdGVyKSB7XHJcbiAgICAgIHJlc3VsdHMgPSBmaWx0ZXJSZWNvcmRzKHJlc3VsdHMsIGV4cHJlc3Npb24uZmlsdGVyKTtcclxuICAgIH1cclxuICAgIGlmIChleHByZXNzaW9uLnNvcnQpIHtcclxuICAgICAgcmVzdWx0cyA9IHNvcnRSZWNvcmRzKHJlc3VsdHMsIGV4cHJlc3Npb24uc29ydCk7XHJcbiAgICB9XHJcbiAgICBpZiAoZXhwcmVzc2lvbi5wYWdlKSB7XHJcbiAgICAgIHJlc3VsdHMgPSBwYWdpbmF0ZVJlY29yZHMocmVzdWx0cywgZXhwcmVzc2lvbi5wYWdlKTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHRzO1xyXG4gIH0sXHJcblxyXG4gIGZpbmRSZWxhdGVkUmVjb3JkcyhjYWNoZTogQ2FjaGUsIGV4cHJlc3Npb246IEZpbmRSZWxhdGVkUmVjb3Jkcykge1xyXG4gICAgY29uc3QgeyByZWNvcmQsIHJlbGF0aW9uc2hpcCB9ID0gZXhwcmVzc2lvbjtcclxuICAgIGNvbnN0IHsgdHlwZSwgaWQgfSA9IHJlY29yZDtcclxuICAgIGNvbnN0IGN1cnJlbnRSZWNvcmQgPSBjYWNoZS5yZWNvcmRzKHR5cGUpLmdldChpZCk7XHJcbiAgICBjb25zdCBkYXRhID0gY3VycmVudFJlY29yZCAmJiBkZWVwR2V0KGN1cnJlbnRSZWNvcmQsIFsncmVsYXRpb25zaGlwcycsIHJlbGF0aW9uc2hpcCwgJ2RhdGEnXSk7XHJcblxyXG4gICAgaWYgKCFkYXRhKSB7IHJldHVybiBbXTsgfVxyXG5cclxuICAgIHJldHVybiAoZGF0YSBhcyBSZWNvcmRJZGVudGl0eVtdKS5tYXAociA9PiBjYWNoZS5yZWNvcmRzKHIudHlwZSkuZ2V0KHIuaWQpKTtcclxuICB9LFxyXG5cclxuICBmaW5kUmVsYXRlZFJlY29yZChjYWNoZTogQ2FjaGUsIGV4cHJlc3Npb246IEZpbmRSZWxhdGVkUmVjb3JkKSB7XHJcbiAgICBjb25zdCB7IHJlY29yZCwgcmVsYXRpb25zaGlwIH0gPSBleHByZXNzaW9uO1xyXG4gICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gcmVjb3JkO1xyXG4gICAgY29uc3QgY3VycmVudFJlY29yZCA9IGNhY2hlLnJlY29yZHModHlwZSkuZ2V0KGlkKTtcclxuICAgIGNvbnN0IGRhdGEgPSBjdXJyZW50UmVjb3JkICYmIGRlZXBHZXQoY3VycmVudFJlY29yZCwgWydyZWxhdGlvbnNoaXBzJywgcmVsYXRpb25zaGlwLCAnZGF0YSddKTtcclxuXHJcbiAgICBpZiAoIWRhdGEpIHsgcmV0dXJuIG51bGw7IH1cclxuXHJcbiAgICBjb25zdCByID0gZGF0YSBhcyBSZWNvcmRJZGVudGl0eTtcclxuICAgIHJldHVybiBjYWNoZS5yZWNvcmRzKHIudHlwZSkuZ2V0KHIuaWQpO1xyXG4gIH1cclxufTtcclxuXHJcbmZ1bmN0aW9uIGZpbHRlclJlY29yZHMocmVjb3JkcywgZmlsdGVycykge1xyXG4gIHJldHVybiByZWNvcmRzLmZpbHRlcihyZWNvcmQgPT4ge1xyXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBmaWx0ZXJzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgICBpZiAoIWFwcGx5RmlsdGVyKHJlY29yZCwgZmlsdGVyc1tpXSkpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBhcHBseUZpbHRlcihyZWNvcmQsIGZpbHRlcikge1xyXG4gIGlmIChmaWx0ZXIua2luZCA9PT0gJ2F0dHJpYnV0ZScpIHtcclxuICAgIGxldCBhY3R1YWwgPSBkZWVwR2V0KHJlY29yZCwgWydhdHRyaWJ1dGVzJywgZmlsdGVyLmF0dHJpYnV0ZV0pO1xyXG4gICAgbGV0IGV4cGVjdGVkID0gZmlsdGVyLnZhbHVlO1xyXG4gICAgc3dpdGNoKGZpbHRlci5vcCkge1xyXG4gICAgICBjYXNlICdlcXVhbCc6IHJldHVybiBhY3R1YWwgPT09IGV4cGVjdGVkO1xyXG4gICAgICBjYXNlICdndCc6ICAgIHJldHVybiBhY3R1YWwgPiBleHBlY3RlZDtcclxuICAgICAgY2FzZSAnZ3RlJzogICByZXR1cm4gYWN0dWFsID49IGV4cGVjdGVkO1xyXG4gICAgICBjYXNlICdsdCc6ICAgIHJldHVybiBhY3R1YWwgPCBleHBlY3RlZDtcclxuICAgICAgY2FzZSAnbHRlJzogICByZXR1cm4gYWN0dWFsIDw9IGV4cGVjdGVkO1xyXG4gICAgICBkZWZhdWx0OlxyXG4gICAgICAgIHRocm93IG5ldyBRdWVyeUV4cHJlc3Npb25QYXJzZUVycm9yKCdGaWx0ZXIgb3BlcmF0aW9uICR7ZmlsdGVyLm9wfSBub3QgcmVjb2duaXplZCBmb3IgU3RvcmUuJywgZmlsdGVyKTtcclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIGZhbHNlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzb3J0UmVjb3JkcyhyZWNvcmRzOiBSZWNvcmRbXSwgc29ydFNwZWNpZmllcnM6IFNvcnRTcGVjaWZpZXJbXSkge1xyXG4gIGNvbnN0IGNvbXBhcmlzb25WYWx1ZXMgPSBuZXcgTWFwKCk7XHJcblxyXG4gIHJlY29yZHMuZm9yRWFjaChyZWNvcmQgPT4ge1xyXG4gICAgY29tcGFyaXNvblZhbHVlcy5zZXQoXHJcbiAgICAgIHJlY29yZCxcclxuICAgICAgc29ydFNwZWNpZmllcnMubWFwKHNvcnRTcGVjaWZpZXIgPT4ge1xyXG4gICAgICAgIGlmIChzb3J0U3BlY2lmaWVyLmtpbmQgPT09ICdhdHRyaWJ1dGUnKSB7XHJcbiAgICAgICAgICByZXR1cm4gZGVlcEdldChyZWNvcmQsIFsnYXR0cmlidXRlcycgLCAoPEF0dHJpYnV0ZVNvcnRTcGVjaWZpZXI+c29ydFNwZWNpZmllcikuYXR0cmlidXRlXSlcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXhwcmVzc2lvblBhcnNlRXJyb3IoJ1NvcnQgc3BlY2lmaWVyICR7c29ydFNwZWNpZmllci5raW5kfSBub3QgcmVjb2duaXplZCBmb3IgU3RvcmUuJywgc29ydFNwZWNpZmllcik7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9KTtcclxuXHJcbiAgY29uc3QgY29tcGFyaXNvbk9yZGVycyA9IHNvcnRTcGVjaWZpZXJzLm1hcChcclxuICAgIHNvcnRFeHByZXNzaW9uID0+IHNvcnRFeHByZXNzaW9uLm9yZGVyID09PSAnZGVzY2VuZGluZycgPyAtMSA6IDEpO1xyXG5cclxuICByZXR1cm4gcmVjb3Jkcy5zb3J0KChyZWNvcmQxLCByZWNvcmQyKSA9PiB7XHJcbiAgICBjb25zdCB2YWx1ZXMxID0gY29tcGFyaXNvblZhbHVlcy5nZXQocmVjb3JkMSk7XHJcbiAgICBjb25zdCB2YWx1ZXMyID0gY29tcGFyaXNvblZhbHVlcy5nZXQocmVjb3JkMik7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNvcnRTcGVjaWZpZXJzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGlmICh2YWx1ZXMxW2ldIDwgdmFsdWVzMltpXSkge1xyXG4gICAgICAgIHJldHVybiAtY29tcGFyaXNvbk9yZGVyc1tpXTtcclxuICAgICAgfSBlbHNlIGlmICh2YWx1ZXMxW2ldID4gdmFsdWVzMltpXSkge1xyXG4gICAgICAgIHJldHVybiBjb21wYXJpc29uT3JkZXJzW2ldO1xyXG4gICAgICB9IGVsc2UgaWYgKGlzTm9uZSh2YWx1ZXMxW2ldKSAmJiAhaXNOb25lKHZhbHVlczJbaV0pKSB7XHJcbiAgICAgICAgcmV0dXJuIGNvbXBhcmlzb25PcmRlcnNbaV07XHJcbiAgICAgIH0gZWxzZSBpZiAoaXNOb25lKHZhbHVlczJbaV0pICYmICFpc05vbmUodmFsdWVzMVtpXSkpIHtcclxuICAgICAgICByZXR1cm4gLWNvbXBhcmlzb25PcmRlcnNbaV07XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiAwO1xyXG4gIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwYWdpbmF0ZVJlY29yZHMocmVjb3JkcywgcGFnaW5hdGlvbk9wdGlvbnMpIHtcclxuICBpZiAocGFnaW5hdGlvbk9wdGlvbnMubGltaXQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgbGV0IG9mZnNldCA9IHBhZ2luYXRpb25PcHRpb25zLm9mZnNldCA9PT0gdW5kZWZpbmVkID8gMCA6IHBhZ2luYXRpb25PcHRpb25zLm9mZnNldDtcclxuICAgIGxldCBsaW1pdCA9IHBhZ2luYXRpb25PcHRpb25zLmxpbWl0O1xyXG5cclxuICAgIHJldHVybiByZWNvcmRzLnNsaWNlKG9mZnNldCwgb2Zmc2V0ICsgbGltaXQpO1xyXG5cclxuICB9IGVsc2Uge1xyXG4gICAgdGhyb3cgbmV3IFF1ZXJ5RXhwcmVzc2lvblBhcnNlRXJyb3IoJ1BhZ2luYXRpb24gb3B0aW9ucyBub3QgcmVjb2duaXplZCBmb3IgU3RvcmUuIFBsZWFzZSBzcGVjaWZ5IGBvZmZzZXRgIGFuZCBgbGltaXRgLicsIHBhZ2luYXRpb25PcHRpb25zKTtcclxuICB9XHJcbn1cclxuIl19