"use strict";

Object.defineProperty(exports, "__esModule", { value: true });
var utils_1 = require("@orbit/utils");
var data_1 = require("@orbit/data");
var immutable_1 = require("@orbit/immutable");
var record_identity_map_1 = require("./record-identity-map");
var RelationshipAccessor = function () {
    function RelationshipAccessor(cache, base) {
        this._cache = cache;
        this.reset(base);
    }
    RelationshipAccessor.prototype.reset = function (base) {
        var relationships = {};
        Object.keys(this._cache.schema.models).forEach(function (type) {
            var baseRelationships = base && base._relationships[type];
            relationships[type] = new immutable_1.ImmutableMap(baseRelationships);
        });
        this._relationships = relationships;
    };
    RelationshipAccessor.prototype.upgrade = function () {
        var _this = this;
        Object.keys(this._cache.schema.models).forEach(function (type) {
            if (!_this._relationships[type]) {
                _this._relationships[type] = new immutable_1.ImmutableMap();
            }
        });
    };
    RelationshipAccessor.prototype.relationshipExists = function (record, relationship, relatedRecord) {
        var rels = this._relationships[record.type].get(record.id);
        if (rels) {
            var rel = rels[relationship];
            if (rel) {
                if (rel instanceof record_identity_map_1.default) {
                    return rel.has(relatedRecord);
                } else {
                    return data_1.equalRecordIdentities(relatedRecord, rel);
                }
            }
        }
        return !relatedRecord;
    };
    RelationshipAccessor.prototype.relatedRecord = function (record, relationship) {
        var rels = this._relationships[record.type].get(record.id);
        if (rels) {
            return rels[relationship];
        }
    };
    RelationshipAccessor.prototype.relatedRecords = function (record, relationship) {
        var rels = this._relationships[record.type].get(record.id);
        var map = rels && rels[relationship];
        if (map) {
            return Array.from(map.values);
        }
    };
    RelationshipAccessor.prototype.relatedRecordsMap = function (record, relationship) {
        var rels = this._relationships[record.type].get(record.id);
        if (rels) {
            return rels[relationship];
        }
    };
    RelationshipAccessor.prototype.relatedRecordsMatch = function (record, relationship, relatedRecords) {
        var map = this.relatedRecordsMap(record, relationship);
        if (map) {
            var otherMap_1 = new record_identity_map_1.default();
            relatedRecords.forEach(function (id) {
                return otherMap_1.add(id);
            });
            return map.equals(otherMap_1);
        } else {
            return relatedRecords.length === 0;
        }
    };
    RelationshipAccessor.prototype.addRecord = function (record) {
        if (record.relationships) {
            var rels_1 = {};
            Object.keys(record.relationships).forEach(function (name) {
                var rel = record.relationships[name];
                if (rel.data !== undefined) {
                    if (utils_1.isArray(rel.data)) {
                        var relMap_1 = rels_1[name] = new record_identity_map_1.default();
                        rel.data.forEach(function (r) {
                            return relMap_1.add(r);
                        });
                    } else {
                        rels_1[name] = rel.data;
                    }
                }
            });
            this._relationships[record.type].set(record.id, rels_1);
        }
    };
    RelationshipAccessor.prototype.replaceRecord = function (record) {
        this.addRecord(record);
    };
    RelationshipAccessor.prototype.clearRecord = function (record) {
        this._relationships[record.type].remove(record.id);
    };
    RelationshipAccessor.prototype.addToRelatedRecords = function (record, relationship, relatedRecord) {
        var currentRels = this._relationships[record.type].get(record.id);
        var rels = currentRels ? cloneRelationships(currentRels) : {};
        var rel = rels[relationship];
        if (!rel) {
            rel = rels[relationship] = new record_identity_map_1.default();
        }
        rel.add(relatedRecord);
        this._relationships[record.type].set(record.id, rels);
    };
    RelationshipAccessor.prototype.removeFromRelatedRecords = function (record, relationship, relatedRecord) {
        var currentRels = this._relationships[record.type].get(record.id);
        if (currentRels && currentRels[relationship]) {
            var rels = cloneRelationships(currentRels);
            var rel = rels[relationship];
            rel.remove(relatedRecord);
            this._relationships[record.type].set(record.id, rels);
        }
    };
    RelationshipAccessor.prototype.replaceRelatedRecords = function (record, relationship, relatedRecords) {
        var currentRels = this._relationships[record.type].get(record.id);
        var rels = currentRels ? cloneRelationships(currentRels) : {};
        var rel = rels[relationship];
        if (!rel) {
            rel = rels[relationship] = new record_identity_map_1.default();
        }
        relatedRecords.forEach(function (relatedRecord) {
            return rel.add(relatedRecord);
        });
        this._relationships[record.type].set(record.id, rels);
    };
    RelationshipAccessor.prototype.replaceRelatedRecord = function (record, relationship, relatedRecord) {
        var currentRels = this._relationships[record.type].get(record.id);
        if (currentRels && currentRels[relationship] || relatedRecord) {
            var rels = currentRels ? cloneRelationships(currentRels) : {};
            rels[relationship] = relatedRecord;
            this._relationships[record.type].set(record.id, rels);
        }
    };
    return RelationshipAccessor;
}();
exports.default = RelationshipAccessor;
function cloneRelationships(rels) {
    var clonedRels = {};
    if (rels) {
        Object.keys(rels).forEach(function (name) {
            var value = rels[name];
            if (value instanceof record_identity_map_1.default) {
                clonedRels[name] = new record_identity_map_1.default(value);
            } else {
                clonedRels[name] = value;
            }
        });
    }
    return clonedRels;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVsYXRpb25zaGlwLWFjY2Vzc29yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NhY2hlL3JlbGF0aW9uc2hpcC1hY2Nlc3Nvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxzQkFBOEQ7QUFDOUQscUJBSXFCO0FBRXJCLDBCQUFnRDtBQUNoRCxvQ0FBc0Q7QUFFdEQ7QUFJRSxrQ0FBWSxBQUFZLE9BQUUsQUFBMkI7QUFDbkQsQUFBSSxhQUFDLEFBQU0sU0FBRyxBQUFLLEFBQUM7QUFDcEIsQUFBSSxhQUFDLEFBQUssTUFBQyxBQUFJLEFBQUMsQUFBQyxBQUNuQjtBQUFDO0FBRUQsbUNBQUssUUFBTCxVQUFNLEFBQTJCO0FBQy9CLFlBQUksQUFBYSxnQkFBRyxBQUFFLEFBQUM7QUFDdkIsQUFBTSxlQUFDLEFBQUksS0FBQyxBQUFJLEtBQUMsQUFBTSxPQUFDLEFBQU0sT0FBQyxBQUFNLEFBQUMsUUFBQyxBQUFPLFFBQUMsVUFBQSxBQUFJO0FBQ2pELGdCQUFJLEFBQWlCLG9CQUFHLEFBQUksUUFBSSxBQUFJLEtBQUMsQUFBYyxlQUFDLEFBQUksQUFBQyxBQUFDO0FBQzFELEFBQWEsMEJBQUMsQUFBSSxBQUFDLFFBQUcsSUFBSSxZQUFZLGFBQUMsQUFBaUIsQUFBQyxBQUFDLEFBQzVEO0FBQUMsQUFBQyxBQUFDO0FBQ0gsQUFBSSxhQUFDLEFBQWMsaUJBQUcsQUFBYSxBQUFDLEFBQ3RDO0FBQUM7QUFFRCxtQ0FBTyxVQUFQO0FBQUEsb0JBTUM7QUFMQyxBQUFNLGVBQUMsQUFBSSxLQUFDLEFBQUksS0FBQyxBQUFNLE9BQUMsQUFBTSxPQUFDLEFBQU0sQUFBQyxRQUFDLEFBQU8sUUFBQyxVQUFBLEFBQUk7QUFDakQsQUFBRSxBQUFDLGdCQUFDLENBQUMsQUFBSSxNQUFDLEFBQWMsZUFBQyxBQUFJLEFBQUMsQUFBQyxPQUFDLEFBQUM7QUFDL0IsQUFBSSxzQkFBQyxBQUFjLGVBQUMsQUFBSSxBQUFDLFFBQUcsSUFBSSxZ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QVUsQUFBQyxBQUNwQjtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY2xvbmUsIERpY3QsIGlzT2JqZWN0LCBpc0FycmF5IH0gZnJvbSAnQG9yYml0L3V0aWxzJztcclxuaW1wb3J0IHtcclxuICBlcXVhbFJlY29yZElkZW50aXRpZXMsXHJcbiAgUmVjb3JkLFxyXG4gIFJlY29yZElkZW50aXR5XHJcbn0gZnJvbSAnQG9yYml0L2RhdGEnO1xyXG5pbXBvcnQgQ2FjaGUgZnJvbSAnLi4vY2FjaGUnO1xyXG5pbXBvcnQgeyBJbW11dGFibGVNYXAgfSBmcm9tICdAb3JiaXQvaW1tdXRhYmxlJztcclxuaW1wb3J0IFJlY29yZElkZW50aXR5TWFwIGZyb20gJy4vcmVjb3JkLWlkZW50aXR5LW1hcCc7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSZWxhdGlvbnNoaXBBY2Nlc3NvciB7XHJcbiAgcHJvdGVjdGVkIF9jYWNoZTogQ2FjaGU7XHJcbiAgcHJvdGVjdGVkIF9yZWxhdGlvbnNoaXBzOiBEaWN0PEltbXV0YWJsZU1hcDxzdHJpbmcsIERpY3Q8UmVjb3JkSWRlbnRpdHkgfCBSZWNvcmRJZGVudGl0eU1hcD4+PjtcclxuXHJcbiAgY29uc3RydWN0b3IoY2FjaGU6IENhY2hlLCBiYXNlPzogUmVsYXRpb25zaGlwQWNjZXNzb3IpIHtcclxuICAgIHRoaXMuX2NhY2hlID0gY2FjaGU7XHJcbiAgICB0aGlzLnJlc2V0KGJhc2UpO1xyXG4gIH1cclxuXHJcbiAgcmVzZXQoYmFzZT86IFJlbGF0aW9uc2hpcEFjY2Vzc29yKSB7XHJcbiAgICBsZXQgcmVsYXRpb25zaGlwcyA9IHt9O1xyXG4gICAgT2JqZWN0LmtleXModGhpcy5fY2FjaGUuc2NoZW1hLm1vZGVscykuZm9yRWFjaCh0eXBlID0+IHtcclxuICAgICAgbGV0IGJhc2VSZWxhdGlvbnNoaXBzID0gYmFzZSAmJiBiYXNlLl9yZWxhdGlvbnNoaXBzW3R5cGVdO1xyXG4gICAgICByZWxhdGlvbnNoaXBzW3R5cGVdID0gbmV3IEltbXV0YWJsZU1hcChiYXNlUmVsYXRpb25zaGlwcyk7XHJcbiAgICB9KTtcclxuICAgIHRoaXMuX3JlbGF0aW9uc2hpcHMgPSByZWxhdGlvbnNoaXBzO1xyXG4gIH1cclxuXHJcbiAgdXBncmFkZSgpIHtcclxuICAgIE9iamVjdC5rZXlzKHRoaXMuX2NhY2hlLnNjaGVtYS5tb2RlbHMpLmZvckVhY2godHlwZSA9PiB7XHJcbiAgICAgIGlmICghdGhpcy5fcmVsYXRpb25zaGlwc1t0eXBlXSkge1xyXG4gICAgICAgIHRoaXMuX3JlbGF0aW9uc2hpcHNbdHlwZV0gPSBuZXcgSW1tdXRhYmxlTWFwKCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcmVsYXRpb25zaGlwRXhpc3RzKHJlY29yZDogUmVjb3JkSWRlbnRpdHksIHJlbGF0aW9uc2hpcDogc3RyaW5nLCByZWxhdGVkUmVjb3JkOiBSZWNvcmRJZGVudGl0eSk6IGJvb2xlYW4ge1xyXG4gICAgbGV0IHJlbHMgPSB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5nZXQocmVjb3JkLmlkKTtcclxuICAgIGlmIChyZWxzKSB7XHJcbiAgICAgIGxldCByZWwgPSByZWxzW3JlbGF0aW9uc2hpcF07XHJcbiAgICAgIGlmIChyZWwpIHtcclxuICAgICAgICBpZiAocmVsIGluc3RhbmNlb2YgUmVjb3JkSWRlbnRpdHlNYXApIHtcclxuICAgICAgICAgIHJldHVybiByZWwuaGFzKHJlbGF0ZWRSZWNvcmQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gZXF1YWxSZWNvcmRJZGVudGl0aWVzKHJlbGF0ZWRSZWNvcmQsIHJlbCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gIXJlbGF0ZWRSZWNvcmQ7XHJcbiAgfVxyXG5cclxuICByZWxhdGVkUmVjb3JkKHJlY29yZDogUmVjb3JkSWRlbnRpdHksIHJlbGF0aW9uc2hpcDogc3RyaW5nKTogUmVjb3JkSWRlbnRpdHkge1xyXG4gICAgbGV0IHJlbHMgPSB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5nZXQocmVjb3JkLmlkKTtcclxuICAgIGlmIChyZWxzKSB7XHJcbiAgICAgIHJldHVybiByZWxzW3JlbGF0aW9uc2hpcF0gYXMgUmVjb3JkSWRlbnRpdHk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZWxhdGVkUmVjb3JkcyhyZWNvcmQ6IFJlY29yZElkZW50aXR5LCByZWxhdGlvbnNoaXA6IHN0cmluZyk6IFJlY29yZElkZW50aXR5W10ge1xyXG4gICAgbGV0IHJlbHMgPSB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5nZXQocmVjb3JkLmlkKTtcclxuICAgIGxldCBtYXAgPSByZWxzICYmIHJlbHNbcmVsYXRpb25zaGlwXSBhcyBSZWNvcmRJZGVudGl0eU1hcDtcclxuICAgIGlmIChtYXApIHtcclxuICAgICAgcmV0dXJuIEFycmF5LmZyb20obWFwLnZhbHVlcyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZWxhdGVkUmVjb3Jkc01hcChyZWNvcmQ6IFJlY29yZElkZW50aXR5LCByZWxhdGlvbnNoaXA6IHN0cmluZyk6IFJlY29yZElkZW50aXR5TWFwIHtcclxuICAgIGxldCByZWxzID0gdGhpcy5fcmVsYXRpb25zaGlwc1tyZWNvcmQudHlwZV0uZ2V0KHJlY29yZC5pZCk7XHJcbiAgICBpZiAocmVscykge1xyXG4gICAgICByZXR1cm4gcmVsc1tyZWxhdGlvbnNoaXBdIGFzIFJlY29yZElkZW50aXR5TWFwO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmVsYXRlZFJlY29yZHNNYXRjaChyZWNvcmQ6IFJlY29yZElkZW50aXR5LCByZWxhdGlvbnNoaXA6IHN0cmluZywgcmVsYXRlZFJlY29yZHM6IFJlY29yZElkZW50aXR5W10pOiBib29sZWFuIHtcclxuICAgIGxldCBtYXAgPSB0aGlzLnJlbGF0ZWRSZWNvcmRzTWFwKHJlY29yZCwgcmVsYXRpb25zaGlwKTtcclxuICAgIGlmIChtYXApIHtcclxuICAgICAgbGV0IG90aGVyTWFwID0gbmV3IFJlY29yZElkZW50aXR5TWFwO1xyXG4gICAgICByZWxhdGVkUmVjb3Jkcy5mb3JFYWNoKGlkID0+IG90aGVyTWFwLmFkZChpZCkpO1xyXG4gICAgICByZXR1cm4gbWFwLmVxdWFscyhvdGhlck1hcCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gcmVsYXRlZFJlY29yZHMubGVuZ3RoID09PSAwO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYWRkUmVjb3JkKHJlY29yZDogUmVjb3JkKSB7XHJcbiAgICBpZiAocmVjb3JkLnJlbGF0aW9uc2hpcHMpIHtcclxuICAgICAgY29uc3QgcmVscyA9IHt9O1xyXG4gICAgICBPYmplY3Qua2V5cyhyZWNvcmQucmVsYXRpb25zaGlwcykuZm9yRWFjaChuYW1lID0+IHtcclxuICAgICAgICBsZXQgcmVsID0gcmVjb3JkLnJlbGF0aW9uc2hpcHNbbmFtZV07XHJcbiAgICAgICAgaWYgKHJlbC5kYXRhICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgIGlmIChpc0FycmF5KHJlbC5kYXRhKSkge1xyXG4gICAgICAgICAgICBsZXQgcmVsTWFwID0gcmVsc1tuYW1lXSA9IG5ldyBSZWNvcmRJZGVudGl0eU1hcCgpO1xyXG4gICAgICAgICAgICAocmVsLmRhdGEgYXMgUmVjb3JkSWRlbnRpdHlbXSkuZm9yRWFjaChyID0+IHJlbE1hcC5hZGQocikpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmVsc1tuYW1lXSA9IHJlbC5kYXRhO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIHRoaXMuX3JlbGF0aW9uc2hpcHNbcmVjb3JkLnR5cGVdLnNldChyZWNvcmQuaWQsIHJlbHMpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmVwbGFjZVJlY29yZChyZWNvcmQ6IFJlY29yZCkge1xyXG4gICAgdGhpcy5hZGRSZWNvcmQocmVjb3JkKTtcclxuICB9XHJcblxyXG4gIGNsZWFyUmVjb3JkKHJlY29yZDogUmVjb3JkSWRlbnRpdHkpOiB2b2lkIHtcclxuICAgIHRoaXMuX3JlbGF0aW9uc2hpcHNbcmVjb3JkLnR5cGVdLnJlbW92ZShyZWNvcmQuaWQpO1xyXG4gIH1cclxuXHJcbiAgYWRkVG9SZWxhdGVkUmVjb3JkcyhyZWNvcmQ6IFJlY29yZElkZW50aXR5LCByZWxhdGlvbnNoaXA6IHN0cmluZywgcmVsYXRlZFJlY29yZDogUmVjb3JkSWRlbnRpdHkpOiB2b2lkIHtcclxuICAgIGxldCBjdXJyZW50UmVscyA9IHRoaXMuX3JlbGF0aW9uc2hpcHNbcmVjb3JkLnR5cGVdLmdldChyZWNvcmQuaWQpO1xyXG4gICAgbGV0IHJlbHMgPSBjdXJyZW50UmVscyA/IGNsb25lUmVsYXRpb25zaGlwcyhjdXJyZW50UmVscykgOiB7fTtcclxuICAgIGxldCByZWwgPSByZWxzW3JlbGF0aW9uc2hpcF07XHJcbiAgICBpZiAoIXJlbCkge1xyXG4gICAgICByZWwgPSByZWxzW3JlbGF0aW9uc2hpcF0gPSBuZXcgUmVjb3JkSWRlbnRpdHlNYXAoKTtcclxuICAgIH1cclxuICAgIHJlbC5hZGQocmVsYXRlZFJlY29yZCk7XHJcbiAgICB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5zZXQocmVjb3JkLmlkLCByZWxzKTtcclxuICB9XHJcblxyXG4gIHJlbW92ZUZyb21SZWxhdGVkUmVjb3JkcyhyZWNvcmQ6IFJlY29yZElkZW50aXR5LCByZWxhdGlvbnNoaXA6IHN0cmluZywgcmVsYXRlZFJlY29yZDogUmVjb3JkSWRlbnRpdHkpOiB2b2lkIHtcclxuICAgIGxldCBjdXJyZW50UmVscyA9IHRoaXMuX3JlbGF0aW9uc2hpcHNbcmVjb3JkLnR5cGVdLmdldChyZWNvcmQuaWQpO1xyXG4gICAgaWYgKGN1cnJlbnRSZWxzICYmIGN1cnJlbnRSZWxzW3JlbGF0aW9uc2hpcF0pIHtcclxuICAgICAgbGV0IHJlbHMgPSBjbG9uZVJlbGF0aW9uc2hpcHMoY3VycmVudFJlbHMpO1xyXG4gICAgICBsZXQgcmVsID0gcmVsc1tyZWxhdGlvbnNoaXBdO1xyXG4gICAgICByZWwucmVtb3ZlKHJlbGF0ZWRSZWNvcmQpO1xyXG4gICAgICB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5zZXQocmVjb3JkLmlkLCByZWxzKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJlcGxhY2VSZWxhdGVkUmVjb3JkcyhyZWNvcmQ6IFJlY29yZElkZW50aXR5LCByZWxhdGlvbnNoaXA6IHN0cmluZywgcmVsYXRlZFJlY29yZHM6IFJlY29yZElkZW50aXR5W10pOiB2b2lkIHtcclxuICAgIGxldCBjdXJyZW50UmVscyA9IHRoaXMuX3JlbGF0aW9uc2hpcHNbcmVjb3JkLnR5cGVdLmdldChyZWNvcmQuaWQpO1xyXG4gICAgbGV0IHJlbHMgPSBjdXJyZW50UmVscyA/IGNsb25lUmVsYXRpb25zaGlwcyhjdXJyZW50UmVscykgOiB7fTtcclxuICAgIGxldCByZWwgPSByZWxzW3JlbGF0aW9uc2hpcF07XHJcbiAgICBpZiAoIXJlbCkge1xyXG4gICAgICByZWwgPSByZWxzW3JlbGF0aW9uc2hpcF0gPSBuZXcgUmVjb3JkSWRlbnRpdHlNYXAoKTtcclxuICAgIH1cclxuICAgIHJlbGF0ZWRSZWNvcmRzLmZvckVhY2gocmVsYXRlZFJlY29yZCA9PiByZWwuYWRkKHJlbGF0ZWRSZWNvcmQpKTtcclxuICAgIHRoaXMuX3JlbGF0aW9uc2hpcHNbcmVjb3JkLnR5cGVdLnNldChyZWNvcmQuaWQsIHJlbHMpO1xyXG4gIH1cclxuXHJcbiAgcmVwbGFjZVJlbGF0ZWRSZWNvcmQocmVjb3JkOiBSZWNvcmRJZGVudGl0eSwgcmVsYXRpb25zaGlwOiBzdHJpbmcsIHJlbGF0ZWRSZWNvcmQ6IFJlY29yZElkZW50aXR5KTogdm9pZCB7XHJcbiAgICBsZXQgY3VycmVudFJlbHMgPSB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5nZXQocmVjb3JkLmlkKTtcclxuICAgIGlmICgoY3VycmVudFJlbHMgJiYgY3VycmVudFJlbHNbcmVsYXRpb25zaGlwXSkgfHwgcmVsYXRlZFJlY29yZCkge1xyXG4gICAgICBsZXQgcmVscyA9IGN1cnJlbnRSZWxzID8gY2xvbmVSZWxhdGlvbnNoaXBzKGN1cnJlbnRSZWxzKSA6IHt9O1xyXG4gICAgICByZWxzW3JlbGF0aW9uc2hpcF0gPSByZWxhdGVkUmVjb3JkO1xyXG4gICAgICB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5zZXQocmVjb3JkLmlkLCByZWxzKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNsb25lUmVsYXRpb25zaGlwcyhyZWxzKSB7XHJcbiAgY29uc3QgY2xvbmVkUmVscyA9IHt9O1xyXG4gIGlmIChyZWxzKSB7XHJcbiAgICBPYmplY3Qua2V5cyhyZWxzKS5mb3JFYWNoKG5hbWUgPT4ge1xyXG4gICAgICBsZXQgdmFsdWUgPSByZWxzW25hbWVdO1xyXG4gICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBSZWNvcmRJZGVudGl0eU1hcCkge1xyXG4gICAgICAgIGNsb25lZFJlbHNbbmFtZV0gPSBuZXcgUmVjb3JkSWRlbnRpdHlNYXAodmFsdWUgYXMgUmVjb3JkSWRlbnRpdHlNYXApO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNsb25lZFJlbHNbbmFtZV0gPSB2YWx1ZTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHJldHVybiBjbG9uZWRSZWxzO1xyXG59XHJcbiJdfQ==