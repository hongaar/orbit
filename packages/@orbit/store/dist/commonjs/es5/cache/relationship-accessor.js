"use strict";

Object.defineProperty(exports, "__esModule", { value: true });
var utils_1 = require("@orbit/utils");
var data_1 = require("@orbit/data");
var immutable_1 = require("@orbit/immutable");
var record_identity_map_1 = require("./record-identity-map");
var RelationshipAccessor = function () {
    function RelationshipAccessor(cache, base) {
        this._cache = cache;
        this.reset(base);
    }
    RelationshipAccessor.prototype.reset = function (base) {
        var relationships = {};
        Object.keys(this._cache.schema.models).forEach(function (type) {
            var baseRelationships = base && base._relationships[type];
            relationships[type] = new immutable_1.ImmutableMap(baseRelationships);
        });
        this._relationships = relationships;
    };
    RelationshipAccessor.prototype.relationshipExists = function (record, relationship, relatedRecord) {
        var rels = this._relationships[record.type].get(record.id);
        if (rels) {
            var rel = rels[relationship];
            if (rel) {
                if (rel instanceof record_identity_map_1.default) {
                    return rel.has(relatedRecord);
                } else {
                    return data_1.equalRecordIdentities(relatedRecord, rel);
                }
            }
        }
        return !relatedRecord;
    };
    RelationshipAccessor.prototype.relatedRecord = function (record, relationship) {
        var rels = this._relationships[record.type].get(record.id);
        if (rels) {
            return rels[relationship];
        }
    };
    RelationshipAccessor.prototype.relatedRecords = function (record, relationship) {
        var rels = this._relationships[record.type].get(record.id);
        var map = rels && rels[relationship];
        if (map) {
            return Array.from(map.values);
        }
    };
    RelationshipAccessor.prototype.relatedRecordsMap = function (record, relationship) {
        var rels = this._relationships[record.type].get(record.id);
        if (rels) {
            return rels[relationship];
        }
    };
    RelationshipAccessor.prototype.relatedRecordsMatch = function (record, relationship, relatedRecords) {
        var map = this.relatedRecordsMap(record, relationship);
        if (map) {
            var otherMap_1 = new record_identity_map_1.default();
            relatedRecords.forEach(function (id) {
                return otherMap_1.add(id);
            });
            return map.equals(otherMap_1);
        } else {
            return relatedRecords.length === 0;
        }
    };
    RelationshipAccessor.prototype.addRecord = function (record) {
        if (record.relationships) {
            var rels_1 = {};
            Object.keys(record.relationships).forEach(function (name) {
                var rel = record.relationships[name];
                if (rel.data !== undefined) {
                    if (utils_1.isArray(rel.data)) {
                        var relMap_1 = rels_1[name] = new record_identity_map_1.default();
                        rel.data.forEach(function (r) {
                            return relMap_1.add(r);
                        });
                    } else {
                        rels_1[name] = rel.data;
                    }
                }
            });
            this._relationships[record.type].set(record.id, rels_1);
        }
    };
    RelationshipAccessor.prototype.replaceRecord = function (record) {
        this.addRecord(record);
    };
    RelationshipAccessor.prototype.clearRecord = function (record) {
        this._relationships[record.type].remove(record.id);
    };
    RelationshipAccessor.prototype.addToRelatedRecords = function (record, relationship, relatedRecord) {
        var currentRels = this._relationships[record.type].get(record.id);
        var rels = currentRels ? cloneRelationships(currentRels) : {};
        var rel = rels[relationship];
        if (!rel) {
            rel = rels[relationship] = new record_identity_map_1.default();
        }
        rel.add(relatedRecord);
        this._relationships[record.type].set(record.id, rels);
    };
    RelationshipAccessor.prototype.removeFromRelatedRecords = function (record, relationship, relatedRecord) {
        var currentRels = this._relationships[record.type].get(record.id);
        if (currentRels && currentRels[relationship]) {
            var rels = cloneRelationships(currentRels);
            var rel = rels[relationship];
            rel.remove(relatedRecord);
            this._relationships[record.type].set(record.id, rels);
        }
    };
    RelationshipAccessor.prototype.replaceRelatedRecords = function (record, relationship, relatedRecords) {
        var currentRels = this._relationships[record.type].get(record.id);
        var rels = currentRels ? cloneRelationships(currentRels) : {};
        var rel = rels[relationship];
        if (!rel) {
            rel = rels[relationship] = new record_identity_map_1.default();
        }
        relatedRecords.forEach(function (relatedRecord) {
            return rel.add(relatedRecord);
        });
        this._relationships[record.type].set(record.id, rels);
    };
    RelationshipAccessor.prototype.replaceRelatedRecord = function (record, relationship, relatedRecord) {
        var currentRels = this._relationships[record.type].get(record.id);
        if (currentRels && currentRels[relationship] || relatedRecord) {
            var rels = currentRels ? cloneRelationships(currentRels) : {};
            rels[relationship] = relatedRecord;
            this._relationships[record.type].set(record.id, rels);
        }
    };
    return RelationshipAccessor;
}();
exports.default = RelationshipAccessor;
function cloneRelationships(rels) {
    var clonedRels = {};
    if (rels) {
        Object.keys(rels).forEach(function (name) {
            var value = rels[name];
            if (value instanceof record_identity_map_1.default) {
                clonedRels[name] = new record_identity_map_1.default(value);
            } else {
                clonedRels[name] = value;
            }
        });
    }
    return clonedRels;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVsYXRpb25zaGlwLWFjY2Vzc29yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NhY2hlL3JlbGF0aW9uc2hpcC1hY2Nlc3Nvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxzQkFBOEQ7QUFDOUQscUJBSXFCO0FBRXJCLDBCQUFnRDtBQUNoRCxvQ0FBc0Q7QUFFdEQsdUNBSUU7a0NBQVksQUFBWSxPQUFFLEFBQTJCLE1BQ25ELEFBQUk7YUFBQyxBQUFNLFNBQUcsQUFBSyxBQUFDLEFBQ3BCLEFBQUk7YUFBQyxBQUFLLE1BQUMsQUFBSSxBQUFDLEFBQUMsQUFDbkIsQUFBQztBQUVEO21DQUFLLFFBQUwsVUFBTSxBQUEyQixNQUMvQjtZQUFJLEFBQWEsZ0JBQUcsQUFBRSxBQUFDLEFBQ3ZCLEFBQU07ZUFBQyxBQUFJLEtBQUMsQUFBSSxLQUFDLEFBQU0sT0FBQyxBQUFNLE9BQUMsQUFBTSxBQUFDLFFBQUMsQUFBTyxRQUFDLFVBQUEsQUFBSSxNQUNqRDtnQkFBSSxBQUFpQixvQkFBRyxBQUFJLFFBQUksQUFBSSxLQUFDLEFBQWMsZUFBQyxBQUFJLEFBQUMsQUFBQyxBQUMxRCxBQUFhOzBCQUFDLEFBQUksQUFBQyxRQUFHLElBQUksWUFBWSxhQUFDLEFBQWlCLEFBQUMsQUFBQyxBQUM1RCxBQUFDLEFBQUMsQUFBQztBQUNILEFBQUk7YUFBQyxBQUFjLGlCQUFHLEFBQWEsQUFBQyxBQUN0QyxBQUFDO0FBRUQ7bUNBQWtCLHFCQUFsQixVQUFtQixBQUFzQixRQUFFLEFBQW9CLGNBQUUsQUFBNkIsZUFDNUY7WUFBSSxBQUFJLE9BQUcsQUFBSSxLQUFDLEFBQWMsZUFBQyxBQUFNLE9BQUMsQUFBSSxBQUFDLE1BQUMsQUFBRyxJQUFDLEFBQU0sT0FBQyxBQUFFLEFBQUMsQUFBQyxBQUMzRCxBQUFFLEFBQUM7WUFBQyxBQUFJLEFBQUMsTUFBQyxBQUFDLEFBQ1Q7Z0JBQUksQUFBRyxNQUFHLEFBQUksS0FBQyxBQUFZLEFBQUMs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QUFDLEFBQ25DLEFBQUk7aUJBQUMsQUFBYyxlQUFDLEFBQU0sT0FBQyxBQUFJLEFBQUMsTUFBQyxBQUFHLElBQUMsQUFBTSxPQUFDLEFBQUUsSUFBRSxBQUFJLEFBQUMsQUFBQyxBQUN4RCxBQUFDLEFBQ0g7QUFBQztBQUNIO1dBQUEsQUFBQyxBQXBJRCxBQW9JQzs7O0FBRUQsNEJBQTRCLEFBQUksTUFDOUI7UUFBTSxBQUFVLGFBQUcsQUFBRSxBQUFDLEFBQ3RCLEFBQUUsQUFBQztRQUFDLEFBQUksQUFBQyxNQUFDLEFBQUMsQUFDVCxBQUFNO2VBQUMsQUFBSSxLQUFDLEFBQUksQUFBQyxNQUFDLEFBQU8sUUFBQyxVQUFBLEFBQUksTUFDNUI7Z0JBQUksQUFBSyxRQUFHLEFBQUksS0FBQyxBQUFJLEFBQUMsQUFBQyxBQUN2QixBQUFFLEFBQUM7Z0JBQUMsQUFBSyxpQkFBWSxzQkFBaUIsQUFBQyxTQUFDLEFBQUMsQUFDdkMsQUFBVTsyQkFBQyxBQUFJLEFBQUMsUUFBRyxJQUFJLHNCQUFpQixRQUFDLEFBQTBCLEFBQUMsQUFBQyxBQUN2RSxBQUFDLEFBQUMsQUFBSTttQkFBQyxBQUFDLEFBQ04sQUFBVTsyQkFBQyxBQUFJLEFBQUMsUUFBRyxBQUFLLEFBQUMsQUFDM0IsQUFBQyxBQUNIO0FBQUMsQUFBQyxBQUFDLEFBQ0w7QUFBQztBQUNELEFBQU07V0FBQyxBQUFVLEFBQUMsQUFDcEIsQUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNsb25lLCBEaWN0LCBpc09iamVjdCwgaXNBcnJheSB9IGZyb20gJ0BvcmJpdC91dGlscyc7XHJcbmltcG9ydCB7XHJcbiAgZXF1YWxSZWNvcmRJZGVudGl0aWVzLFxyXG4gIFJlY29yZCxcclxuICBSZWNvcmRJZGVudGl0eVxyXG59IGZyb20gJ0BvcmJpdC9kYXRhJztcclxuaW1wb3J0IENhY2hlIGZyb20gJy4uL2NhY2hlJztcclxuaW1wb3J0IHsgSW1tdXRhYmxlTWFwIH0gZnJvbSAnQG9yYml0L2ltbXV0YWJsZSc7XHJcbmltcG9ydCBSZWNvcmRJZGVudGl0eU1hcCBmcm9tICcuL3JlY29yZC1pZGVudGl0eS1tYXAnO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVsYXRpb25zaGlwQWNjZXNzb3Ige1xyXG4gIHByb3RlY3RlZCBfY2FjaGU6IENhY2hlO1xyXG4gIHByb3RlY3RlZCBfcmVsYXRpb25zaGlwczogRGljdDxJbW11dGFibGVNYXA8c3RyaW5nLCBEaWN0PFJlY29yZElkZW50aXR5IHwgUmVjb3JkSWRlbnRpdHlNYXA+Pj47XHJcblxyXG4gIGNvbnN0cnVjdG9yKGNhY2hlOiBDYWNoZSwgYmFzZT86IFJlbGF0aW9uc2hpcEFjY2Vzc29yKSB7XHJcbiAgICB0aGlzLl9jYWNoZSA9IGNhY2hlO1xyXG4gICAgdGhpcy5yZXNldChiYXNlKTtcclxuICB9XHJcblxyXG4gIHJlc2V0KGJhc2U/OiBSZWxhdGlvbnNoaXBBY2Nlc3Nvcikge1xyXG4gICAgbGV0IHJlbGF0aW9uc2hpcHMgPSB7fTtcclxuICAgIE9iamVjdC5rZXlzKHRoaXMuX2NhY2hlLnNjaGVtYS5tb2RlbHMpLmZvckVhY2godHlwZSA9PiB7XHJcbiAgICAgIGxldCBiYXNlUmVsYXRpb25zaGlwcyA9IGJhc2UgJiYgYmFzZS5fcmVsYXRpb25zaGlwc1t0eXBlXTtcclxuICAgICAgcmVsYXRpb25zaGlwc1t0eXBlXSA9IG5ldyBJbW11dGFibGVNYXAoYmFzZVJlbGF0aW9uc2hpcHMpO1xyXG4gICAgfSk7XHJcbiAgICB0aGlzLl9yZWxhdGlvbnNoaXBzID0gcmVsYXRpb25zaGlwcztcclxuICB9XHJcblxyXG4gIHJlbGF0aW9uc2hpcEV4aXN0cyhyZWNvcmQ6IFJlY29yZElkZW50aXR5LCByZWxhdGlvbnNoaXA6IHN0cmluZywgcmVsYXRlZFJlY29yZDogUmVjb3JkSWRlbnRpdHkpOiBib29sZWFuIHtcclxuICAgIGxldCByZWxzID0gdGhpcy5fcmVsYXRpb25zaGlwc1tyZWNvcmQudHlwZV0uZ2V0KHJlY29yZC5pZCk7XHJcbiAgICBpZiAocmVscykge1xyXG4gICAgICBsZXQgcmVsID0gcmVsc1tyZWxhdGlvbnNoaXBdO1xyXG4gICAgICBpZiAocmVsKSB7XHJcbiAgICAgICAgaWYgKHJlbCBpbnN0YW5jZW9mIFJlY29yZElkZW50aXR5TWFwKSB7XHJcbiAgICAgICAgICByZXR1cm4gcmVsLmhhcyhyZWxhdGVkUmVjb3JkKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIGVxdWFsUmVjb3JkSWRlbnRpdGllcyhyZWxhdGVkUmVjb3JkLCByZWwpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuICFyZWxhdGVkUmVjb3JkO1xyXG4gIH1cclxuXHJcbiAgcmVsYXRlZFJlY29yZChyZWNvcmQ6IFJlY29yZElkZW50aXR5LCByZWxhdGlvbnNoaXA6IHN0cmluZyk6IFJlY29yZElkZW50aXR5IHtcclxuICAgIGxldCByZWxzID0gdGhpcy5fcmVsYXRpb25zaGlwc1tyZWNvcmQudHlwZV0uZ2V0KHJlY29yZC5pZCk7XHJcbiAgICBpZiAocmVscykge1xyXG4gICAgICByZXR1cm4gcmVsc1tyZWxhdGlvbnNoaXBdIGFzIFJlY29yZElkZW50aXR5O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmVsYXRlZFJlY29yZHMocmVjb3JkOiBSZWNvcmRJZGVudGl0eSwgcmVsYXRpb25zaGlwOiBzdHJpbmcpOiBSZWNvcmRJZGVudGl0eVtdIHtcclxuICAgIGxldCByZWxzID0gdGhpcy5fcmVsYXRpb25zaGlwc1tyZWNvcmQudHlwZV0uZ2V0KHJlY29yZC5pZCk7XHJcbiAgICBsZXQgbWFwID0gcmVscyAmJiByZWxzW3JlbGF0aW9uc2hpcF0gYXMgUmVjb3JkSWRlbnRpdHlNYXA7XHJcbiAgICBpZiAobWFwKSB7XHJcbiAgICAgIHJldHVybiBBcnJheS5mcm9tKG1hcC52YWx1ZXMpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmVsYXRlZFJlY29yZHNNYXAocmVjb3JkOiBSZWNvcmRJZGVudGl0eSwgcmVsYXRpb25zaGlwOiBzdHJpbmcpOiBSZWNvcmRJZGVudGl0eU1hcCB7XHJcbiAgICBsZXQgcmVscyA9IHRoaXMuX3JlbGF0aW9uc2hpcHNbcmVjb3JkLnR5cGVdLmdldChyZWNvcmQuaWQpO1xyXG4gICAgaWYgKHJlbHMpIHtcclxuICAgICAgcmV0dXJuIHJlbHNbcmVsYXRpb25zaGlwXSBhcyBSZWNvcmRJZGVudGl0eU1hcDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJlbGF0ZWRSZWNvcmRzTWF0Y2gocmVjb3JkOiBSZWNvcmRJZGVudGl0eSwgcmVsYXRpb25zaGlwOiBzdHJpbmcsIHJlbGF0ZWRSZWNvcmRzOiBSZWNvcmRJZGVudGl0eVtdKTogYm9vbGVhbiB7XHJcbiAgICBsZXQgbWFwID0gdGhpcy5yZWxhdGVkUmVjb3Jkc01hcChyZWNvcmQsIHJlbGF0aW9uc2hpcCk7XHJcbiAgICBpZiAobWFwKSB7XHJcbiAgICAgIGxldCBvdGhlck1hcCA9IG5ldyBSZWNvcmRJZGVudGl0eU1hcDtcclxuICAgICAgcmVsYXRlZFJlY29yZHMuZm9yRWFjaChpZCA9PiBvdGhlck1hcC5hZGQoaWQpKTtcclxuICAgICAgcmV0dXJuIG1hcC5lcXVhbHMob3RoZXJNYXApO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHJlbGF0ZWRSZWNvcmRzLmxlbmd0aCA9PT0gMDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFkZFJlY29yZChyZWNvcmQ6IFJlY29yZCkge1xyXG4gICAgaWYgKHJlY29yZC5yZWxhdGlvbnNoaXBzKSB7XHJcbiAgICAgIGNvbnN0IHJlbHMgPSB7fTtcclxuICAgICAgT2JqZWN0LmtleXMocmVjb3JkLnJlbGF0aW9uc2hpcHMpLmZvckVhY2gobmFtZSA9PiB7XHJcbiAgICAgICAgbGV0IHJlbCA9IHJlY29yZC5yZWxhdGlvbnNoaXBzW25hbWVdO1xyXG4gICAgICAgIGlmIChyZWwuZGF0YSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICBpZiAoaXNBcnJheShyZWwuZGF0YSkpIHtcclxuICAgICAgICAgICAgbGV0IHJlbE1hcCA9IHJlbHNbbmFtZV0gPSBuZXcgUmVjb3JkSWRlbnRpdHlNYXAoKTtcclxuICAgICAgICAgICAgKHJlbC5kYXRhIGFzIFJlY29yZElkZW50aXR5W10pLmZvckVhY2gociA9PiByZWxNYXAuYWRkKHIpKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJlbHNbbmFtZV0gPSByZWwuZGF0YTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5zZXQocmVjb3JkLmlkLCByZWxzKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJlcGxhY2VSZWNvcmQocmVjb3JkOiBSZWNvcmQpIHtcclxuICAgIHRoaXMuYWRkUmVjb3JkKHJlY29yZCk7XHJcbiAgfVxyXG5cclxuICBjbGVhclJlY29yZChyZWNvcmQ6IFJlY29yZElkZW50aXR5KTogdm9pZCB7XHJcbiAgICB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5yZW1vdmUocmVjb3JkLmlkKTtcclxuICB9XHJcblxyXG4gIGFkZFRvUmVsYXRlZFJlY29yZHMocmVjb3JkOiBSZWNvcmRJZGVudGl0eSwgcmVsYXRpb25zaGlwOiBzdHJpbmcsIHJlbGF0ZWRSZWNvcmQ6IFJlY29yZElkZW50aXR5KTogdm9pZCB7XHJcbiAgICBsZXQgY3VycmVudFJlbHMgPSB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5nZXQocmVjb3JkLmlkKTtcclxuICAgIGxldCByZWxzID0gY3VycmVudFJlbHMgPyBjbG9uZVJlbGF0aW9uc2hpcHMoY3VycmVudFJlbHMpIDoge307XHJcbiAgICBsZXQgcmVsID0gcmVsc1tyZWxhdGlvbnNoaXBdO1xyXG4gICAgaWYgKCFyZWwpIHtcclxuICAgICAgcmVsID0gcmVsc1tyZWxhdGlvbnNoaXBdID0gbmV3IFJlY29yZElkZW50aXR5TWFwKCk7XHJcbiAgICB9XHJcbiAgICByZWwuYWRkKHJlbGF0ZWRSZWNvcmQpO1xyXG4gICAgdGhpcy5fcmVsYXRpb25zaGlwc1tyZWNvcmQudHlwZV0uc2V0KHJlY29yZC5pZCwgcmVscyk7XHJcbiAgfVxyXG5cclxuICByZW1vdmVGcm9tUmVsYXRlZFJlY29yZHMocmVjb3JkOiBSZWNvcmRJZGVudGl0eSwgcmVsYXRpb25zaGlwOiBzdHJpbmcsIHJlbGF0ZWRSZWNvcmQ6IFJlY29yZElkZW50aXR5KTogdm9pZCB7XHJcbiAgICBsZXQgY3VycmVudFJlbHMgPSB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5nZXQocmVjb3JkLmlkKTtcclxuICAgIGlmIChjdXJyZW50UmVscyAmJiBjdXJyZW50UmVsc1tyZWxhdGlvbnNoaXBdKSB7XHJcbiAgICAgIGxldCByZWxzID0gY2xvbmVSZWxhdGlvbnNoaXBzKGN1cnJlbnRSZWxzKTtcclxuICAgICAgbGV0IHJlbCA9IHJlbHNbcmVsYXRpb25zaGlwXTtcclxuICAgICAgcmVsLnJlbW92ZShyZWxhdGVkUmVjb3JkKTtcclxuICAgICAgdGhpcy5fcmVsYXRpb25zaGlwc1tyZWNvcmQudHlwZV0uc2V0KHJlY29yZC5pZCwgcmVscyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXBsYWNlUmVsYXRlZFJlY29yZHMocmVjb3JkOiBSZWNvcmRJZGVudGl0eSwgcmVsYXRpb25zaGlwOiBzdHJpbmcsIHJlbGF0ZWRSZWNvcmRzOiBSZWNvcmRJZGVudGl0eVtdKTogdm9pZCB7XHJcbiAgICBsZXQgY3VycmVudFJlbHMgPSB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5nZXQocmVjb3JkLmlkKTtcclxuICAgIGxldCByZWxzID0gY3VycmVudFJlbHMgPyBjbG9uZVJlbGF0aW9uc2hpcHMoY3VycmVudFJlbHMpIDoge307XHJcbiAgICBsZXQgcmVsID0gcmVsc1tyZWxhdGlvbnNoaXBdO1xyXG4gICAgaWYgKCFyZWwpIHtcclxuICAgICAgcmVsID0gcmVsc1tyZWxhdGlvbnNoaXBdID0gbmV3IFJlY29yZElkZW50aXR5TWFwKCk7XHJcbiAgICB9XHJcbiAgICByZWxhdGVkUmVjb3Jkcy5mb3JFYWNoKHJlbGF0ZWRSZWNvcmQgPT4gcmVsLmFkZChyZWxhdGVkUmVjb3JkKSk7XHJcbiAgICB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5zZXQocmVjb3JkLmlkLCByZWxzKTtcclxuICB9XHJcblxyXG4gIHJlcGxhY2VSZWxhdGVkUmVjb3JkKHJlY29yZDogUmVjb3JkSWRlbnRpdHksIHJlbGF0aW9uc2hpcDogc3RyaW5nLCByZWxhdGVkUmVjb3JkOiBSZWNvcmRJZGVudGl0eSk6IHZvaWQge1xyXG4gICAgbGV0IGN1cnJlbnRSZWxzID0gdGhpcy5fcmVsYXRpb25zaGlwc1tyZWNvcmQudHlwZV0uZ2V0KHJlY29yZC5pZCk7XHJcbiAgICBpZiAoKGN1cnJlbnRSZWxzICYmIGN1cnJlbnRSZWxzW3JlbGF0aW9uc2hpcF0pIHx8IHJlbGF0ZWRSZWNvcmQpIHtcclxuICAgICAgbGV0IHJlbHMgPSBjdXJyZW50UmVscyA/IGNsb25lUmVsYXRpb25zaGlwcyhjdXJyZW50UmVscykgOiB7fTtcclxuICAgICAgcmVsc1tyZWxhdGlvbnNoaXBdID0gcmVsYXRlZFJlY29yZDtcclxuICAgICAgdGhpcy5fcmVsYXRpb25zaGlwc1tyZWNvcmQudHlwZV0uc2V0KHJlY29yZC5pZCwgcmVscyk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBjbG9uZVJlbGF0aW9uc2hpcHMocmVscykge1xyXG4gIGNvbnN0IGNsb25lZFJlbHMgPSB7fTtcclxuICBpZiAocmVscykge1xyXG4gICAgT2JqZWN0LmtleXMocmVscykuZm9yRWFjaChuYW1lID0+IHtcclxuICAgICAgbGV0IHZhbHVlID0gcmVsc1tuYW1lXTtcclxuICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgUmVjb3JkSWRlbnRpdHlNYXApIHtcclxuICAgICAgICBjbG9uZWRSZWxzW25hbWVdID0gbmV3IFJlY29yZElkZW50aXR5TWFwKHZhbHVlIGFzIFJlY29yZElkZW50aXR5TWFwKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjbG9uZWRSZWxzW25hbWVdID0gdmFsdWU7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICByZXR1cm4gY2xvbmVkUmVscztcclxufVxyXG4iXX0=