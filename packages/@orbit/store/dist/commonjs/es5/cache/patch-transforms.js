"use strict";

Object.defineProperty(exports, "__esModule", { value: true });
var data_1 = require("@orbit/data");
var utils_1 = require("@orbit/utils");
exports.default = {
    addRecord: function (cache, op) {
        var record = op.record;
        var records = cache.records(record.type);
        records.set(record.id, record);
        if (cache.keyMap) {
            cache.keyMap.pushRecord(record);
        }
        return record;
    },
    replaceRecord: function (cache, op) {
        var replacement = op.record;
        var type = replacement.type,
            id = replacement.id;
        var records = cache.records(type);
        var current = records.get(id);
        var record;
        if (current) {
            record = { type: type, id: id };
            ['attributes', 'keys', 'relationships'].forEach(function (grouping) {
                if (current[grouping] && replacement[grouping]) {
                    record[grouping] = utils_1.merge({}, current[grouping], replacement[grouping]);
                } else if (current[grouping]) {
                    record[grouping] = utils_1.merge({}, current[grouping]);
                } else if (replacement[grouping]) {
                    record[grouping] = utils_1.merge({}, replacement[grouping]);
                }
            });
        } else {
            record = replacement;
        }
        records.set(id, record);
        if (cache.keyMap) {
            cache.keyMap.pushRecord(record);
        }
        return record;
    },
    removeRecord: function (cache, op) {
        var _a = op.record,
            type = _a.type,
            id = _a.id;
        var records = cache.records(type);
        var result = records.get(id);
        if (result) {
            records.remove(id);
            return result;
        } else {
            return null;
        }
    },
    replaceKey: function (cache, op) {
        var _a = op.record,
            type = _a.type,
            id = _a.id;
        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = utils_1.clone(record);
        } else {
            record = { type: type, id: id };
        }
        utils_1.deepSet(record, ['keys', op.key], op.value);
        records.set(id, record);
        if (cache.keyMap) {
            cache.keyMap.pushRecord(record);
        }
        return record;
    },
    replaceAttribute: function (cache, op) {
        var _a = op.record,
            type = _a.type,
            id = _a.id;
        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = utils_1.clone(record);
        } else {
            record = { type: type, id: id };
        }
        utils_1.deepSet(record, ['attributes', op.attribute], op.value);
        records.set(id, record);
        return record;
    },
    addToRelatedRecords: function (cache, op) {
        var _a = op.record,
            type = _a.type,
            id = _a.id;
        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = utils_1.clone(record);
        } else {
            record = { type: type, id: id };
        }
        var relatedRecords = utils_1.deepGet(record, ['relationships', op.relationship, 'data']) || [];
        relatedRecords.push(op.relatedRecord);
        utils_1.deepSet(record, ['relationships', op.relationship, 'data'], relatedRecords);
        records.set(id, record);
        return record;
    },
    removeFromRelatedRecords: function (cache, op) {
        var _a = op.record,
            type = _a.type,
            id = _a.id;
        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = utils_1.clone(record);
            var relatedRecords = utils_1.deepGet(record, ['relationships', op.relationship, 'data']);
            if (relatedRecords) {
                relatedRecords = relatedRecords.filter(function (r) {
                    return !data_1.equalRecordIdentities(r, op.relatedRecord);
                });
                if (utils_1.deepSet(record, ['relationships', op.relationship, 'data'], relatedRecords)) {
                    records.set(id, record);
                }
            }
            return record;
        }
        return null;
    },
    replaceRelatedRecords: function (cache, op) {
        var _a = op.record,
            type = _a.type,
            id = _a.id;
        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = utils_1.clone(record);
        } else {
            record = { type: type, id: id };
        }
        if (utils_1.deepSet(record, ['relationships', op.relationship, 'data'], op.relatedRecords)) {
            records.set(id, record);
        }
        return record;
    },
    replaceRelatedRecord: function (cache, op) {
        var _a = op.record,
            type = _a.type,
            id = _a.id;
        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = utils_1.clone(record);
        } else {
            record = { type: type, id: id };
        }
        if (utils_1.deepSet(record, ['relationships', op.relationship, 'data'], op.relatedRecord)) {
            records.set(id, record);
        }
        return record;
    }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF0Y2gtdHJhbnNmb3Jtcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWNoZS9wYXRjaC10cmFuc2Zvcm1zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHFCQWNxQjtBQUNyQixzQkFBOEQ7QUFPOUQ7ZUFDRSxVQUFVLEFBQVksT0FBRSxBQUFzQixJQUM1QztZQUFJLEFBQU0sU0FBRyxBQUFFLEdBQUMsQUFBTSxBQUFDLEFBQ3ZCO1lBQU0sQUFBTyxVQUFHLEFBQUssTUFBQyxBQUFPLFFBQUMsQUFBTSxPQUFDLEFBQUksQUFBQyxBQUFDLEFBQzNDLEFBQU87Z0JBQUMsQUFBRyxJQUFDLEFBQU0sT0FBQyxBQUFFLElBQUUsQUFBTSxBQUFDLEFBQUMsQUFFL0IsQUFBRSxBQUFDO1lBQUMsQUFBSyxNQUFDLEFBQU0sQUFBQyxRQUFDLEFBQUMsQUFDakIsQUFBSztrQkFBQyxBQUFNLE9BQUMsQUFBVSxXQUFDLEFBQU0sQUFBQyxBQUFDLEFBQ2xDLEFBQUM7QUFFRCxBQUFNO2VBQUMsQUFBTSxBQUFDLEFBQ2hCLEFBQUM7QUFFRCxBQUFhO21CQUFiLFVBQWMsQUFBWSxPQUFFLEFBQTBCLElBQ3BEO1lBQU0sQUFBVyxjQUFHLEFBQUUsR0FBQyxBQUFNLEFBQUMsQUFDdEI7WUFBQSxtQkFBSTtZQUFFLGlCQUFFLEFBQWlCLEFBQ2pDO1lBQU0sQUFBTyxVQUFHLEFBQUssTUFBQyxBQUFPLFFBQUMsQUFBSSxBQUFDLEFBQUMsQUFDcEM7WUFBTSxBQUFPLFVBQUcsQUFBTyxRQUFDLEFBQUcsSUFBQyxBQUFFLEFBQUMsQUFBQyxBQUNoQztZQUFJLEFBQWMsQUFBQyxBQUVuQixBQUFFLEFBQUM7WUFBQyxBQUFPLEFBQUMsU0FBQyxBQUFDLEFBQ1osQUFBTTtxQkFBRyxFQUFFLEFBQUksTUFBQSxNQUFFLEFBQUUsSUFBQSxBQUFFLEFBQUMsQUFFdEI7YUFBQyxBQUFZLGNBQUUsQUFBTSxRQUFFLEFBQWUsQUFBQyxpQkFBQyxBQUFPLFFBQUMsVUFBQSxBQUFRLFVBQ3RELEFBQUUsQUFBQztvQkFBQyxBQUFPLFFBQUMsQUFBUSxBQUFDLGFBQUksQUFBVyxZQUFDLEFBQVEsQUFBQyxBQUFDLFdBQUMsQUFBQyxBQUMvQyxBQUFNOzJCQUFDLEFBQVEsQUFBQyxZQUFHLFFBQUssTUFBQyxBQUFFLElBQUUsQUFBTyxRQUFDLEFBQVEsQUFBQyxXQUFFLEFBQVcsWUFBQyxBQUFRLEFBQUMsQUFBQyxBQUFDLEFBQ3pFLEFBQUMsQUFBQyxBQUFJOzJCQUFLLEFBQU8sUUFBQyxBQUFRLEFBQUMsQUFBQyxXQUFDLEFBQUMsQUFDN0IsQUFBTTsyQkFBQyxBQUFRLEFBQUMsWUFBRyxRQUFLLE1BQUMsQUFBRSxJQUFFLEFBQU8sUUFBQyxBQUFRLEFBQUMsQUFBQyxBQUFDLEFBQ2xELEFBQUMsQUFBQyxBQUFJO0FBRkMsQUFBRSxBQUFDLHVCQUVILEFBQUUsQUFBQyxJQUFDLEFBQVcsWUFBQyxBQUFRLEFBQUMsQUFBQyxXQUFDLEFBQUMsQUFDakMsQUFBTTsyQkFBQyxBQUFRLEFBQUMsWUFBRyxRQUFLLE1BQUMsQUFBRSxJQUFFLEFBQVcsWUFBQyxBQUFRLEFBQUMsQUFBQyxBQUFDLEFBQ3RELEFBQUMsQUFDSDtBQUFDLEFBQUMsQUFBQyxBQUNMO0FBQUMsQUFBQyxBQUFJO2VBQUMsQUFBQyxBQUNOLEFBQU07cUJBQUcsQUFBVyxBQUFDLEFBQ3ZCLEFBQUM7QUFFRCxBQUFPO2dCQUFDLEFBQUcsSUFBQyxBQUFFLElBQUUsQUFBTSxBQUFDLEFBQUMsQUFFeEIsQUFBRSxBQUFDO1lBQUMsQUFBSyxNQUFDLEFBQU0sQUFBQyxRQUFDLEFBQUMsQUFDakIsQUFBSztrQkFBQyxBQUFNLE9BQUMsQUFBVSxXQUFDLEFBQU0sQUFBQyxBQUFDLEFBQ2xDLEFBQUM7QUFFRCxBQUFNO2VBQUMsQUFBTSxBQUFDLEFBQ2hCLEFBQUM7QUFFRCxBQUFZO2tCQUFaLFVBQWEsQUFBWSxPQUFFLEFBQXlCLElBQzVDO1lBQUEsUUFBd0I7WUFBdEIsVUFBSTtZQUFFLFFBQUUsQUFBZSxBQUMvQjtZQUFNLEFBQU8sVUFBRyxBQUFLLE1BQUMsQUFBTyxRQUFDLEFBQUksQUFBQyxBQUFDLEFBQ3BDO1lBQU0sQUFBTSxTQUFHLEFBQU8sUUFBQyxBQUFHLElBQUMsQUFBRSxBQUFDLEFBQUMsQUFDL0IsQUFBRSxBQUFDO1lBQUMsQUFBTSxBQUFDLFFBQUMsQUFBQyxBQUNYLEFBQU87b0JBQUMsQUFBTSxPQUFDLEFBQUUsQUFBQyxBQUFDLEFBQ25CLEFBQU07bUJBQUMsQUFBTSxBQUFDLEFBQ2hCLEFBQUMsQUFBQyxBQUFJO2VBQUMsQUFBQyxBQUNOLEFBQU07bUJBQUMsQUFBSSxBQUFDLEFBQ2QsQUFBQyxBQUNIO0FBQUM7QUFFRCxBQUFVO2dCQUFWLFVBQVcsQUFBWSxPQUFFLEFBQXVCLElBQ3hDO1lBQUEsUUFBd0I7WUFBdEIsVUFBSTtZQUFFLFFBQUUsQUFBZSxBQUMvQjtZQUFNLEFBQU8sVUFBRyxBQUFLLE1BQUMsQUFBTyxRQUFDLEFBQUksQUFBQyxBQUFDLEFBQ3BDO1lBQUksQUFBTSxTQUFHLEFBQU8sUUFBQyxBQUFHLElBQUMsQUFBRSxBQUFDLEFBQUMsQUFDN0IsQUFBRSxBQUFDO1lBQUMsQUFBTSxBQUFDLFFBQUMsQUFBQyxBQUNYLEFBQU07cUJBQUcsUUFBSyxNQUFDLEFBQU0sQUFBQyxBQUFDLEFBQ3pCLEFBQUMsQUFBQyxBQUFJO2VBQUMsQUFBQyxBQUNOLEFBQU07cUJBQUcsRUFBRSxBQUFJLE1BQUEsTUFBRSxBQUFFLElBQUEsQUFBRSxBQUFDLEFBQ3hCLEFBQUM7QUFDRDtnQkFBTyxRQUFDLEFBQU0sUUFBRSxDQUFDLEFBQU0sUUFBRSxBQUFFLEdBQUMsQUFBRyxBQUFDLE1BQUUsQUFBRSxHQUFDLEFBQUssQUFBQyxBQUFDLEFBQzVDLEFBQU87Z0JBQUMsQUFBRyxJQUFDLEFBQUUsSUFBRSxBQUFNLEFBQUMsQUFBQyxBQUV4QixBQUFFLEFBQUM7WUFBQyxBQUFLLE1BQUMsQUFBTSxBQUFDLFFBQUMsQUFBQyxBQUNqQixBQUFLO2tCQUFDLEFBQU0sT0FBQyxBQUFVLFdBQUMsQUFBTSxBQUFDLEFBQUMsQUFDbEMsQUFBQztBQUVELEFBQU07ZUFBQyxBQUFNLEFBQUMsQUFDaEIsQUFBQztBQUVELEFBQWdCO3NCQUFoQixVQUFpQixBQUFZLE9BQUUsQUFBNkIsSUFDcEQ7WUFBQSxRQUF3QjtZQUF0QixVQUFJO1lBQUUsUUFBRSxBQUFlLEFBQy9CO1lBQU0sQUFBTyxVQUFHLEFBQUssTUFBQyxBQUFPLFFBQUMsQUFBSSxBQUFDLEFBQUMsQUFDcEM7WUFBSSxBQUFNLFNBQUcsQUFBTyxRQUFDLEFBQUcsSUFBQyxBQUFFLEFBQUMsQUFBQyxBQUM3QixBQUFFLEFBQUM7WUFBQyxBQUFNLEFBQUMsUUFBQyxBQUFDLEFBQ1gsQUFBTTtxQkFBRyxRQUFLLE1BQUMsQUFBTSxBQUFDLEFBQUMsQUFDekIsQUFBQyxBQUFDLEFBQUk7ZUFBQyxBQUFDLEFBQ04sQUFBTTtxQkFBRyxFQUFFLEFBQUksTUFBQSxNQUFFLEFBQUUsSUFBQSxBQUFFLEFBQUMsQUFDeEIsQUFBQztBQUNEO2dCQUFPLFFBQUMsQUFBTSxRQUFFLENBQUMsQUFBWSxjQUFFLEFBQUUsR0FBQyxBQUFTLEFBQUMsWUFBRSxBQUFFLEdBQUMsQUFBSyxBQUFDLEFBQUMsQUFDeEQsQUFBTztnQkFBQyxBQUFHLElBQUMsQUFBRSxJQUFFLEFBQU0sQUFBQyxBQUFDLEFBQ3hCLEFBQU07ZUFBQyxBQUFNLEFBQUMsQUFDaEIsQUFBQztBQUVELEFBQW1CO3lCQUFuQixVQUFvQixBQUFZLE9BQUUsQUFBZ0MsSUFDMUQ7WUFBQSxRQUF3QjtZQUF0QixVQUFJO1lBQUUsUUFBRSxBQUFlLEFBQy9CO1lBQU0sQUFBTyxVQUFHLEFBQUssTUFBQyxBQUFPLFFBQUMsQUFBSSxBQUFDLEFBQUMsQUFDcEM7WUFBSSxBQUFNLFNBQUcsQUFBTyxRQUFDLEFBQUcsSUFBQyxBQUFFLEFBQUMsQUFBQyxBQUM3QixBQUFFLEFBQUM7WUFBQyxBQUFNLEFBQUMsUUFBQyxBQUFDLEFBQ1gsQUFBTTtxQkFBRyxRQUFLLE1BQUMsQUFBTSxBQUFDLEFBQUMsQUFDekIsQUFBQyxBQUFDLEFBQUk7ZUFBQyxBQUFDLEFBQ04sQUFBTTtxQkFBRyxFQUFFLEFBQUksTUFBQSxNQUFFLEFBQUUsSUFBQSxBQUFFLEFBQUMsQUFDeEIsQUFBQztBQUNEO1lBQU0sQUFBYyxpQkFBRyxRQUFPLFFBQUMsQUFBTSxRQUFFLENBQUMsQUFBZSxpQkFBRSxBQUFFLEdBQUMsQUFBWSxjQUFFLEFBQU0sQUFBQyxBQUFDLFlBQUksQUFBRSxBQUFDLEFBQ3pGLEFBQWM7dUJBQUMsQUFBSSxLQUFDLEFBQUUsR0FBQyxBQUFhLEFBQUMsQUFBQyxBQUV0QztnQkFBTyxRQUFDLEFBQU0sUUFBRSxDQUFDLEFBQWUsaUJBQUUsQUFBRSxHQUFDLEFBQVksY0FBRSxBQUFNLEFBQUMsU0FBRSxBQUFjLEFBQUMsQUFBQyxBQUM1RSxBQUFPO2dCQUFDLEFBQUcsSUFBQyxBQUFFLElBQUUsQUFBTSxBQUFDLEFBQUMsQUFDeEIsQUFBTTtlQUFDLEFBQU0sQUFBQyxBQUNoQixBQUFDO0FBRUQsQUFBd0I7OEJBQXhCLFVBQXlCLEFBQVksT0FBRSxBQUFxQyxJQUNwRTtZQUFBLFFBQXdCO1lBQXRCLFVBQUk7WUFBRSxRQUFFLEFBQWUsQUFDL0I7WUFBTSxBQUFPLFVBQUcsQUFBSyxNQUFDLEFBQU8sUUFBQyxBQUFJLEFBQUMsQUFBQyxBQUNwQztZQUFJLEFBQU0sU0FBRyxBQUFPLFFBQUMsQUFBRyxJQUFDLEFBQUUsQUFBQyxBQUFDLEFBQzdCLEFBQUUsQUFBQztZQUFDLEFBQU0sQUFBQyxRQUFDLEFBQUMsQUFDWCxBQUFNO3FCQUFHLFFBQUssTUFBQyxBQUFNLEFBQUMsQUFBQyxBQUN2QjtnQkFBSSxBQUFjLGlCQUFHLFFBQU8sUUFBQyxBQUFNLFFBQUUsQ0FBQyxBQUFlLGlCQUFFLEFBQUUsR0FBQyxBQUFZLGNBQUUsQUFBTSxBQUFDLEFBQXFCLEFBQUMsQUFDckcsQUFBRSxBQUFDO2dCQUFDLEFBQWMsQUFBQyxnQkFBQyxBQUFDLEFBQ25CLEFBQWM7Z0RBQWtCLEFBQU0sT0FBQyxVQUFBLEFBQUMsR0FBSTsyQkFBQSxDQUFDLE9BQXFCLHNCQUFDLEFBQUMsR0FBRSxBQUFFLEdBQTVCLEFBQTZCLEFBQWEsQUFBQyxBQUFDLEFBQUM7QUFBeEUsQUFBYyxBQUUvQixBQUFFLEFBQUM7b0JBQUMsUUFBTyxRQUFDLEFBQU0sUUFBRSxDQUFDLEFBQWUsaUJBQUUsQUFBRSxHQUFDLEFBQVksY0FBRSxBQUFNLEFBQUMsU0FBRSxBQUFjLEFBQUMsQUFBQyxpQkFBQyxBQUFDLEFBQ2hGLEFBQU87NEJBQUMsQUFBRyxJQUFDLEFBQUUsSUFBRSxBQUFNLEFBQUMsQUFBQyxBQUMxQixBQUFDLEFBQ0g7QUFBQztBQUNELEFBQU07bUJBQUMsQUFBTSxBQUFDLEFBQ2hCLEFBQUM7QUFDRCxBQUFNO2VBQUMsQUFBSSxBQUFDLEFBQ2QsQUFBQztBQUVELEFBQXFCOzJCQUFyQixVQUFzQixBQUFZLE9BQUUsQUFBa0MsSUFDOUQ7WUFBQSxRQUF3QjtZQUF0QixVQUFJO1lBQUUsUUFBRSxBQUFlLEFBQy9CO1lBQU0sQUFBTyxVQUFHLEFBQUssTUFBQyxBQUFPLFFBQUMsQUFBSSxBQUFDLEFBQUMsQUFDcEM7WUFBSSxBQUFNLFNBQUcsQUFBTyxRQUFDLEFBQUcsSUFBQyxBQUFFLEFBQUMsQUFBQyxBQUM3QixBQUFFLEFBQUM7WUFBQyxBQUFNLEFBQUMsUUFBQyxBQUFDLEFBQ1gsQUFBTTtxQkFBRyxRQUFLLE1BQUMsQUFBTSxBQUFDLEFBQUMsQUFDekIsQUFBQyxBQUFDLEFBQUk7ZUFBQyxBQUFDLEFBQ04sQUFBTTtxQkFBRyxFQUFFLEFBQUksTUFBQSxNQUFFLEFBQUUsSUFBQSxBQUFFLEFBQUMsQUFDeEIsQUFBQztBQUNELEFBQUUsQUFBQztZQUFDLFFBQU8sUUFBQyxBQUFNLFFBQUUsQ0FBQyxBQUFlLGlCQUFFLEFBQUUsR0FBQyxBQUFZLGNBQUUsQUFBTSxBQUFDLFNBQUUsQUFBRSxHQUFDLEFBQWMsQUFBQyxBQUFDLGlCQUFDLEFBQUMsQUFDbkYsQUFBTztvQkFBQyxBQUFHLElBQUMsQUFBRSxJQUFFLEFBQU0sQUFBQyxBQUFDLEFBQzFCLEFBQUM7QUFDRCxBQUFNO2VBQUMsQUFBTSxBQUFDLEFBQ2hCLEFBQUM7QUFFRCxBQUFvQjswQkFBcEIsVUFBcUIsQUFBWSxPQUFFLEFBQWlDLElBQzVEO1lBQUEsUUFBd0I7WUFBdEIsVUFBSTtZQUFFLFFBQUUsQUFBZSxBQUMvQjtZQUFNLEFBQU8sVUFBRyxBQUFLLE1BQUMsQUFBTyxRQUFDLEFBQUksQUFBQyxBQUFDLEFBQ3BDO1lBQUksQUFBTSxTQUFHLEFBQU8sUUFBQyxBQUFHLElBQUMsQUFBRSxBQUFDLEFBQUMsQUFDN0IsQUFBRSxBQUFDO1lBQUMsQUFBTSxBQUFDLFFBQUMsQUFBQyxBQUNYLEFBQU07cUJBQUcsUUFBSyxNQUFDLEFBQU0sQUFBQyxBQUFDLEFBQ3pCLEFBQUMsQUFBQyxBQUFJO2VBQUMsQUFBQyxBQUNOLEFBQU07cUJBQUcsRUFBRSxBQUFJLE1BQUEsTUFBRSxBQUFFLElBQUEsQUFBRSxBQUFDLEFBQ3hCLEFBQUM7QUFDRCxBQUFFLEFBQUM7WUFBQyxRQUFPLFFBQUMsQUFBTSxRQUFFLENBQUMsQUFBZSxpQkFBRSxBQUFFLEdBQUMsQUFBWSxjQUFFLEFBQU0sQUFBQyxTQUFFLEFBQUUsR0FBQyxBQUFhLEFBQUMsQUFBQyxnQkFBQyxBQUFDLEFBQ2xGLEFBQU87b0JBQUMsQUFBRyxJQUFDLEFBQUUsSUFBRSxBQUFNLEFBQUMsQUFBQyxBQUMxQixBQUFDO0FBQ0QsQUFBTTtlQUFDLEFBQU0sQUFBQyxBQUNoQixBQUFDLEFBQ0YsQUFBQztBQTNKYTtBQUNiLEFBQVMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIFJlY29yZCxcclxuICBSZWNvcmRJZGVudGl0eSxcclxuICBSZWNvcmRPcGVyYXRpb24sXHJcbiAgQWRkUmVjb3JkT3BlcmF0aW9uLFxyXG4gIEFkZFRvUmVsYXRlZFJlY29yZHNPcGVyYXRpb24sXHJcbiAgUmVwbGFjZUF0dHJpYnV0ZU9wZXJhdGlvbixcclxuICBSZW1vdmVGcm9tUmVsYXRlZFJlY29yZHNPcGVyYXRpb24sXHJcbiAgUmVtb3ZlUmVjb3JkT3BlcmF0aW9uLFxyXG4gIFJlcGxhY2VSZWxhdGVkUmVjb3Jkc09wZXJhdGlvbixcclxuICBSZXBsYWNlUmVsYXRlZFJlY29yZE9wZXJhdGlvbixcclxuICBSZXBsYWNlS2V5T3BlcmF0aW9uLFxyXG4gIFJlcGxhY2VSZWNvcmRPcGVyYXRpb24sXHJcbiAgZXF1YWxSZWNvcmRJZGVudGl0aWVzXHJcbn0gZnJvbSAnQG9yYml0L2RhdGEnO1xyXG5pbXBvcnQgeyBjbG9uZSwgZGVlcEdldCwgZGVlcFNldCwgbWVyZ2UgfSBmcm9tICdAb3JiaXQvdXRpbHMnO1xyXG5pbXBvcnQgQ2FjaGUsIHsgUGF0Y2hSZXN1bHREYXRhIH0gZnJvbSAnLi4vY2FjaGUnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBQYXRjaFRyYW5zZm9ybUZ1bmMge1xyXG4gIChjYWNoZTogQ2FjaGUsIG9wOiBSZWNvcmRPcGVyYXRpb24pOiBQYXRjaFJlc3VsdERhdGE7XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IHtcclxuICBhZGRSZWNvcmQoY2FjaGU6IENhY2hlLCBvcDogQWRkUmVjb3JkT3BlcmF0aW9uKTogUGF0Y2hSZXN1bHREYXRhIHtcclxuICAgIGxldCByZWNvcmQgPSBvcC5yZWNvcmQ7XHJcbiAgICBjb25zdCByZWNvcmRzID0gY2FjaGUucmVjb3JkcyhyZWNvcmQudHlwZSk7XHJcbiAgICByZWNvcmRzLnNldChyZWNvcmQuaWQsIHJlY29yZCk7XHJcblxyXG4gICAgaWYgKGNhY2hlLmtleU1hcCkge1xyXG4gICAgICBjYWNoZS5rZXlNYXAucHVzaFJlY29yZChyZWNvcmQpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiByZWNvcmQ7XHJcbiAgfSxcclxuXHJcbiAgcmVwbGFjZVJlY29yZChjYWNoZTogQ2FjaGUsIG9wOiBSZXBsYWNlUmVjb3JkT3BlcmF0aW9uKTogUGF0Y2hSZXN1bHREYXRhIHtcclxuICAgIGNvbnN0IHJlcGxhY2VtZW50ID0gb3AucmVjb3JkO1xyXG4gICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gcmVwbGFjZW1lbnQ7XHJcbiAgICBjb25zdCByZWNvcmRzID0gY2FjaGUucmVjb3Jkcyh0eXBlKTtcclxuICAgIGNvbnN0IGN1cnJlbnQgPSByZWNvcmRzLmdldChpZCk7XHJcbiAgICBsZXQgcmVjb3JkOiBSZWNvcmQ7XHJcblxyXG4gICAgaWYgKGN1cnJlbnQpIHtcclxuICAgICAgcmVjb3JkID0geyB0eXBlLCBpZCB9O1xyXG5cclxuICAgICAgWydhdHRyaWJ1dGVzJywgJ2tleXMnLCAncmVsYXRpb25zaGlwcyddLmZvckVhY2goZ3JvdXBpbmcgPT4ge1xyXG4gICAgICAgIGlmIChjdXJyZW50W2dyb3VwaW5nXSAmJiByZXBsYWNlbWVudFtncm91cGluZ10pIHtcclxuICAgICAgICAgIHJlY29yZFtncm91cGluZ10gPSBtZXJnZSh7fSwgY3VycmVudFtncm91cGluZ10sIHJlcGxhY2VtZW50W2dyb3VwaW5nXSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50W2dyb3VwaW5nXSkge1xyXG4gICAgICAgICAgcmVjb3JkW2dyb3VwaW5nXSA9IG1lcmdlKHt9LCBjdXJyZW50W2dyb3VwaW5nXSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChyZXBsYWNlbWVudFtncm91cGluZ10pIHtcclxuICAgICAgICAgIHJlY29yZFtncm91cGluZ10gPSBtZXJnZSh7fSwgcmVwbGFjZW1lbnRbZ3JvdXBpbmddKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmVjb3JkID0gcmVwbGFjZW1lbnQ7XHJcbiAgICB9XHJcblxyXG4gICAgcmVjb3Jkcy5zZXQoaWQsIHJlY29yZCk7XHJcblxyXG4gICAgaWYgKGNhY2hlLmtleU1hcCkge1xyXG4gICAgICBjYWNoZS5rZXlNYXAucHVzaFJlY29yZChyZWNvcmQpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiByZWNvcmQ7XHJcbiAgfSxcclxuXHJcbiAgcmVtb3ZlUmVjb3JkKGNhY2hlOiBDYWNoZSwgb3A6IFJlbW92ZVJlY29yZE9wZXJhdGlvbik6IFBhdGNoUmVzdWx0RGF0YSB7XHJcbiAgICBjb25zdCB7IHR5cGUsIGlkIH0gPSBvcC5yZWNvcmQ7XHJcbiAgICBjb25zdCByZWNvcmRzID0gY2FjaGUucmVjb3Jkcyh0eXBlKTtcclxuICAgIGNvbnN0IHJlc3VsdCA9IHJlY29yZHMuZ2V0KGlkKTtcclxuICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgcmVjb3Jkcy5yZW1vdmUoaWQpO1xyXG4gICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgfSxcclxuXHJcbiAgcmVwbGFjZUtleShjYWNoZTogQ2FjaGUsIG9wOiBSZXBsYWNlS2V5T3BlcmF0aW9uKTogUGF0Y2hSZXN1bHREYXRhIHtcclxuICAgIGNvbnN0IHsgdHlwZSwgaWQgfSA9IG9wLnJlY29yZDtcclxuICAgIGNvbnN0IHJlY29yZHMgPSBjYWNoZS5yZWNvcmRzKHR5cGUpO1xyXG4gICAgbGV0IHJlY29yZCA9IHJlY29yZHMuZ2V0KGlkKTtcclxuICAgIGlmIChyZWNvcmQpIHtcclxuICAgICAgcmVjb3JkID0gY2xvbmUocmVjb3JkKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJlY29yZCA9IHsgdHlwZSwgaWQgfTtcclxuICAgIH1cclxuICAgIGRlZXBTZXQocmVjb3JkLCBbJ2tleXMnLCBvcC5rZXldLCBvcC52YWx1ZSk7XHJcbiAgICByZWNvcmRzLnNldChpZCwgcmVjb3JkKTtcclxuXHJcbiAgICBpZiAoY2FjaGUua2V5TWFwKSB7XHJcbiAgICAgIGNhY2hlLmtleU1hcC5wdXNoUmVjb3JkKHJlY29yZCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHJlY29yZDtcclxuICB9LFxyXG5cclxuICByZXBsYWNlQXR0cmlidXRlKGNhY2hlOiBDYWNoZSwgb3A6IFJlcGxhY2VBdHRyaWJ1dGVPcGVyYXRpb24pOiBQYXRjaFJlc3VsdERhdGEge1xyXG4gICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gb3AucmVjb3JkO1xyXG4gICAgY29uc3QgcmVjb3JkcyA9IGNhY2hlLnJlY29yZHModHlwZSk7XHJcbiAgICBsZXQgcmVjb3JkID0gcmVjb3Jkcy5nZXQoaWQpO1xyXG4gICAgaWYgKHJlY29yZCkge1xyXG4gICAgICByZWNvcmQgPSBjbG9uZShyZWNvcmQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmVjb3JkID0geyB0eXBlLCBpZCB9O1xyXG4gICAgfVxyXG4gICAgZGVlcFNldChyZWNvcmQsIFsnYXR0cmlidXRlcycsIG9wLmF0dHJpYnV0ZV0sIG9wLnZhbHVlKTtcclxuICAgIHJlY29yZHMuc2V0KGlkLCByZWNvcmQpO1xyXG4gICAgcmV0dXJuIHJlY29yZDtcclxuICB9LFxyXG5cclxuICBhZGRUb1JlbGF0ZWRSZWNvcmRzKGNhY2hlOiBDYWNoZSwgb3A6IEFkZFRvUmVsYXRlZFJlY29yZHNPcGVyYXRpb24pOiBQYXRjaFJlc3VsdERhdGEge1xyXG4gICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gb3AucmVjb3JkO1xyXG4gICAgY29uc3QgcmVjb3JkcyA9IGNhY2hlLnJlY29yZHModHlwZSk7XHJcbiAgICBsZXQgcmVjb3JkID0gcmVjb3Jkcy5nZXQoaWQpO1xyXG4gICAgaWYgKHJlY29yZCkge1xyXG4gICAgICByZWNvcmQgPSBjbG9uZShyZWNvcmQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmVjb3JkID0geyB0eXBlLCBpZCB9O1xyXG4gICAgfVxyXG4gICAgY29uc3QgcmVsYXRlZFJlY29yZHMgPSBkZWVwR2V0KHJlY29yZCwgWydyZWxhdGlvbnNoaXBzJywgb3AucmVsYXRpb25zaGlwLCAnZGF0YSddKSB8fCBbXTtcclxuICAgIHJlbGF0ZWRSZWNvcmRzLnB1c2gob3AucmVsYXRlZFJlY29yZCk7XHJcblxyXG4gICAgZGVlcFNldChyZWNvcmQsIFsncmVsYXRpb25zaGlwcycsIG9wLnJlbGF0aW9uc2hpcCwgJ2RhdGEnXSwgcmVsYXRlZFJlY29yZHMpO1xyXG4gICAgcmVjb3Jkcy5zZXQoaWQsIHJlY29yZCk7XHJcbiAgICByZXR1cm4gcmVjb3JkO1xyXG4gIH0sXHJcblxyXG4gIHJlbW92ZUZyb21SZWxhdGVkUmVjb3JkcyhjYWNoZTogQ2FjaGUsIG9wOiBSZW1vdmVGcm9tUmVsYXRlZFJlY29yZHNPcGVyYXRpb24pOiBQYXRjaFJlc3VsdERhdGEge1xyXG4gICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gb3AucmVjb3JkO1xyXG4gICAgY29uc3QgcmVjb3JkcyA9IGNhY2hlLnJlY29yZHModHlwZSk7XHJcbiAgICBsZXQgcmVjb3JkID0gcmVjb3Jkcy5nZXQoaWQpO1xyXG4gICAgaWYgKHJlY29yZCkge1xyXG4gICAgICByZWNvcmQgPSBjbG9uZShyZWNvcmQpO1xyXG4gICAgICBsZXQgcmVsYXRlZFJlY29yZHMgPSBkZWVwR2V0KHJlY29yZCwgWydyZWxhdGlvbnNoaXBzJywgb3AucmVsYXRpb25zaGlwLCAnZGF0YSddKSBhcyBSZWNvcmRJZGVudGl0eVtdO1xyXG4gICAgICBpZiAocmVsYXRlZFJlY29yZHMpIHtcclxuICAgICAgICByZWxhdGVkUmVjb3JkcyA9IHJlbGF0ZWRSZWNvcmRzLmZpbHRlcihyID0+ICFlcXVhbFJlY29yZElkZW50aXRpZXMociwgb3AucmVsYXRlZFJlY29yZCkpO1xyXG5cclxuICAgICAgICBpZiAoZGVlcFNldChyZWNvcmQsIFsncmVsYXRpb25zaGlwcycsIG9wLnJlbGF0aW9uc2hpcCwgJ2RhdGEnXSwgcmVsYXRlZFJlY29yZHMpKSB7XHJcbiAgICAgICAgICByZWNvcmRzLnNldChpZCwgcmVjb3JkKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHJlY29yZDtcclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH0sXHJcblxyXG4gIHJlcGxhY2VSZWxhdGVkUmVjb3JkcyhjYWNoZTogQ2FjaGUsIG9wOiBSZXBsYWNlUmVsYXRlZFJlY29yZHNPcGVyYXRpb24pOiBQYXRjaFJlc3VsdERhdGEge1xyXG4gICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gb3AucmVjb3JkO1xyXG4gICAgY29uc3QgcmVjb3JkcyA9IGNhY2hlLnJlY29yZHModHlwZSk7XHJcbiAgICBsZXQgcmVjb3JkID0gcmVjb3Jkcy5nZXQoaWQpO1xyXG4gICAgaWYgKHJlY29yZCkge1xyXG4gICAgICByZWNvcmQgPSBjbG9uZShyZWNvcmQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmVjb3JkID0geyB0eXBlLCBpZCB9O1xyXG4gICAgfVxyXG4gICAgaWYgKGRlZXBTZXQocmVjb3JkLCBbJ3JlbGF0aW9uc2hpcHMnLCBvcC5yZWxhdGlvbnNoaXAsICdkYXRhJ10sIG9wLnJlbGF0ZWRSZWNvcmRzKSkge1xyXG4gICAgICByZWNvcmRzLnNldChpZCwgcmVjb3JkKTtcclxuICAgIH1cclxuICAgIHJldHVybiByZWNvcmQ7XHJcbiAgfSxcclxuXHJcbiAgcmVwbGFjZVJlbGF0ZWRSZWNvcmQoY2FjaGU6IENhY2hlLCBvcDogUmVwbGFjZVJlbGF0ZWRSZWNvcmRPcGVyYXRpb24pOiBQYXRjaFJlc3VsdERhdGEge1xyXG4gICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gb3AucmVjb3JkO1xyXG4gICAgY29uc3QgcmVjb3JkcyA9IGNhY2hlLnJlY29yZHModHlwZSk7XHJcbiAgICBsZXQgcmVjb3JkID0gcmVjb3Jkcy5nZXQoaWQpO1xyXG4gICAgaWYgKHJlY29yZCkge1xyXG4gICAgICByZWNvcmQgPSBjbG9uZShyZWNvcmQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmVjb3JkID0geyB0eXBlLCBpZCB9O1xyXG4gICAgfVxyXG4gICAgaWYgKGRlZXBTZXQocmVjb3JkLCBbJ3JlbGF0aW9uc2hpcHMnLCBvcC5yZWxhdGlvbnNoaXAsICdkYXRhJ10sIG9wLnJlbGF0ZWRSZWNvcmQpKSB7XHJcbiAgICAgIHJlY29yZHMuc2V0KGlkLCByZWNvcmQpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlY29yZDtcclxuICB9XHJcbn07XHJcbiJdfQ==