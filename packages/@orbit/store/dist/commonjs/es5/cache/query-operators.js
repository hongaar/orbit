"use strict";

Object.defineProperty(exports, "__esModule", { value: true });
var utils_1 = require("@orbit/utils");
var data_1 = require("@orbit/data");
var EMPTY = function () {};
exports.QueryOperators = {
    findRecord: function (cache, expression) {
        var _a = expression.record,
            type = _a.type,
            id = _a.id;
        var record = cache.records(type).get(id);
        if (!record) {
            throw new data_1.RecordNotFoundException(type, id);
        }
        return record;
    },
    findRecords: function (cache, expression) {
        var results = Array.from(cache.records(expression.type).values());
        if (expression.filter) {
            results = filterRecords(results, expression.filter);
        }
        if (expression.sort) {
            results = sortRecords(results, expression.sort);
        }
        if (expression.page) {
            results = paginateRecords(results, expression.page);
        }
        return results;
    },
    findRelatedRecords: function (cache, expression) {
        var record = expression.record,
            relationship = expression.relationship;
        var type = record.type,
            id = record.id;
        var currentRecord = cache.records(type).get(id);
        var data = currentRecord && utils_1.deepGet(currentRecord, ['relationships', relationship, 'data']);
        if (!data) {
            return [];
        }
        return data.map(function (r) {
            return cache.records(r.type).get(r.id);
        });
    },
    findRelatedRecord: function (cache, expression) {
        var record = expression.record,
            relationship = expression.relationship;
        var type = record.type,
            id = record.id;
        var currentRecord = cache.records(type).get(id);
        var data = currentRecord && utils_1.deepGet(currentRecord, ['relationships', relationship, 'data']);
        if (!data) {
            return null;
        }
        var r = data;
        return cache.records(r.type).get(r.id);
    }
};
function filterRecords(records, filters) {
    return records.filter(function (record) {
        for (var i = 0, l = filters.length; i < l; i++) {
            if (!applyFilter(record, filters[i])) {
                return false;
            }
        }
        return true;
    });
}
function applyFilter(record, filter) {
    if (filter.kind === 'attribute') {
        var actual = utils_1.deepGet(record, ['attributes', filter.attribute]);
        var expected = filter.value;
        switch (filter.op) {
            case 'equal':
                return actual === expected;
            case 'gt':
                return actual > expected;
            case 'gte':
                return actual >= expected;
            case 'lt':
                return actual < expected;
            case 'lte':
                return actual <= expected;
            default:
                throw new data_1.QueryExpressionParseError('Filter operation ${filter.op} not recognized for Store.', filter);
        }
    }
    return false;
}
function sortRecords(records, sortSpecifiers) {
    var comparisonValues = new Map();
    records.forEach(function (record) {
        comparisonValues.set(record, sortSpecifiers.map(function (sortSpecifier) {
            if (sortSpecifier.kind === 'attribute') {
                return utils_1.deepGet(record, ['attributes', sortSpecifier.attribute]);
            } else {
                throw new data_1.QueryExpressionParseError('Sort specifier ${sortSpecifier.kind} not recognized for Store.', sortSpecifier);
            }
        }));
    });
    var comparisonOrders = sortSpecifiers.map(function (sortExpression) {
        return sortExpression.order === 'descending' ? -1 : 1;
    });
    return records.sort(function (record1, record2) {
        var values1 = comparisonValues.get(record1);
        var values2 = comparisonValues.get(record2);
        for (var i = 0; i < sortSpecifiers.length; i++) {
            if (values1[i] < values2[i]) {
                return -comparisonOrders[i];
            } else if (values1[i] > values2[i]) {
                return comparisonOrders[i];
            } else if (utils_1.isNone(values1[i]) && !utils_1.isNone(values2[i])) {
                return comparisonOrders[i];
            } else if (utils_1.isNone(values2[i]) && !utils_1.isNone(values1[i])) {
                return -comparisonOrders[i];
            }
        }
        return 0;
    });
}
function paginateRecords(records, paginationOptions) {
    if (paginationOptions.limit !== undefined) {
        var offset = paginationOptions.offset === undefined ? 0 : paginationOptions.offset;
        var limit = paginationOptions.limit;
        return records.slice(offset, offset + limit);
    } else {
        throw new data_1.QueryExpressionParseError('Pagination options not recognized for Store. Please specify `offset` and `limit`.', paginationOptions);
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnktb3BlcmF0b3JzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NhY2hlL3F1ZXJ5LW9wZXJhdG9ycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxzQkFBeUU7QUFDekUscUJBWXFCO0FBR3JCLElBQU0sQUFBSyxRQUFHLFlBQU8sQUFBQyxBQUFDO0FBVVYsUUFBQSxBQUFjOzBCQUNkLEFBQVksT0FBRSxBQUFzQixZQUN2QztZQUFBLGdCQUFnQztZQUE5QixVQUFJO1lBQUUsUUFBRSxBQUF1QixBQUN2QztZQUFNLEFBQU0sU0FBRyxBQUFLLE1BQUMsQUFBTyxRQUFDLEFBQUksQUFBQyxNQUFDLEFBQUcsSUFBQyxBQUFFLEFBQUMsQUFBQyxBQUUzQyxBQUFFLEFBQUM7WUFBQyxDQUFDLEFBQU0sQUFBQyxRQUFDLEFBQUMsQUFDWjtrQkFBTSxJQUFJLE9BQXVCLHdCQUFDLEFBQUksTUFBRSxBQUFFLEFBQUMsQUFBQyxBQUM5QyxBQUFDO0FBRUQsQUFBTTtlQUFDLEFBQU0sQUFBQyxBQUNoQixBQUFDO0FBRUQsQUFBVzsyQkFBQyxBQUFZLE9BQUUsQUFBdUIsWUFDL0M7WUFBSSxBQUFPLFVBQUcsQUFBSyxNQUFDLEFBQUksS0FBQyxBQUFLLE1BQUMsQUFBTyxRQUFDLEFBQVUsV0FBQyxBQUFJLEFBQUMsTUFBQyxBQUFNLEFBQUUsQUFBQyxBQUFDLEFBQ2xFLEFBQUUsQUFBQztZQUFDLEFBQVUsV0FBQyxBQUFNLEFBQUMsUUFBQyxBQUFDLEFBQ3RCLEFBQU87c0JBQUcsQUFBYSxjQUFDLEFBQU8sU0FBRSxBQUFVLFdBQUMsQUFBTSxBQUFDLEFBQUMsQUFDdEQsQUFBQztBQUNELEFBQUUsQUFBQztZQUFDLEFBQVUsV0FBQyxBQUFJLEFBQUMsTUFBQyxBQUFDLEFBQ3BCLEFBQU87c0JBQUcsQUFBVyxZQUFDLEFBQU8sU0FBRSxBQUFVLFdBQUMsQUFBSSxBQUFDLEFBQUMsQUFDbEQsQUFBQztBQUNELEFBQUUsQUFBQztZ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QyxBQUFDLEFBQUMsT0FBSSxDQUFDLFFBQU0sT0FBQyxBQUFPLFFBQUMsQUFBQyxBQUFDLEFBQUMsQUFBQyxLQUFDLEFBQUMsQUFDckQsQUFBTTt1QkFBQyxDQUFDLEFBQWdCLGlCQUFDLEFBQUMsQUFBQyxBQUFDLEFBQzlCLEFBQUMsQUFDSDtBQUFDO0FBQ0QsQUFBTTtlQUFDLEFBQUMsQUFBQyxBQUNYLEFBQUMsQUFBQyxBQUFDLEFBQ0w7QUFoQlMsQUFBTyxBQWdCZjs7QUFFRCx5QkFBeUIsQUFBTyxTQUFFLEFBQWlCLG1CQUNqRCxBQUFFLEFBQUM7UUFBQyxBQUFpQixrQkFBQyxBQUFLLFVBQUssQUFBUyxBQUFDLFdBQUMsQUFBQyxBQUMxQztZQUFJLEFBQU0sU0FBRyxBQUFpQixrQkFBQyxBQUFNLFdBQUssQUFBUyxZQUFHLEFBQUMsSUFBRyxBQUFpQixrQkFBQyxBQUFNLEFBQUMsQUFDbkY7WUFBSSxBQUFLLFFBQUcsQUFBaUIsa0JBQUMsQUFBSyxBQUFDLEFBRXBDLEFBQU07ZUFBQyxBQUFPLFFBQUMsQUFBSyxNQUFDLEFBQU0sUUFBRSxBQUFNLFNBQUcsQUFBSyxBQUFDLEFBQUMsQUFFL0MsQUFBQyxBQUFDLEFBQUk7V0FBQyxBQUFDLEFBQ047Y0FBTSxJQUFJLE9BQXlCLDBCQUFDLEFBQW1GLHFGQUFFLEFBQWlCLEFBQUMsQUFBQyxBQUM5SSxBQUFDLEFBQ0g7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpY3QsIGRlZXBHZXQsIG1lcmdlLCBldmVyeSwgc29tZSwgaXNOb25lIH0gZnJvbSAnQG9yYml0L3V0aWxzJztcclxuaW1wb3J0IHtcclxuICBRdWVyeUV4cHJlc3Npb24sXHJcbiAgUmVjb3JkTm90Rm91bmRFeGNlcHRpb24sXHJcbiAgUXVlcnlFeHByZXNzaW9uUGFyc2VFcnJvcixcclxuICBGaW5kUmVjb3JkLFxyXG4gIEZpbmRSZWNvcmRzLFxyXG4gIEZpbmRSZWxhdGVkUmVjb3JkLFxyXG4gIEZpbmRSZWxhdGVkUmVjb3JkcyxcclxuICBTb3J0U3BlY2lmaWVyLFxyXG4gIEF0dHJpYnV0ZVNvcnRTcGVjaWZpZXIsXHJcbiAgUmVjb3JkLFxyXG4gIFJlY29yZElkZW50aXR5XHJcbn0gZnJvbSAnQG9yYml0L2RhdGEnO1xyXG5pbXBvcnQgQ2FjaGUgZnJvbSAnLi4vY2FjaGUnO1xyXG5cclxuY29uc3QgRU1QVFkgPSAoKSA9PiB7fTtcclxuXHJcbi8qKlxyXG4gKiBAZXhwb3J0XHJcbiAqIEBpbnRlcmZhY2UgUXVlcnlPcGVyYXRvclxyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBRdWVyeU9wZXJhdG9yIHtcclxuICAoY2FjaGU6IENhY2hlLCBleHByZXNzaW9uOiBRdWVyeUV4cHJlc3Npb24pOiBhbnk7XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBRdWVyeU9wZXJhdG9yczogRGljdDxRdWVyeU9wZXJhdG9yPiA9IHtcclxuICBmaW5kUmVjb3JkKGNhY2hlOiBDYWNoZSwgZXhwcmVzc2lvbjogRmluZFJlY29yZCkge1xyXG4gICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gZXhwcmVzc2lvbi5yZWNvcmQ7XHJcbiAgICBjb25zdCByZWNvcmQgPSBjYWNoZS5yZWNvcmRzKHR5cGUpLmdldChpZCk7XHJcblxyXG4gICAgaWYgKCFyZWNvcmQpIHtcclxuICAgICAgdGhyb3cgbmV3IFJlY29yZE5vdEZvdW5kRXhjZXB0aW9uKHR5cGUsIGlkKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcmVjb3JkO1xyXG4gIH0sXHJcblxyXG4gIGZpbmRSZWNvcmRzKGNhY2hlOiBDYWNoZSwgZXhwcmVzc2lvbjogRmluZFJlY29yZHMpIHtcclxuICAgIGxldCByZXN1bHRzID0gQXJyYXkuZnJvbShjYWNoZS5yZWNvcmRzKGV4cHJlc3Npb24udHlwZSkudmFsdWVzKCkpO1xyXG4gICAgaWYgKGV4cHJlc3Npb24uZmlsdGVyKSB7XHJcbiAgICAgIHJlc3VsdHMgPSBmaWx0ZXJSZWNvcmRzKHJlc3VsdHMsIGV4cHJlc3Npb24uZmlsdGVyKTtcclxuICAgIH1cclxuICAgIGlmIChleHByZXNzaW9uLnNvcnQpIHtcclxuICAgICAgcmVzdWx0cyA9IHNvcnRSZWNvcmRzKHJlc3VsdHMsIGV4cHJlc3Npb24uc29ydCk7XHJcbiAgICB9XHJcbiAgICBpZiAoZXhwcmVzc2lvbi5wYWdlKSB7XHJcbiAgICAgIHJlc3VsdHMgPSBwYWdpbmF0ZVJlY29yZHMocmVzdWx0cywgZXhwcmVzc2lvbi5wYWdlKTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHRzO1xyXG4gIH0sXHJcblxyXG4gIGZpbmRSZWxhdGVkUmVjb3JkcyhjYWNoZTogQ2FjaGUsIGV4cHJlc3Npb246IEZpbmRSZWxhdGVkUmVjb3Jkcykge1xyXG4gICAgY29uc3QgeyByZWNvcmQsIHJlbGF0aW9uc2hpcCB9ID0gZXhwcmVzc2lvbjtcclxuICAgIGNvbnN0IHsgdHlwZSwgaWQgfSA9IHJlY29yZDtcclxuICAgIGNvbnN0IGN1cnJlbnRSZWNvcmQgPSBjYWNoZS5yZWNvcmRzKHR5cGUpLmdldChpZCk7XHJcbiAgICBjb25zdCBkYXRhID0gY3VycmVudFJlY29yZCAmJiBkZWVwR2V0KGN1cnJlbnRSZWNvcmQsIFsncmVsYXRpb25zaGlwcycsIHJlbGF0aW9uc2hpcCwgJ2RhdGEnXSk7XHJcblxyXG4gICAgaWYgKCFkYXRhKSB7IHJldHVybiBbXTsgfVxyXG5cclxuICAgIHJldHVybiAoZGF0YSBhcyBSZWNvcmRJZGVudGl0eVtdKS5tYXAociA9PiBjYWNoZS5yZWNvcmRzKHIudHlwZSkuZ2V0KHIuaWQpKTtcclxuICB9LFxyXG5cclxuICBmaW5kUmVsYXRlZFJlY29yZChjYWNoZTogQ2FjaGUsIGV4cHJlc3Npb246IEZpbmRSZWxhdGVkUmVjb3JkKSB7XHJcbiAgICBjb25zdCB7IHJlY29yZCwgcmVsYXRpb25zaGlwIH0gPSBleHByZXNzaW9uO1xyXG4gICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gcmVjb3JkO1xyXG4gICAgY29uc3QgY3VycmVudFJlY29yZCA9IGNhY2hlLnJlY29yZHModHlwZSkuZ2V0KGlkKTtcclxuICAgIGNvbnN0IGRhdGEgPSBjdXJyZW50UmVjb3JkICYmIGRlZXBHZXQoY3VycmVudFJlY29yZCwgWydyZWxhdGlvbnNoaXBzJywgcmVsYXRpb25zaGlwLCAnZGF0YSddKTtcclxuXHJcbiAgICBpZiAoIWRhdGEpIHsgcmV0dXJuIG51bGw7IH1cclxuXHJcbiAgICBjb25zdCByID0gZGF0YSBhcyBSZWNvcmRJZGVudGl0eTtcclxuICAgIHJldHVybiBjYWNoZS5yZWNvcmRzKHIudHlwZSkuZ2V0KHIuaWQpO1xyXG4gIH1cclxufTtcclxuXHJcbmZ1bmN0aW9uIGZpbHRlclJlY29yZHMocmVjb3JkcywgZmlsdGVycykge1xyXG4gIHJldHVybiByZWNvcmRzLmZpbHRlcihyZWNvcmQgPT4ge1xyXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBmaWx0ZXJzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgICBpZiAoIWFwcGx5RmlsdGVyKHJlY29yZCwgZmlsdGVyc1tpXSkpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBhcHBseUZpbHRlcihyZWNvcmQsIGZpbHRlcikge1xyXG4gIGlmIChmaWx0ZXIua2luZCA9PT0gJ2F0dHJpYnV0ZScpIHtcclxuICAgIGxldCBhY3R1YWwgPSBkZWVwR2V0KHJlY29yZCwgWydhdHRyaWJ1dGVzJywgZmlsdGVyLmF0dHJpYnV0ZV0pO1xyXG4gICAgbGV0IGV4cGVjdGVkID0gZmlsdGVyLnZhbHVlO1xyXG4gICAgc3dpdGNoKGZpbHRlci5vcCkge1xyXG4gICAgICBjYXNlICdlcXVhbCc6IHJldHVybiBhY3R1YWwgPT09IGV4cGVjdGVkO1xyXG4gICAgICBjYXNlICdndCc6ICAgIHJldHVybiBhY3R1YWwgPiBleHBlY3RlZDtcclxuICAgICAgY2FzZSAnZ3RlJzogICByZXR1cm4gYWN0dWFsID49IGV4cGVjdGVkO1xyXG4gICAgICBjYXNlICdsdCc6ICAgIHJldHVybiBhY3R1YWwgPCBleHBlY3RlZDtcclxuICAgICAgY2FzZSAnbHRlJzogICByZXR1cm4gYWN0dWFsIDw9IGV4cGVjdGVkO1xyXG4gICAgICBkZWZhdWx0OlxyXG4gICAgICAgIHRocm93IG5ldyBRdWVyeUV4cHJlc3Npb25QYXJzZUVycm9yKCdGaWx0ZXIgb3BlcmF0aW9uICR7ZmlsdGVyLm9wfSBub3QgcmVjb2duaXplZCBmb3IgU3RvcmUuJywgZmlsdGVyKTtcclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIGZhbHNlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzb3J0UmVjb3JkcyhyZWNvcmRzOiBSZWNvcmRbXSwgc29ydFNwZWNpZmllcnM6IFNvcnRTcGVjaWZpZXJbXSkge1xyXG4gIGNvbnN0IGNvbXBhcmlzb25WYWx1ZXMgPSBuZXcgTWFwKCk7XHJcblxyXG4gIHJlY29yZHMuZm9yRWFjaChyZWNvcmQgPT4ge1xyXG4gICAgY29tcGFyaXNvblZhbHVlcy5zZXQoXHJcbiAgICAgIHJlY29yZCxcclxuICAgICAgc29ydFNwZWNpZmllcnMubWFwKHNvcnRTcGVjaWZpZXIgPT4ge1xyXG4gICAgICAgIGlmIChzb3J0U3BlY2lmaWVyLmtpbmQgPT09ICdhdHRyaWJ1dGUnKSB7XHJcbiAgICAgICAgICByZXR1cm4gZGVlcEdldChyZWNvcmQsIFsnYXR0cmlidXRlcycgLCAoPEF0dHJpYnV0ZVNvcnRTcGVjaWZpZXI+c29ydFNwZWNpZmllcikuYXR0cmlidXRlXSlcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXhwcmVzc2lvblBhcnNlRXJyb3IoJ1NvcnQgc3BlY2lmaWVyICR7c29ydFNwZWNpZmllci5raW5kfSBub3QgcmVjb2duaXplZCBmb3IgU3RvcmUuJywgc29ydFNwZWNpZmllcik7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9KTtcclxuXHJcbiAgY29uc3QgY29tcGFyaXNvbk9yZGVycyA9IHNvcnRTcGVjaWZpZXJzLm1hcChcclxuICAgIHNvcnRFeHByZXNzaW9uID0+IHNvcnRFeHByZXNzaW9uLm9yZGVyID09PSAnZGVzY2VuZGluZycgPyAtMSA6IDEpO1xyXG5cclxuICByZXR1cm4gcmVjb3Jkcy5zb3J0KChyZWNvcmQxLCByZWNvcmQyKSA9PiB7XHJcbiAgICBjb25zdCB2YWx1ZXMxID0gY29tcGFyaXNvblZhbHVlcy5nZXQocmVjb3JkMSk7XHJcbiAgICBjb25zdCB2YWx1ZXMyID0gY29tcGFyaXNvblZhbHVlcy5nZXQocmVjb3JkMik7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNvcnRTcGVjaWZpZXJzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGlmICh2YWx1ZXMxW2ldIDwgdmFsdWVzMltpXSkge1xyXG4gICAgICAgIHJldHVybiAtY29tcGFyaXNvbk9yZGVyc1tpXTtcclxuICAgICAgfSBlbHNlIGlmICh2YWx1ZXMxW2ldID4gdmFsdWVzMltpXSkge1xyXG4gICAgICAgIHJldHVybiBjb21wYXJpc29uT3JkZXJzW2ldO1xyXG4gICAgICB9IGVsc2UgaWYgKGlzTm9uZSh2YWx1ZXMxW2ldKSAmJiAhaXNOb25lKHZhbHVlczJbaV0pKSB7XHJcbiAgICAgICAgcmV0dXJuIGNvbXBhcmlzb25PcmRlcnNbaV07XHJcbiAgICAgIH0gZWxzZSBpZiAoaXNOb25lKHZhbHVlczJbaV0pICYmICFpc05vbmUodmFsdWVzMVtpXSkpIHtcclxuICAgICAgICByZXR1cm4gLWNvbXBhcmlzb25PcmRlcnNbaV07XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiAwO1xyXG4gIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwYWdpbmF0ZVJlY29yZHMocmVjb3JkcywgcGFnaW5hdGlvbk9wdGlvbnMpIHtcclxuICBpZiAocGFnaW5hdGlvbk9wdGlvbnMubGltaXQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgbGV0IG9mZnNldCA9IHBhZ2luYXRpb25PcHRpb25zLm9mZnNldCA9PT0gdW5kZWZpbmVkID8gMCA6IHBhZ2luYXRpb25PcHRpb25zLm9mZnNldDtcclxuICAgIGxldCBsaW1pdCA9IHBhZ2luYXRpb25PcHRpb25zLmxpbWl0O1xyXG5cclxuICAgIHJldHVybiByZWNvcmRzLnNsaWNlKG9mZnNldCwgb2Zmc2V0ICsgbGltaXQpO1xyXG5cclxuICB9IGVsc2Uge1xyXG4gICAgdGhyb3cgbmV3IFF1ZXJ5RXhwcmVzc2lvblBhcnNlRXJyb3IoJ1BhZ2luYXRpb24gb3B0aW9ucyBub3QgcmVjb2duaXplZCBmb3IgU3RvcmUuIFBsZWFzZSBzcGVjaWZ5IGBvZmZzZXRgIGFuZCBgbGltaXRgLicsIHBhZ2luYXRpb25PcHRpb25zKTtcclxuICB9XHJcbn1cclxuIl19