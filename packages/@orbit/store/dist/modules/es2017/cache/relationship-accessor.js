"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var utils_1 = require("@orbit/utils");
var data_1 = require("@orbit/data");
var immutable_1 = require("@orbit/immutable");
var record_identity_map_1 = require("./record-identity-map");
var RelationshipAccessor = (function () {
    function RelationshipAccessor(cache, base) {
        this._cache = cache;
        this.reset(base);
    }
    RelationshipAccessor.prototype.reset = function (base) {
        var relationships = {};
        Object.keys(this._cache.schema.models).forEach(function (type) {
            var baseRelationships = base && base._relationships[type];
            relationships[type] = new immutable_1.ImmutableMap(baseRelationships);
        });
        this._relationships = relationships;
    };
    RelationshipAccessor.prototype.relationshipExists = function (record, relationship, relatedRecord) {
        var rels = this._relationships[record.type].get(record.id);
        if (rels) {
            var rel = rels[relationship];
            if (rel) {
                if (rel instanceof record_identity_map_1.default) {
                    return rel.has(relatedRecord);
                }
                else {
                    return data_1.equalRecordIdentities(relatedRecord, rel);
                }
            }
        }
        return !relatedRecord;
    };
    RelationshipAccessor.prototype.relatedRecord = function (record, relationship) {
        var rels = this._relationships[record.type].get(record.id);
        if (rels) {
            return rels[relationship];
        }
    };
    RelationshipAccessor.prototype.relatedRecords = function (record, relationship) {
        var rels = this._relationships[record.type].get(record.id);
        var map = rels && rels[relationship];
        if (map) {
            return Array.from(map.values);
        }
    };
    RelationshipAccessor.prototype.relatedRecordsMap = function (record, relationship) {
        var rels = this._relationships[record.type].get(record.id);
        if (rels) {
            return rels[relationship];
        }
    };
    RelationshipAccessor.prototype.relatedRecordsMatch = function (record, relationship, relatedRecords) {
        var map = this.relatedRecordsMap(record, relationship);
        if (map) {
            var otherMap_1 = new record_identity_map_1.default;
            relatedRecords.forEach(function (id) { return otherMap_1.add(id); });
            return map.equals(otherMap_1);
        }
        else {
            return relatedRecords.length === 0;
        }
    };
    RelationshipAccessor.prototype.addRecord = function (record) {
        if (record.relationships) {
            var rels_1 = {};
            Object.keys(record.relationships).forEach(function (name) {
                var rel = record.relationships[name];
                if (rel.data !== undefined) {
                    if (utils_1.isArray(rel.data)) {
                        var relMap_1 = rels_1[name] = new record_identity_map_1.default();
                        rel.data.forEach(function (r) { return relMap_1.add(r); });
                    }
                    else {
                        rels_1[name] = rel.data;
                    }
                }
            });
            this._relationships[record.type].set(record.id, rels_1);
        }
    };
    RelationshipAccessor.prototype.replaceRecord = function (record) {
        this.addRecord(record);
    };
    RelationshipAccessor.prototype.clearRecord = function (record) {
        this._relationships[record.type].remove(record.id);
    };
    RelationshipAccessor.prototype.addToRelatedRecords = function (record, relationship, relatedRecord) {
        var currentRels = this._relationships[record.type].get(record.id);
        var rels = currentRels ? cloneRelationships(currentRels) : {};
        var rel = rels[relationship];
        if (!rel) {
            rel = rels[relationship] = new record_identity_map_1.default();
        }
        rel.add(relatedRecord);
        this._relationships[record.type].set(record.id, rels);
    };
    RelationshipAccessor.prototype.removeFromRelatedRecords = function (record, relationship, relatedRecord) {
        var currentRels = this._relationships[record.type].get(record.id);
        if (currentRels && currentRels[relationship]) {
            var rels = cloneRelationships(currentRels);
            var rel = rels[relationship];
            rel.remove(relatedRecord);
            this._relationships[record.type].set(record.id, rels);
        }
    };
    RelationshipAccessor.prototype.replaceRelatedRecords = function (record, relationship, relatedRecords) {
        var currentRels = this._relationships[record.type].get(record.id);
        var rels = currentRels ? cloneRelationships(currentRels) : {};
        var rel = rels[relationship];
        if (!rel) {
            rel = rels[relationship] = new record_identity_map_1.default();
        }
        relatedRecords.forEach(function (relatedRecord) { return rel.add(relatedRecord); });
        this._relationships[record.type].set(record.id, rels);
    };
    RelationshipAccessor.prototype.replaceRelatedRecord = function (record, relationship, relatedRecord) {
        var currentRels = this._relationships[record.type].get(record.id);
        if ((currentRels && currentRels[relationship]) || relatedRecord) {
            var rels = currentRels ? cloneRelationships(currentRels) : {};
            rels[relationship] = relatedRecord;
            this._relationships[record.type].set(record.id, rels);
        }
    };
    return RelationshipAccessor;
}());
exports.default = RelationshipAccessor;
function cloneRelationships(rels) {
    var clonedRels = {};
    if (rels) {
        Object.keys(rels).forEach(function (name) {
            var value = rels[name];
            if (value instanceof record_identity_map_1.default) {
                clonedRels[name] = new record_identity_map_1.default(value);
            }
            else {
                clonedRels[name] = value;
            }
        });
    }
    return clonedRels;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVsYXRpb25zaGlwLWFjY2Vzc29yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NhY2hlL3JlbGF0aW9uc2hpcC1hY2Nlc3Nvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUE4RDtBQUM5RCxvQ0FJcUI7QUFFckIsOENBQWdEO0FBQ2hELDZEQUFzRDtBQUV0RDtJQUlFLDhCQUFZLEtBQVksRUFBRSxJQUEyQjtRQUNuRCxJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztRQUNwQixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ25CLENBQUM7SUFFRCxvQ0FBSyxHQUFMLFVBQU0sSUFBMkI7UUFDL0IsSUFBSSxhQUFhLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUEsSUFBSTtZQUNqRCxJQUFJLGlCQUFpQixHQUFHLElBQUksSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzFELGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLHdCQUFZLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUM1RCxDQUFDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxjQUFjLEdBQUcsYUFBYSxDQUFDO0lBQ3RDLENBQUM7SUFFRCxpREFBa0IsR0FBbEIsVUFBbUIsTUFBc0IsRUFBRSxZQUFvQixFQUFFLGFBQTZCO1FBQzVGLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDM0QsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNULElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUM3QixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUNSLEVBQUUsQ0FBQyxDQUFDLEdBQUcsWUFBWSw2QkFBaUIsQ0FBQyxDQUFDLENBQUM7b0JBQ3JDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO2dCQUNoQyxDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNOLE1BQU0sQ0FBQyw0QkFBcUIsQ0FBQyxhQUFhLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQ25ELENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztRQUNELE1BQU0sQ0FBQyxDQUFDLGFBQWEsQ0FBQztJQUN4QixDQUFDO0lBRUQsNENBQWEsR0FBYixVQUFjLE1BQXNCLEVBQUUsWUFBb0I7UUFDeEQsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUMzRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ1QsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQW1CLENBQUM7UUFDOUMsQ0FBQztJQUNILENBQUM7SUFFRCw2Q0FBYyxHQUFkLFVBQWUsTUFBc0IsRUFBRSxZQUFvQjtRQUN6RCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzNELElBQUksR0FBRyxHQUFHLElBQUksSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFzQixDQUFDO1FBQzFELEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDUixNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDaEMsQ0FBQztJQUNILENBQUM7SUFFRCxnREFBaUIsR0FBakIsVUFBa0IsTUFBc0IsRUFBRSxZQUFvQjtRQUM1RCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzNELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDVCxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBc0IsQ0FBQztRQUNqRCxDQUFDO0lBQ0gsQ0FBQztJQUVELGtEQUFtQixHQUFuQixVQUFvQixNQUFzQixFQUFFLFlBQW9CLEVBQUUsY0FBZ0M7UUFDaEcsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sRUFBRSxZQUFZLENBQUMsQ0FBQztRQUN2RCxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ1IsSUFBSSxVQUFRLEdBQUcsSUFBSSw2QkFBaUIsQ0FBQztZQUNyQyxjQUFjLENBQUMsT0FBTyxDQUFDLFVBQUEsRUFBRSxJQUFJLE9BQUEsVUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBaEIsQ0FBZ0IsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFVBQVEsQ0FBQyxDQUFDO1FBQzlCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQztRQUNyQyxDQUFDO0lBQ0gsQ0FBQztJQUVELHdDQUFTLEdBQVQsVUFBVSxNQUFjO1FBQ3RCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLElBQU0sTUFBSSxHQUFHLEVBQUUsQ0FBQztZQUNoQixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQSxJQUFJO2dCQUM1QyxJQUFJLEdBQUcsR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNyQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7b0JBQzNCLEVBQUUsQ0FBQyxDQUFDLGVBQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUN0QixJQUFJLFFBQU0sR0FBRyxNQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSw2QkFBaUIsRUFBRSxDQUFDO3dCQUNqRCxHQUFHLENBQUMsSUFBeUIsQ0FBQyxPQUFPLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxRQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFiLENBQWEsQ0FBQyxDQUFDO29CQUM3RCxDQUFDO29CQUFDLElBQUksQ0FBQyxDQUFDO3dCQUNOLE1BQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO29CQUN4QixDQUFDO2dCQUNILENBQUM7WUFDSCxDQUFDLENBQUMsQ0FBQztZQUNILElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLE1BQUksQ0FBQyxDQUFDO1FBQ3hELENBQUM7SUFDSCxDQUFDO0lBRUQsNENBQWEsR0FBYixVQUFjLE1BQWM7UUFDMUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN6QixDQUFDO0lBRUQsMENBQVcsR0FBWCxVQUFZLE1BQXNCO1FBQ2hDLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVELGtEQUFtQixHQUFuQixVQUFvQixNQUFzQixFQUFFLFlBQW9CLEVBQUUsYUFBNkI7UUFDN0YsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNsRSxJQUFJLElBQUksR0FBRyxXQUFXLEdBQUcsa0JBQWtCLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzlELElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUM3QixFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDVCxHQUFHLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLElBQUksNkJBQWlCLEVBQUUsQ0FBQztRQUNyRCxDQUFDO1FBQ0QsR0FBRyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN2QixJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBRUQsdURBQXdCLEdBQXhCLFVBQXlCLE1BQXNCLEVBQUUsWUFBb0IsRUFBRSxhQUE2QjtRQUNsRyxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2xFLEVBQUUsQ0FBQyxDQUFDLFdBQVcsSUFBSSxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdDLElBQUksSUFBSSxHQUFHLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQzNDLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUM3QixHQUFHLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQzFCLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3hELENBQUM7SUFDSCxDQUFDO0lBRUQsb0RBQXFCLEdBQXJCLFVBQXNCLE1BQXNCLEVBQUUsWUFBb0IsRUFBRSxjQUFnQztRQUNsRyxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2xFLElBQUksSUFBSSxHQUFHLFdBQVcsR0FBRyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDOUQsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzdCLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNULEdBQUcsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsSUFBSSw2QkFBaUIsRUFBRSxDQUFDO1FBQ3JELENBQUM7UUFDRCxjQUFjLENBQUMsT0FBTyxDQUFDLFVBQUEsYUFBYSxJQUFJLE9BQUEsR0FBRyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsRUFBdEIsQ0FBc0IsQ0FBQyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3hELENBQUM7SUFFRCxtREFBb0IsR0FBcEIsVUFBcUIsTUFBc0IsRUFBRSxZQUFvQixFQUFFLGFBQTZCO1FBQzlGLElBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbEUsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLElBQUksV0FBVyxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksYUFBYSxDQUFDLENBQUMsQ0FBQztZQUNoRSxJQUFJLElBQUksR0FBRyxXQUFXLEdBQUcsa0JBQWtCLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQzlELElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxhQUFhLENBQUM7WUFDbkMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDeEQsQ0FBQztJQUNILENBQUM7SUFDSCwyQkFBQztBQUFELENBQUMsQUFwSUQsSUFvSUM7O0FBRUQsNEJBQTRCLElBQUk7SUFDOUIsSUFBTSxVQUFVLEdBQUcsRUFBRSxDQUFDO0lBQ3RCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDVCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFBLElBQUk7WUFDNUIsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3ZCLEVBQUUsQ0FBQyxDQUFDLEtBQUssWUFBWSw2QkFBaUIsQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZDLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLDZCQUFpQixDQUFDLEtBQTBCLENBQUMsQ0FBQztZQUN2RSxDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sVUFBVSxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQztZQUMzQixDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0QsTUFBTSxDQUFDLFVBQVUsQ0FBQztBQUNwQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY2xvbmUsIERpY3QsIGlzT2JqZWN0LCBpc0FycmF5IH0gZnJvbSAnQG9yYml0L3V0aWxzJztcclxuaW1wb3J0IHtcclxuICBlcXVhbFJlY29yZElkZW50aXRpZXMsXHJcbiAgUmVjb3JkLFxyXG4gIFJlY29yZElkZW50aXR5XHJcbn0gZnJvbSAnQG9yYml0L2RhdGEnO1xyXG5pbXBvcnQgQ2FjaGUgZnJvbSAnLi4vY2FjaGUnO1xyXG5pbXBvcnQgeyBJbW11dGFibGVNYXAgfSBmcm9tICdAb3JiaXQvaW1tdXRhYmxlJztcclxuaW1wb3J0IFJlY29yZElkZW50aXR5TWFwIGZyb20gJy4vcmVjb3JkLWlkZW50aXR5LW1hcCc7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSZWxhdGlvbnNoaXBBY2Nlc3NvciB7XHJcbiAgcHJvdGVjdGVkIF9jYWNoZTogQ2FjaGU7XHJcbiAgcHJvdGVjdGVkIF9yZWxhdGlvbnNoaXBzOiBEaWN0PEltbXV0YWJsZU1hcDxzdHJpbmcsIERpY3Q8UmVjb3JkSWRlbnRpdHkgfCBSZWNvcmRJZGVudGl0eU1hcD4+PjtcclxuXHJcbiAgY29uc3RydWN0b3IoY2FjaGU6IENhY2hlLCBiYXNlPzogUmVsYXRpb25zaGlwQWNjZXNzb3IpIHtcclxuICAgIHRoaXMuX2NhY2hlID0gY2FjaGU7XHJcbiAgICB0aGlzLnJlc2V0KGJhc2UpO1xyXG4gIH1cclxuXHJcbiAgcmVzZXQoYmFzZT86IFJlbGF0aW9uc2hpcEFjY2Vzc29yKSB7XHJcbiAgICBsZXQgcmVsYXRpb25zaGlwcyA9IHt9O1xyXG4gICAgT2JqZWN0LmtleXModGhpcy5fY2FjaGUuc2NoZW1hLm1vZGVscykuZm9yRWFjaCh0eXBlID0+IHtcclxuICAgICAgbGV0IGJhc2VSZWxhdGlvbnNoaXBzID0gYmFzZSAmJiBiYXNlLl9yZWxhdGlvbnNoaXBzW3R5cGVdO1xyXG4gICAgICByZWxhdGlvbnNoaXBzW3R5cGVdID0gbmV3IEltbXV0YWJsZU1hcChiYXNlUmVsYXRpb25zaGlwcyk7XHJcbiAgICB9KTtcclxuICAgIHRoaXMuX3JlbGF0aW9uc2hpcHMgPSByZWxhdGlvbnNoaXBzO1xyXG4gIH1cclxuXHJcbiAgcmVsYXRpb25zaGlwRXhpc3RzKHJlY29yZDogUmVjb3JkSWRlbnRpdHksIHJlbGF0aW9uc2hpcDogc3RyaW5nLCByZWxhdGVkUmVjb3JkOiBSZWNvcmRJZGVudGl0eSk6IGJvb2xlYW4ge1xyXG4gICAgbGV0IHJlbHMgPSB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5nZXQocmVjb3JkLmlkKTtcclxuICAgIGlmIChyZWxzKSB7XHJcbiAgICAgIGxldCByZWwgPSByZWxzW3JlbGF0aW9uc2hpcF07XHJcbiAgICAgIGlmIChyZWwpIHtcclxuICAgICAgICBpZiAocmVsIGluc3RhbmNlb2YgUmVjb3JkSWRlbnRpdHlNYXApIHtcclxuICAgICAgICAgIHJldHVybiByZWwuaGFzKHJlbGF0ZWRSZWNvcmQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gZXF1YWxSZWNvcmRJZGVudGl0aWVzKHJlbGF0ZWRSZWNvcmQsIHJlbCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gIXJlbGF0ZWRSZWNvcmQ7XHJcbiAgfVxyXG5cclxuICByZWxhdGVkUmVjb3JkKHJlY29yZDogUmVjb3JkSWRlbnRpdHksIHJlbGF0aW9uc2hpcDogc3RyaW5nKTogUmVjb3JkSWRlbnRpdHkge1xyXG4gICAgbGV0IHJlbHMgPSB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5nZXQocmVjb3JkLmlkKTtcclxuICAgIGlmIChyZWxzKSB7XHJcbiAgICAgIHJldHVybiByZWxzW3JlbGF0aW9uc2hpcF0gYXMgUmVjb3JkSWRlbnRpdHk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZWxhdGVkUmVjb3JkcyhyZWNvcmQ6IFJlY29yZElkZW50aXR5LCByZWxhdGlvbnNoaXA6IHN0cmluZyk6IFJlY29yZElkZW50aXR5W10ge1xyXG4gICAgbGV0IHJlbHMgPSB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5nZXQocmVjb3JkLmlkKTtcclxuICAgIGxldCBtYXAgPSByZWxzICYmIHJlbHNbcmVsYXRpb25zaGlwXSBhcyBSZWNvcmRJZGVudGl0eU1hcDtcclxuICAgIGlmIChtYXApIHtcclxuICAgICAgcmV0dXJuIEFycmF5LmZyb20obWFwLnZhbHVlcyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZWxhdGVkUmVjb3Jkc01hcChyZWNvcmQ6IFJlY29yZElkZW50aXR5LCByZWxhdGlvbnNoaXA6IHN0cmluZyk6IFJlY29yZElkZW50aXR5TWFwIHtcclxuICAgIGxldCByZWxzID0gdGhpcy5fcmVsYXRpb25zaGlwc1tyZWNvcmQudHlwZV0uZ2V0KHJlY29yZC5pZCk7XHJcbiAgICBpZiAocmVscykge1xyXG4gICAgICByZXR1cm4gcmVsc1tyZWxhdGlvbnNoaXBdIGFzIFJlY29yZElkZW50aXR5TWFwO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmVsYXRlZFJlY29yZHNNYXRjaChyZWNvcmQ6IFJlY29yZElkZW50aXR5LCByZWxhdGlvbnNoaXA6IHN0cmluZywgcmVsYXRlZFJlY29yZHM6IFJlY29yZElkZW50aXR5W10pOiBib29sZWFuIHtcclxuICAgIGxldCBtYXAgPSB0aGlzLnJlbGF0ZWRSZWNvcmRzTWFwKHJlY29yZCwgcmVsYXRpb25zaGlwKTtcclxuICAgIGlmIChtYXApIHtcclxuICAgICAgbGV0IG90aGVyTWFwID0gbmV3IFJlY29yZElkZW50aXR5TWFwO1xyXG4gICAgICByZWxhdGVkUmVjb3Jkcy5mb3JFYWNoKGlkID0+IG90aGVyTWFwLmFkZChpZCkpO1xyXG4gICAgICByZXR1cm4gbWFwLmVxdWFscyhvdGhlck1hcCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gcmVsYXRlZFJlY29yZHMubGVuZ3RoID09PSAwO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYWRkUmVjb3JkKHJlY29yZDogUmVjb3JkKSB7XHJcbiAgICBpZiAocmVjb3JkLnJlbGF0aW9uc2hpcHMpIHtcclxuICAgICAgY29uc3QgcmVscyA9IHt9O1xyXG4gICAgICBPYmplY3Qua2V5cyhyZWNvcmQucmVsYXRpb25zaGlwcykuZm9yRWFjaChuYW1lID0+IHtcclxuICAgICAgICBsZXQgcmVsID0gcmVjb3JkLnJlbGF0aW9uc2hpcHNbbmFtZV07XHJcbiAgICAgICAgaWYgKHJlbC5kYXRhICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgIGlmIChpc0FycmF5KHJlbC5kYXRhKSkge1xyXG4gICAgICAgICAgICBsZXQgcmVsTWFwID0gcmVsc1tuYW1lXSA9IG5ldyBSZWNvcmRJZGVudGl0eU1hcCgpO1xyXG4gICAgICAgICAgICAocmVsLmRhdGEgYXMgUmVjb3JkSWRlbnRpdHlbXSkuZm9yRWFjaChyID0+IHJlbE1hcC5hZGQocikpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmVsc1tuYW1lXSA9IHJlbC5kYXRhO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIHRoaXMuX3JlbGF0aW9uc2hpcHNbcmVjb3JkLnR5cGVdLnNldChyZWNvcmQuaWQsIHJlbHMpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmVwbGFjZVJlY29yZChyZWNvcmQ6IFJlY29yZCkge1xyXG4gICAgdGhpcy5hZGRSZWNvcmQocmVjb3JkKTtcclxuICB9XHJcblxyXG4gIGNsZWFyUmVjb3JkKHJlY29yZDogUmVjb3JkSWRlbnRpdHkpOiB2b2lkIHtcclxuICAgIHRoaXMuX3JlbGF0aW9uc2hpcHNbcmVjb3JkLnR5cGVdLnJlbW92ZShyZWNvcmQuaWQpO1xyXG4gIH1cclxuXHJcbiAgYWRkVG9SZWxhdGVkUmVjb3JkcyhyZWNvcmQ6IFJlY29yZElkZW50aXR5LCByZWxhdGlvbnNoaXA6IHN0cmluZywgcmVsYXRlZFJlY29yZDogUmVjb3JkSWRlbnRpdHkpOiB2b2lkIHtcclxuICAgIGxldCBjdXJyZW50UmVscyA9IHRoaXMuX3JlbGF0aW9uc2hpcHNbcmVjb3JkLnR5cGVdLmdldChyZWNvcmQuaWQpO1xyXG4gICAgbGV0IHJlbHMgPSBjdXJyZW50UmVscyA/IGNsb25lUmVsYXRpb25zaGlwcyhjdXJyZW50UmVscykgOiB7fTtcclxuICAgIGxldCByZWwgPSByZWxzW3JlbGF0aW9uc2hpcF07XHJcbiAgICBpZiAoIXJlbCkge1xyXG4gICAgICByZWwgPSByZWxzW3JlbGF0aW9uc2hpcF0gPSBuZXcgUmVjb3JkSWRlbnRpdHlNYXAoKTtcclxuICAgIH1cclxuICAgIHJlbC5hZGQocmVsYXRlZFJlY29yZCk7XHJcbiAgICB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5zZXQocmVjb3JkLmlkLCByZWxzKTtcclxuICB9XHJcblxyXG4gIHJlbW92ZUZyb21SZWxhdGVkUmVjb3JkcyhyZWNvcmQ6IFJlY29yZElkZW50aXR5LCByZWxhdGlvbnNoaXA6IHN0cmluZywgcmVsYXRlZFJlY29yZDogUmVjb3JkSWRlbnRpdHkpOiB2b2lkIHtcclxuICAgIGxldCBjdXJyZW50UmVscyA9IHRoaXMuX3JlbGF0aW9uc2hpcHNbcmVjb3JkLnR5cGVdLmdldChyZWNvcmQuaWQpO1xyXG4gICAgaWYgKGN1cnJlbnRSZWxzICYmIGN1cnJlbnRSZWxzW3JlbGF0aW9uc2hpcF0pIHtcclxuICAgICAgbGV0IHJlbHMgPSBjbG9uZVJlbGF0aW9uc2hpcHMoY3VycmVudFJlbHMpO1xyXG4gICAgICBsZXQgcmVsID0gcmVsc1tyZWxhdGlvbnNoaXBdO1xyXG4gICAgICByZWwucmVtb3ZlKHJlbGF0ZWRSZWNvcmQpO1xyXG4gICAgICB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5zZXQocmVjb3JkLmlkLCByZWxzKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJlcGxhY2VSZWxhdGVkUmVjb3JkcyhyZWNvcmQ6IFJlY29yZElkZW50aXR5LCByZWxhdGlvbnNoaXA6IHN0cmluZywgcmVsYXRlZFJlY29yZHM6IFJlY29yZElkZW50aXR5W10pOiB2b2lkIHtcclxuICAgIGxldCBjdXJyZW50UmVscyA9IHRoaXMuX3JlbGF0aW9uc2hpcHNbcmVjb3JkLnR5cGVdLmdldChyZWNvcmQuaWQpO1xyXG4gICAgbGV0IHJlbHMgPSBjdXJyZW50UmVscyA/IGNsb25lUmVsYXRpb25zaGlwcyhjdXJyZW50UmVscykgOiB7fTtcclxuICAgIGxldCByZWwgPSByZWxzW3JlbGF0aW9uc2hpcF07XHJcbiAgICBpZiAoIXJlbCkge1xyXG4gICAgICByZWwgPSByZWxzW3JlbGF0aW9uc2hpcF0gPSBuZXcgUmVjb3JkSWRlbnRpdHlNYXAoKTtcclxuICAgIH1cclxuICAgIHJlbGF0ZWRSZWNvcmRzLmZvckVhY2gocmVsYXRlZFJlY29yZCA9PiByZWwuYWRkKHJlbGF0ZWRSZWNvcmQpKTtcclxuICAgIHRoaXMuX3JlbGF0aW9uc2hpcHNbcmVjb3JkLnR5cGVdLnNldChyZWNvcmQuaWQsIHJlbHMpO1xyXG4gIH1cclxuXHJcbiAgcmVwbGFjZVJlbGF0ZWRSZWNvcmQocmVjb3JkOiBSZWNvcmRJZGVudGl0eSwgcmVsYXRpb25zaGlwOiBzdHJpbmcsIHJlbGF0ZWRSZWNvcmQ6IFJlY29yZElkZW50aXR5KTogdm9pZCB7XHJcbiAgICBsZXQgY3VycmVudFJlbHMgPSB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5nZXQocmVjb3JkLmlkKTtcclxuICAgIGlmICgoY3VycmVudFJlbHMgJiYgY3VycmVudFJlbHNbcmVsYXRpb25zaGlwXSkgfHwgcmVsYXRlZFJlY29yZCkge1xyXG4gICAgICBsZXQgcmVscyA9IGN1cnJlbnRSZWxzID8gY2xvbmVSZWxhdGlvbnNoaXBzKGN1cnJlbnRSZWxzKSA6IHt9O1xyXG4gICAgICByZWxzW3JlbGF0aW9uc2hpcF0gPSByZWxhdGVkUmVjb3JkO1xyXG4gICAgICB0aGlzLl9yZWxhdGlvbnNoaXBzW3JlY29yZC50eXBlXS5zZXQocmVjb3JkLmlkLCByZWxzKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNsb25lUmVsYXRpb25zaGlwcyhyZWxzKSB7XHJcbiAgY29uc3QgY2xvbmVkUmVscyA9IHt9O1xyXG4gIGlmIChyZWxzKSB7XHJcbiAgICBPYmplY3Qua2V5cyhyZWxzKS5mb3JFYWNoKG5hbWUgPT4ge1xyXG4gICAgICBsZXQgdmFsdWUgPSByZWxzW25hbWVdO1xyXG4gICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBSZWNvcmRJZGVudGl0eU1hcCkge1xyXG4gICAgICAgIGNsb25lZFJlbHNbbmFtZV0gPSBuZXcgUmVjb3JkSWRlbnRpdHlNYXAodmFsdWUgYXMgUmVjb3JkSWRlbnRpdHlNYXApO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNsb25lZFJlbHNbbmFtZV0gPSB2YWx1ZTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHJldHVybiBjbG9uZWRSZWxzO1xyXG59XHJcbiJdfQ==