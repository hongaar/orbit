"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var utils_1 = require("@orbit/utils");
var data_1 = require("@orbit/data");
var EMPTY = function () { };
exports.QueryOperators = {
    findRecord: function (cache, expression) {
        var _a = expression.record, type = _a.type, id = _a.id;
        var record = cache.records(type).get(id);
        if (!record) {
            throw new data_1.RecordNotFoundException(type, id);
        }
        return record;
    },
    findRecords: function (cache, expression) {
        var results = Array.from(cache.records(expression.type).values());
        if (expression.filter) {
            results = filterRecords(results, expression.filter);
        }
        if (expression.sort) {
            results = sortRecords(results, expression.sort);
        }
        if (expression.page) {
            results = paginateRecords(results, expression.page);
        }
        return results;
    },
    findRelatedRecords: function (cache, expression) {
        var record = expression.record, relationship = expression.relationship;
        var type = record.type, id = record.id;
        var currentRecord = cache.records(type).get(id);
        var data = currentRecord && utils_1.deepGet(currentRecord, ['relationships', relationship, 'data']);
        if (!data) {
            return [];
        }
        return data.map(function (r) { return cache.records(r.type).get(r.id); });
    },
    findRelatedRecord: function (cache, expression) {
        var record = expression.record, relationship = expression.relationship;
        var type = record.type, id = record.id;
        var currentRecord = cache.records(type).get(id);
        var data = currentRecord && utils_1.deepGet(currentRecord, ['relationships', relationship, 'data']);
        if (!data) {
            return null;
        }
        var r = data;
        return cache.records(r.type).get(r.id);
    }
};
function filterRecords(records, filters) {
    return records.filter(function (record) {
        for (var i = 0, l = filters.length; i < l; i++) {
            if (!applyFilter(record, filters[i])) {
                return false;
            }
        }
        return true;
    });
}
function applyFilter(record, filter) {
    if (filter.kind === 'attribute') {
        var actual = utils_1.deepGet(record, ['attributes', filter.attribute]);
        var expected = filter.value;
        switch (filter.op) {
            case 'equal': return actual === expected;
            case 'gt': return actual > expected;
            case 'gte': return actual >= expected;
            case 'lt': return actual < expected;
            case 'lte': return actual <= expected;
            default:
                throw new data_1.QueryExpressionParseError('Filter operation ${filter.op} not recognized for Store.', filter);
        }
    }
    return false;
}
function sortRecords(records, sortSpecifiers) {
    var comparisonValues = new Map();
    records.forEach(function (record) {
        comparisonValues.set(record, sortSpecifiers.map(function (sortSpecifier) {
            if (sortSpecifier.kind === 'attribute') {
                return utils_1.deepGet(record, ['attributes', sortSpecifier.attribute]);
            }
            else {
                throw new data_1.QueryExpressionParseError('Sort specifier ${sortSpecifier.kind} not recognized for Store.', sortSpecifier);
            }
        }));
    });
    var comparisonOrders = sortSpecifiers.map(function (sortExpression) { return sortExpression.order === 'descending' ? -1 : 1; });
    return records.sort(function (record1, record2) {
        var values1 = comparisonValues.get(record1);
        var values2 = comparisonValues.get(record2);
        for (var i = 0; i < sortSpecifiers.length; i++) {
            if (values1[i] < values2[i]) {
                return -comparisonOrders[i];
            }
            else if (values1[i] > values2[i]) {
                return comparisonOrders[i];
            }
            else if (utils_1.isNone(values1[i]) && !utils_1.isNone(values2[i])) {
                return comparisonOrders[i];
            }
            else if (utils_1.isNone(values2[i]) && !utils_1.isNone(values1[i])) {
                return -comparisonOrders[i];
            }
        }
        return 0;
    });
}
function paginateRecords(records, paginationOptions) {
    if (paginationOptions.limit !== undefined) {
        var offset = paginationOptions.offset === undefined ? 0 : paginationOptions.offset;
        var limit = paginationOptions.limit;
        return records.slice(offset, offset + limit);
    }
    else {
        throw new data_1.QueryExpressionParseError('Pagination options not recognized for Store. Please specify `offset` and `limit`.', paginationOptions);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnktb3BlcmF0b3JzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NhY2hlL3F1ZXJ5LW9wZXJhdG9ycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUF5RTtBQUN6RSxvQ0FZcUI7QUFHckIsSUFBTSxLQUFLLEdBQUcsY0FBTyxDQUFDLENBQUM7QUFVVixRQUFBLGNBQWMsR0FBd0I7SUFDakQsVUFBVSxZQUFDLEtBQVksRUFBRSxVQUFzQjtRQUN2QyxJQUFBLHNCQUFnQyxFQUE5QixjQUFJLEVBQUUsVUFBRSxDQUF1QjtRQUN2QyxJQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUUzQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDWixNQUFNLElBQUksOEJBQXVCLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQzlDLENBQUM7UUFFRCxNQUFNLENBQUMsTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxXQUFXLFlBQUMsS0FBWSxFQUFFLFVBQXVCO1FBQy9DLElBQUksT0FBTyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUNsRSxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUN0QixPQUFPLEdBQUcsYUFBYSxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDdEQsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLE9BQU8sR0FBRyxXQUFXLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNsRCxDQUFDO1FBQ0Qs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QUMsY0FBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDckQsTUFBTSxDQUFDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDOUIsQ0FBQztRQUNILENBQUM7UUFDRCxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQseUJBQXlCLE9BQU8sRUFBRSxpQkFBaUI7SUFDakQsRUFBRSxDQUFDLENBQUMsaUJBQWlCLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDMUMsSUFBSSxNQUFNLEdBQUcsaUJBQWlCLENBQUMsTUFBTSxLQUFLLFNBQVMsR0FBRyxDQUFDLEdBQUcsaUJBQWlCLENBQUMsTUFBTSxDQUFDO1FBQ25GLElBQUksS0FBSyxHQUFHLGlCQUFpQixDQUFDLEtBQUssQ0FBQztRQUVwQyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsTUFBTSxHQUFHLEtBQUssQ0FBQyxDQUFDO0lBRS9DLENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLE1BQU0sSUFBSSxnQ0FBeUIsQ0FBQyxtRkFBbUYsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO0lBQzlJLENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGljdCwgZGVlcEdldCwgbWVyZ2UsIGV2ZXJ5LCBzb21lLCBpc05vbmUgfSBmcm9tICdAb3JiaXQvdXRpbHMnO1xyXG5pbXBvcnQge1xyXG4gIFF1ZXJ5RXhwcmVzc2lvbixcclxuICBSZWNvcmROb3RGb3VuZEV4Y2VwdGlvbixcclxuICBRdWVyeUV4cHJlc3Npb25QYXJzZUVycm9yLFxyXG4gIEZpbmRSZWNvcmQsXHJcbiAgRmluZFJlY29yZHMsXHJcbiAgRmluZFJlbGF0ZWRSZWNvcmQsXHJcbiAgRmluZFJlbGF0ZWRSZWNvcmRzLFxyXG4gIFNvcnRTcGVjaWZpZXIsXHJcbiAgQXR0cmlidXRlU29ydFNwZWNpZmllcixcclxuICBSZWNvcmQsXHJcbiAgUmVjb3JkSWRlbnRpdHlcclxufSBmcm9tICdAb3JiaXQvZGF0YSc7XHJcbmltcG9ydCBDYWNoZSBmcm9tICcuLi9jYWNoZSc7XHJcblxyXG5jb25zdCBFTVBUWSA9ICgpID0+IHt9O1xyXG5cclxuLyoqXHJcbiAqIEBleHBvcnRcclxuICogQGludGVyZmFjZSBRdWVyeU9wZXJhdG9yXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIFF1ZXJ5T3BlcmF0b3Ige1xyXG4gIChjYWNoZTogQ2FjaGUsIGV4cHJlc3Npb246IFF1ZXJ5RXhwcmVzc2lvbik6IGFueTtcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IFF1ZXJ5T3BlcmF0b3JzOiBEaWN0PFF1ZXJ5T3BlcmF0b3I+ID0ge1xyXG4gIGZpbmRSZWNvcmQoY2FjaGU6IENhY2hlLCBleHByZXNzaW9uOiBGaW5kUmVjb3JkKSB7XHJcbiAgICBjb25zdCB7IHR5cGUsIGlkIH0gPSBleHByZXNzaW9uLnJlY29yZDtcclxuICAgIGNvbnN0IHJlY29yZCA9IGNhY2hlLnJlY29yZHModHlwZSkuZ2V0KGlkKTtcclxuXHJcbiAgICBpZiAoIXJlY29yZCkge1xyXG4gICAgICB0aHJvdyBuZXcgUmVjb3JkTm90Rm91bmRFeGNlcHRpb24odHlwZSwgaWQpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiByZWNvcmQ7XHJcbiAgfSxcclxuXHJcbiAgZmluZFJlY29yZHMoY2FjaGU6IENhY2hlLCBleHByZXNzaW9uOiBGaW5kUmVjb3Jkcykge1xyXG4gICAgbGV0IHJlc3VsdHMgPSBBcnJheS5mcm9tKGNhY2hlLnJlY29yZHMoZXhwcmVzc2lvbi50eXBlKS52YWx1ZXMoKSk7XHJcbiAgICBpZiAoZXhwcmVzc2lvbi5maWx0ZXIpIHtcclxuICAgICAgcmVzdWx0cyA9IGZpbHRlclJlY29yZHMocmVzdWx0cywgZXhwcmVzc2lvbi5maWx0ZXIpO1xyXG4gICAgfVxyXG4gICAgaWYgKGV4cHJlc3Npb24uc29ydCkge1xyXG4gICAgICByZXN1bHRzID0gc29ydFJlY29yZHMocmVzdWx0cywgZXhwcmVzc2lvbi5zb3J0KTtcclxuICAgIH1cclxuICAgIGlmIChleHByZXNzaW9uLnBhZ2UpIHtcclxuICAgICAgcmVzdWx0cyA9IHBhZ2luYXRlUmVjb3JkcyhyZXN1bHRzLCBleHByZXNzaW9uLnBhZ2UpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdHM7XHJcbiAgfSxcclxuXHJcbiAgZmluZFJlbGF0ZWRSZWNvcmRzKGNhY2hlOiBDYWNoZSwgZXhwcmVzc2lvbjogRmluZFJlbGF0ZWRSZWNvcmRzKSB7XHJcbiAgICBjb25zdCB7IHJlY29yZCwgcmVsYXRpb25zaGlwIH0gPSBleHByZXNzaW9uO1xyXG4gICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gcmVjb3JkO1xyXG4gICAgY29uc3QgY3VycmVudFJlY29yZCA9IGNhY2hlLnJlY29yZHModHlwZSkuZ2V0KGlkKTtcclxuICAgIGNvbnN0IGRhdGEgPSBjdXJyZW50UmVjb3JkICYmIGRlZXBHZXQoY3VycmVudFJlY29yZCwgWydyZWxhdGlvbnNoaXBzJywgcmVsYXRpb25zaGlwLCAnZGF0YSddKTtcclxuXHJcbiAgICBpZiAoIWRhdGEpIHsgcmV0dXJuIFtdOyB9XHJcblxyXG4gICAgcmV0dXJuIChkYXRhIGFzIFJlY29yZElkZW50aXR5W10pLm1hcChyID0+IGNhY2hlLnJlY29yZHMoci50eXBlKS5nZXQoci5pZCkpO1xyXG4gIH0sXHJcblxyXG4gIGZpbmRSZWxhdGVkUmVjb3JkKGNhY2hlOiBDYWNoZSwgZXhwcmVzc2lvbjogRmluZFJlbGF0ZWRSZWNvcmQpIHtcclxuICAgIGNvbnN0IHsgcmVjb3JkLCByZWxhdGlvbnNoaXAgfSA9IGV4cHJlc3Npb247XHJcbiAgICBjb25zdCB7IHR5cGUsIGlkIH0gPSByZWNvcmQ7XHJcbiAgICBjb25zdCBjdXJyZW50UmVjb3JkID0gY2FjaGUucmVjb3Jkcyh0eXBlKS5nZXQoaWQpO1xyXG4gICAgY29uc3QgZGF0YSA9IGN1cnJlbnRSZWNvcmQgJiYgZGVlcEdldChjdXJyZW50UmVjb3JkLCBbJ3JlbGF0aW9uc2hpcHMnLCByZWxhdGlvbnNoaXAsICdkYXRhJ10pO1xyXG5cclxuICAgIGlmICghZGF0YSkgeyByZXR1cm4gbnVsbDsgfVxyXG5cclxuICAgIGNvbnN0IHIgPSBkYXRhIGFzIFJlY29yZElkZW50aXR5O1xyXG4gICAgcmV0dXJuIGNhY2hlLnJlY29yZHMoci50eXBlKS5nZXQoci5pZCk7XHJcbiAgfVxyXG59O1xyXG5cclxuZnVuY3Rpb24gZmlsdGVyUmVjb3JkcyhyZWNvcmRzLCBmaWx0ZXJzKSB7XHJcbiAgcmV0dXJuIHJlY29yZHMuZmlsdGVyKHJlY29yZCA9PiB7XHJcbiAgICBmb3IgKGxldCBpID0gMCwgbCA9IGZpbHRlcnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XHJcbiAgICAgIGlmICghYXBwbHlGaWx0ZXIocmVjb3JkLCBmaWx0ZXJzW2ldKSkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGFwcGx5RmlsdGVyKHJlY29yZCwgZmlsdGVyKSB7XHJcbiAgaWYgKGZpbHRlci5raW5kID09PSAnYXR0cmlidXRlJykge1xyXG4gICAgbGV0IGFjdHVhbCA9IGRlZXBHZXQocmVjb3JkLCBbJ2F0dHJpYnV0ZXMnLCBmaWx0ZXIuYXR0cmlidXRlXSk7XHJcbiAgICBsZXQgZXhwZWN0ZWQgPSBmaWx0ZXIudmFsdWU7XHJcbiAgICBzd2l0Y2goZmlsdGVyLm9wKSB7XHJcbiAgICAgIGNhc2UgJ2VxdWFsJzogcmV0dXJuIGFjdHVhbCA9PT0gZXhwZWN0ZWQ7XHJcbiAgICAgIGNhc2UgJ2d0JzogICAgcmV0dXJuIGFjdHVhbCA+IGV4cGVjdGVkO1xyXG4gICAgICBjYXNlICdndGUnOiAgIHJldHVybiBhY3R1YWwgPj0gZXhwZWN0ZWQ7XHJcbiAgICAgIGNhc2UgJ2x0JzogICAgcmV0dXJuIGFjdHVhbCA8IGV4cGVjdGVkO1xyXG4gICAgICBjYXNlICdsdGUnOiAgIHJldHVybiBhY3R1YWwgPD0gZXhwZWN0ZWQ7XHJcbiAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXhwcmVzc2lvblBhcnNlRXJyb3IoJ0ZpbHRlciBvcGVyYXRpb24gJHtmaWx0ZXIub3B9IG5vdCByZWNvZ25pemVkIGZvciBTdG9yZS4nLCBmaWx0ZXIpO1xyXG4gICAgfVxyXG4gIH1cclxuICByZXR1cm4gZmFsc2U7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNvcnRSZWNvcmRzKHJlY29yZHM6IFJlY29yZFtdLCBzb3J0U3BlY2lmaWVyczogU29ydFNwZWNpZmllcltdKSB7XHJcbiAgY29uc3QgY29tcGFyaXNvblZhbHVlcyA9IG5ldyBNYXAoKTtcclxuXHJcbiAgcmVjb3Jkcy5mb3JFYWNoKHJlY29yZCA9PiB7XHJcbiAgICBjb21wYXJpc29uVmFsdWVzLnNldChcclxuICAgICAgcmVjb3JkLFxyXG4gICAgICBzb3J0U3BlY2lmaWVycy5tYXAoc29ydFNwZWNpZmllciA9PiB7XHJcbiAgICAgICAgaWYgKHNvcnRTcGVjaWZpZXIua2luZCA9PT0gJ2F0dHJpYnV0ZScpIHtcclxuICAgICAgICAgIHJldHVybiBkZWVwR2V0KHJlY29yZCwgWydhdHRyaWJ1dGVzJyAsICg8QXR0cmlidXRlU29ydFNwZWNpZmllcj5zb3J0U3BlY2lmaWVyKS5hdHRyaWJ1dGVdKVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgUXVlcnlFeHByZXNzaW9uUGFyc2VFcnJvcignU29ydCBzcGVjaWZpZXIgJHtzb3J0U3BlY2lmaWVyLmtpbmR9IG5vdCByZWNvZ25pemVkIGZvciBTdG9yZS4nLCBzb3J0U3BlY2lmaWVyKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH0pO1xyXG5cclxuICBjb25zdCBjb21wYXJpc29uT3JkZXJzID0gc29ydFNwZWNpZmllcnMubWFwKFxyXG4gICAgc29ydEV4cHJlc3Npb24gPT4gc29ydEV4cHJlc3Npb24ub3JkZXIgPT09ICdkZXNjZW5kaW5nJyA/IC0xIDogMSk7XHJcblxyXG4gIHJldHVybiByZWNvcmRzLnNvcnQoKHJlY29yZDEsIHJlY29yZDIpID0+IHtcclxuICAgIGNvbnN0IHZhbHVlczEgPSBjb21wYXJpc29uVmFsdWVzLmdldChyZWNvcmQxKTtcclxuICAgIGNvbnN0IHZhbHVlczIgPSBjb21wYXJpc29uVmFsdWVzLmdldChyZWNvcmQyKTtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc29ydFNwZWNpZmllcnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgaWYgKHZhbHVlczFbaV0gPCB2YWx1ZXMyW2ldKSB7XHJcbiAgICAgICAgcmV0dXJuIC1jb21wYXJpc29uT3JkZXJzW2ldO1xyXG4gICAgICB9IGVsc2UgaWYgKHZhbHVlczFbaV0gPiB2YWx1ZXMyW2ldKSB7XHJcbiAgICAgICAgcmV0dXJuIGNvbXBhcmlzb25PcmRlcnNbaV07XHJcbiAgICAgIH0gZWxzZSBpZiAoaXNOb25lKHZhbHVlczFbaV0pICYmICFpc05vbmUodmFsdWVzMltpXSkpIHtcclxuICAgICAgICByZXR1cm4gY29tcGFyaXNvbk9yZGVyc1tpXTtcclxuICAgICAgfSBlbHNlIGlmIChpc05vbmUodmFsdWVzMltpXSkgJiYgIWlzTm9uZSh2YWx1ZXMxW2ldKSkge1xyXG4gICAgICAgIHJldHVybiAtY29tcGFyaXNvbk9yZGVyc1tpXTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIDA7XHJcbiAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhZ2luYXRlUmVjb3JkcyhyZWNvcmRzLCBwYWdpbmF0aW9uT3B0aW9ucykge1xyXG4gIGlmIChwYWdpbmF0aW9uT3B0aW9ucy5saW1pdCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICBsZXQgb2Zmc2V0ID0gcGFnaW5hdGlvbk9wdGlvbnMub2Zmc2V0ID09PSB1bmRlZmluZWQgPyAwIDogcGFnaW5hdGlvbk9wdGlvbnMub2Zmc2V0O1xyXG4gICAgbGV0IGxpbWl0ID0gcGFnaW5hdGlvbk9wdGlvbnMubGltaXQ7XHJcblxyXG4gICAgcmV0dXJuIHJlY29yZHMuc2xpY2Uob2Zmc2V0LCBvZmZzZXQgKyBsaW1pdCk7XHJcblxyXG4gIH0gZWxzZSB7XHJcbiAgICB0aHJvdyBuZXcgUXVlcnlFeHByZXNzaW9uUGFyc2VFcnJvcignUGFnaW5hdGlvbiBvcHRpb25zIG5vdCByZWNvZ25pemVkIGZvciBTdG9yZS4gUGxlYXNlIHNwZWNpZnkgYG9mZnNldGAgYW5kIGBsaW1pdGAuJywgcGFnaW5hdGlvbk9wdGlvbnMpO1xyXG4gIH1cclxufVxyXG4iXX0=